{"code":"import * as tslib_1 from \"tslib\";\r\nimport { getModelCollection, getModelId, getModelMetaKey, getModelType, getRefId, modelToJSON, ReferenceType, setModelMetaKey, } from 'datx';\r\nimport { mapItems, META_FIELD } from 'datx-utils';\r\nimport { isObservableArray } from 'mobx';\r\nimport { clearCacheByType } from '../cache';\r\nimport { MODEL_LINKS_FIELD, MODEL_META_FIELD, MODEL_PERSISTED_FIELD, MODEL_PROP_FIELD, MODEL_QUEUE_FIELD, MODEL_REF_LINKS_FIELD, MODEL_REF_META_FIELD, MODEL_RELATED_FIELD, } from '../consts';\r\nimport { config, create, fetchLink, handleResponse, remove, update } from '../NetworkUtils';\r\nimport { getValue } from './utils';\r\nexport function flattenModel(data) {\r\n    if (!data) {\r\n        return null;\r\n    }\r\n    var rawData = (_a = {},\r\n        _a[META_FIELD] = (_b = {\r\n                fields: Object.keys(data.attributes),\r\n                id: data.id\r\n            },\r\n            _b[MODEL_LINKS_FIELD] = data.links,\r\n            _b[MODEL_META_FIELD] = data.meta,\r\n            _b[MODEL_PERSISTED_FIELD] = Boolean(data.id),\r\n            _b.refs = {},\r\n            _b.type = data.type,\r\n            _b),\r\n        _a);\r\n    if (data.relationships) {\r\n        var refLinks_1 = {};\r\n        var refMeta_1 = {};\r\n        var refs_1 = {};\r\n        Object.keys(data.relationships).forEach(function (key) {\r\n            var ref = data.relationships[key];\r\n            if ('data' in ref && ref.data && (!(ref.data instanceof Array) || ref.data.length > 0)) {\r\n                rawData[key] = mapItems(ref.data, function (item) { return item.id; });\r\n                refs_1[key] = {\r\n                    model: ref.data instanceof Array ? ref.data[0].type : ref.data.type,\r\n                    type: ref.data instanceof Array ? ReferenceType.TO_MANY : ReferenceType.TO_ONE,\r\n                };\r\n            }\r\n            if ('links' in ref) {\r\n                refLinks_1[key] = ref.links;\r\n            }\r\n            if ('meta' in ref) {\r\n                refMeta_1[key] = ref.meta;\r\n            }\r\n        });\r\n        rawData[META_FIELD].refs = refs_1;\r\n        rawData[META_FIELD][MODEL_REF_LINKS_FIELD] = refLinks_1;\r\n        rawData[META_FIELD][MODEL_REF_META_FIELD] = refMeta_1;\r\n    }\r\n    return Object.assign(rawData, data.attributes);\r\n    var _a, _b;\r\n}\r\nexport function getModelMeta(model) {\r\n    return getModelMetaKey(model, MODEL_META_FIELD);\r\n}\r\nexport function getModelLinks(model) {\r\n    return getModelMetaKey(model, MODEL_LINKS_FIELD);\r\n}\r\nexport function fetchModelLink(model, key, requestHeaders, options) {\r\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n        var collection, links, link, responseObj;\r\n        return tslib_1.__generator(this, function (_a) {\r\n            collection = getModelCollection(model);\r\n            links = getModelLinks(model);\r\n            if (!(key in links)) {\r\n                throw new Error(\"Link \" + key + \" doesn't exist on the model\");\r\n            }\r\n            link = links[key];\r\n            responseObj = fetchLink(link, collection, requestHeaders, options);\r\n            if (getModelMetaKey(model, MODEL_QUEUE_FIELD)) {\r\n                return [2 /*return*/, responseObj.then(function (response) {\r\n                        var related = getModelMetaKey(model, MODEL_RELATED_FIELD);\r\n                        var prop = getModelMetaKey(model, MODEL_PROP_FIELD);\r\n                        var record = response.data;\r\n                        var recordType = record && getModelType(record);\r\n                        if (record && recordType !== getModelType(model) && recordType === getModelType(related)) {\r\n                            if (prop) {\r\n                                related[prop] = record;\r\n                                return response;\r\n                            }\r\n                            setModelMetaKey(related, MODEL_PERSISTED_FIELD, true);\r\n                            return response.replaceData(related);\r\n                        }\r\n                        return response;\r\n                    })];\r\n            }\r\n            return [2 /*return*/, responseObj];\r\n        });\r\n    });\r\n}\r\nfunction getLink(model, ref, key) {\r\n    var collection = getModelCollection(model);\r\n    if (!collection) {\r\n        throw new Error('The model needs to be in a collection');\r\n    }\r\n    var links = getModelRefLinks(model);\r\n    if (!(ref in links)) {\r\n        throw new Error(\"The reference \" + ref + \" doesn't have any links\");\r\n    }\r\n    var refLinks = links[ref];\r\n    if (!(key in refLinks)) {\r\n        throw new Error(\"Link \" + key + \" doesn't exist on the model\");\r\n    }\r\n    return refLinks[key];\r\n}\r\nexport function fetchModelRefLink(model, ref, key, requestHeaders, options) {\r\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n        var collection, link;\r\n        return tslib_1.__generator(this, function (_a) {\r\n            collection = getModelCollection(model);\r\n            link = getLink(model, ref, key);\r\n            return [2 /*return*/, fetchLink(link, collection, requestHeaders, options)];\r\n        });\r\n    });\r\n}\r\nexport function getModelRefLinks(model) {\r\n    return getModelMetaKey(model, MODEL_REF_LINKS_FIELD);\r\n}\r\nexport function getModelRefMeta(model) {\r\n    return getModelMetaKey(model, MODEL_REF_META_FIELD);\r\n}\r\nfunction isModelPersisted(model) {\r\n    return getModelMetaKey(model, MODEL_PERSISTED_FIELD);\r\n}\r\nfunction setModelPersisted(model, status) {\r\n    setModelMetaKey(model, MODEL_PERSISTED_FIELD, status);\r\n}\r\nexport function modelToJsonApi(model) {\r\n    var staticModel = model.constructor;\r\n    var attributes = modelToJSON(model);\r\n    var useAutogenerated = staticModel['useAutogeneratedIds'];\r\n    var isPersisted = isModelPersisted(model);\r\n    var data = {\r\n        attributes: attributes,\r\n        id: (isPersisted || useAutogenerated) ? getModelId(model) : undefined,\r\n        type: getModelType(model),\r\n    };\r\n    var refs = getModelMetaKey(model, 'refs');\r\n    Object.keys(refs).forEach(function (key) {\r\n        data.relationships = data.relationships || {};\r\n        var refIds = getRefId(model, key);\r\n        var rel;\r\n        if (refIds instanceof Array || isObservableArray(refIds)) {\r\n            rel = refIds.map(function (id, index) {\r\n                var type = model[key][index] ? getModelType(model[key][index]) : refs[key].model;\r\n                return { id: id, type: type };\r\n            });\r\n        }\r\n        else {\r\n            var type = model[key] ? getModelType(model[key]) : refs[key].model;\r\n            rel = refIds ? { id: refIds, type: type } : undefined;\r\n        }\r\n        data.relationships[key] = { data: rel };\r\n        delete data.attributes[key];\r\n    });\r\n    delete data.attributes.id;\r\n    delete data.attributes[META_FIELD];\r\n    return data;\r\n}\r\nfunction getModelEndpointUrl(model) {\r\n    var staticModel = model.constructor;\r\n    var links = getModelLinks(model);\r\n    if (links && links.self) {\r\n        var self = links.self;\r\n        return typeof self === 'string' ? self : self.href;\r\n    }\r\n    var url = getValue(staticModel['endpoint']) || getModelType(model);\r\n    return isModelPersisted(model)\r\n        ? \"\" + config.baseUrl + url + \"/\" + getModelId(model)\r\n        : \"\" + config.baseUrl + url;\r\n}\r\nexport function saveModel(model, options) {\r\n    var collection = getModelCollection(model);\r\n    var data = modelToJsonApi(model);\r\n    var requestMethod = isModelPersisted(model) ? update : create;\r\n    var url = getModelEndpointUrl(model);\r\n    return requestMethod(url, { data: data }, collection, options && options.headers)\r\n        .then(handleResponse(model))\r\n        .then(function (response) {\r\n        clearCacheByType(getModelType(model));\r\n        return response;\r\n    });\r\n}\r\nexport function removeModel(model, options) {\r\n    var collection = getModelCollection(model);\r\n    var isPersisted = isModelPersisted(model);\r\n    var url = getModelEndpointUrl(model);\r\n    if (isPersisted) {\r\n        return remove(url, collection, options && options.headers)\r\n            .then(function (response) {\r\n            if (response.error) {\r\n                throw response.error;\r\n            }\r\n            setModelPersisted(model, false);\r\n            if (collection) {\r\n                collection.remove(model);\r\n            }\r\n        });\r\n    }\r\n    else if (collection) {\r\n        collection.remove(model);\r\n    }\r\n    return Promise.resolve();\r\n}\r\nexport function saveRelationship(model, ref, options) {\r\n    var collection = getModelCollection(model);\r\n    var link = getLink(model, ref, 'self');\r\n    var href = typeof link === 'object' ? link.href : link;\r\n    var ids = getRefId(model, ref);\r\n    var type = getModelType(getModelMetaKey(model, 'refs')[ref].model);\r\n    var data = mapItems(ids, function (id) { return ({ id: id, type: type }); });\r\n    return update(href, { data: data }, collection, options && options.headers)\r\n        .then(handleResponse(model, ref));\r\n}\r\n//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kZWwuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaGVscGVycy9tb2RlbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLGtCQUFrQixFQUNsQixVQUFVLEVBQ1YsZUFBZSxFQUNmLFlBQVksRUFDWixRQUFRLEVBRVIsV0FBVyxFQUVYLGFBQWEsRUFDYixlQUFlLEdBQ2hCLE1BQU0sTUFBTSxDQUFDO0FBQ2QsT0FBTyxFQUF5QixRQUFRLEVBQUUsVUFBVSxFQUFDLE1BQU0sWUFBWSxDQUFDO0FBQ3hFLE9BQU8sRUFBQyxpQkFBaUIsRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUV2QyxPQUFPLEVBQUMsZ0JBQWdCLEVBQUMsTUFBTSxVQUFVLENBQUM7QUFDMUMsT0FBTyxFQUNMLGlCQUFpQixFQUNqQixnQkFBZ0IsRUFDaEIscUJBQXFCLEVBQ3JCLGdCQUFnQixFQUNoQixpQkFBaUIsRUFDakIscUJBQXFCLEVBQ3JCLG9CQUFvQixFQUNwQixtQkFBbUIsR0FDcEIsTUFBTSxXQUFXLENBQUM7QUFLbkIsT0FBTyxFQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLGNBQWMsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFDLE1BQU0saUJBQWlCLENBQUM7QUFFMUYsT0FBTyxFQUFDLFFBQVEsRUFBQyxNQUFNLFNBQVMsQ0FBQztBQUlqQyxNQUFNLHVCQUF1QixJQUFjO0lBQ3pDLElBQUksQ0FBQyxJQUFJLEVBQUU7UUFDVCxPQUFPLElBQUksQ0FBQztLQUNiO0lBRUQsSUFBTSxPQUFPO1FBQ1gsR0FBQyxVQUFVO2dCQUNULE1BQU0sRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUM7Z0JBQ3BDLEVBQUUsRUFBRSxJQUFJLENBQUMsRUFBRTs7WUFDWCxHQUFDLGlCQUFpQixJQUFHLElBQUksQ0FBQyxLQUFLO1lBQy9CLEdBQUMsZ0JBQWdCLElBQUcsSUFBSSxDQUFDLElBQUk7WUFD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TUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUM7SUFFckUsSUFBTSxJQUFJLEdBQU8sUUFBUSxDQUFDLEdBQUcsRUFBRSxVQUFDLEVBQUUsSUFBSyxPQUFBLENBQUMsRUFBQyxFQUFFLElBQUEsRUFBRSxJQUFJLE1BQUEsRUFBQyxDQUFDLEVBQVosQ0FBWSxDQUFPLENBQUM7SUFFM0QsT0FBTyxNQUFNLENBQUMsSUFBSSxFQUFFLEVBQUMsSUFBSSxNQUFBLEVBQUMsRUFBRSxVQUFVLEVBQUUsT0FBTyxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUM7U0FDaEUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztBQUN0QyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgZ2V0TW9kZWxDb2xsZWN0aW9uLFxuICBnZXRNb2RlbElkLFxuICBnZXRNb2RlbE1ldGFLZXksXG4gIGdldE1vZGVsVHlwZSxcbiAgZ2V0UmVmSWQsXG4gIElJZGVudGlmaWVyLFxuICBtb2RlbFRvSlNPTixcbiAgUHVyZU1vZGVsLFxuICBSZWZlcmVuY2VUeXBlLFxuICBzZXRNb2RlbE1ldGFLZXksXG59IGZyb20gJ2RhdHgnO1xuaW1wb3J0IHtJRGljdGlvbmFyeSwgSVJhd01vZGVsLCBtYXBJdGVtcywgTUVUQV9GSUVMRH0gZnJvbSAnZGF0eC11dGlscyc7XG5pbXBvcnQge2lzT2JzZXJ2YWJsZUFycmF5fSBmcm9tICdtb2J4JztcblxuaW1wb3J0IHtjbGVhckNhY2hlQnlUeXBlfSBmcm9tICcuLi9jYWNoZSc7XG5pbXBvcnQge1xuICBNT0RFTF9MSU5LU19GSUVMRCxcbiAgTU9ERUxfTUVUQV9GSUVMRCxcbiAgTU9ERUxfUEVSU0lTVEVEX0ZJRUxELFxuICBNT0RFTF9QUk9QX0ZJRUxELFxuICBNT0RFTF9RVUVVRV9GSUVMRCxcbiAgTU9ERUxfUkVGX0xJTktTX0ZJRUxELFxuICBNT0RFTF9SRUZfTUVUQV9GSUVMRCxcbiAgTU9ERUxfUkVMQVRFRF9GSUVMRCxcbn0gZnJvbSAnLi4vY29uc3RzJztcbmltcG9ydCB7SUpzb25hcGlDb2xsZWN0aW9ufSBmcm9tICcuLi9pbnRlcmZhY2VzL0lKc29uYXBpQ29sbGVjdGlvbic7XG5pbXBvcnQge0lKc29uYXBpTW9kZWx9IGZyb20gJy4uL2ludGVyZmFjZXMvSUpzb25hcGlNb2RlbCc7XG5pbXBvcnQge0lSZXF1ZXN0T3B0aW9uc30gZnJvbSAnLi4vaW50ZXJmYWNlcy9JUmVxdWVzdE9wdGlvbnMnO1xuaW1wb3J0IHtJRGVmaW5pdGlvbiwgSUxpbmssIElSZWNvcmQsIElSZWxhdGlvbnNoaXB9IGZyb20gJy4uL2ludGVyZmFjZXMvSnNvbkFwaSc7XG5pbXBvcnQge2NvbmZpZywgY3JlYXRlLCBmZXRjaExpbmssIGhhbmRsZVJlc3BvbnNlLCByZW1vdmUsIHVwZGF0ZX0gZnJvbSAnLi4vTmV0d29ya1V0aWxzJztcbmltcG9ydCB7UmVzcG9uc2V9IGZyb20gJy4uL1Jlc3BvbnNlJztcbmltcG9ydCB7Z2V0VmFsdWV9IGZyb20gJy4vdXRpbHMnO1xuXG5leHBvcnQgZnVuY3Rpb24gZmxhdHRlbk1vZGVsKCk6IG51bGw7XG5leHBvcnQgZnVuY3Rpb24gZmxhdHRlbk1vZGVsKGRhdGE/OiBJUmVjb3JkKTogSVJhd01vZGVsO1xuZXhwb3J0IGZ1bmN0aW9uIGZsYXR0ZW5Nb2RlbChkYXRhPzogSVJlY29yZCk6IElSYXdNb2RlbHxudWxsIHtcbiAgaWYgKCFkYXRhKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBjb25zdCByYXdEYXRhID0ge1xuICAgIFtNRVRBX0ZJRUxEXToge1xuICAgICAgZmllbGRzOiBPYmplY3Qua2V5cyhkYXRhLmF0dHJpYnV0ZXMpLFxuICAgICAgaWQ6IGRhdGEuaWQsXG4gICAgICBbTU9ERUxfTElOS1NfRklFTERdOiBkYXRhLmxpbmtzLFxuICAgICAgW01PREVMX01FVEFfRklFTERdOiBkYXRhLm1ldGEsXG4gICAgICBbTU9ERUxfUEVSU0lTVEVEX0ZJRUxEXTogQm9vbGVhbihkYXRhLmlkKSxcbiAgICAgIHJlZnM6IHt9LFxuICAgICAgdHlwZTogZGF0YS50eXBlLFxuICAgIH0sXG4gIH07XG5cbiAgaWYgKGRhdGEucmVsYXRpb25zaGlwcykge1xuICAgIGNvbnN0IHJlZkxpbmtzID0ge307XG4gICAgY29uc3QgcmVmTWV0YSA9IHt9O1xuICAgIGNvbnN0IHJlZnMgPSB7fTtcbiAgICBPYmplY3Qua2V5cyhkYXRhLnJlbGF0aW9uc2hpcHMpLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgY29uc3QgcmVmID0gKGRhdGEucmVsYXRpb25zaGlwcyBhcyBJRGljdGlvbmFyeTxJUmVsYXRpb25zaGlwPilba2V5XTtcbiAgICAgIGlmICgnZGF0YScgaW4gcmVmICYmIHJlZi5kYXRhICYmICghKHJlZi5kYXRhIGluc3RhbmNlb2YgQXJyYXkpIHx8IHJlZi5kYXRhLmxlbmd0aCA+IDApKSB7XG4gICAgICAgIHJhd0RhdGFba2V5XSA9IG1hcEl0ZW1zKHJlZi5kYXRhLCAoaXRlbTogSURlZmluaXRpb24pID0+IGl0ZW0uaWQpO1xuICAgICAgICByZWZzW2tleV0gPSB7XG4gICAgICAgICAgbW9kZWw6IHJlZi5kYXRhIGluc3RhbmNlb2YgQXJyYXkgPyByZWYuZGF0YVswXS50eXBlIDogcmVmLmRhdGEudHlwZSxcbiAgICAgICAgICB0eXBlOiByZWYuZGF0YSBpbnN0YW5jZW9mIEFycmF5ID8gUmVmZXJlbmNlVHlwZS5UT19NQU5ZIDogUmVmZXJlbmNlVHlwZS5UT19PTkUsXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgICBpZiAoJ2xpbmtzJyBpbiByZWYpIHtcbiAgICAgICAgcmVmTGlua3Nba2V5XSA9IHJlZi5saW5rcztcbiAgICAgIH1cbiAgICAgIGlmICgnbWV0YScgaW4gcmVmKSB7XG4gICAgICAgIHJlZk1ldGFba2V5XSA9IHJlZi5tZXRhO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmF3RGF0YVtNRVRBX0ZJRUxEXS5yZWZzID0gcmVmcztcbiAgICByYXdEYXRhW01FVEFfRklFTERdW01PREVMX1JFRl9MSU5LU19GSUVMRF0gPSByZWZMaW5rcztcbiAgICByYXdEYXRhW01FVEFfRklFTERdW01PREVMX1JFRl9NRVRBX0ZJRUxEXSA9IHJlZk1ldGE7XG4gIH1cblxuICByZXR1cm4gT2JqZWN0LmFzc2lnbihyYXdEYXRhLCBkYXRhLmF0dHJpYnV0ZXMpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0TW9kZWxNZXRhKG1vZGVsOiBQdXJlTW9kZWwpOiBJRGljdGlvbmFyeSB7XG4gIHJldHVybiBnZXRNb2RlbE1ldGFLZXkobW9kZWwsIE1PREVMX01FVEFfRklFTEQpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0TW9kZWxMaW5rcyhtb2RlbDogUHVyZU1vZGVsKTogSURpY3Rpb25hcnk8SUxpbms+IHtcbiAgcmV0dXJuIGdldE1vZGVsTWV0YUtleShtb2RlbCwgTU9ERUxfTElOS1NfRklFTEQpO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZmV0Y2hNb2RlbExpbms8VCBleHRlbmRzIElKc29uYXBpTW9kZWwgPSBJSnNvbmFwaU1vZGVsPihcbiAgbW9kZWw6IFB1cmVNb2RlbCxcbiAga2V5OiBzdHJpbmcsXG4gIHJlcXVlc3RIZWFkZXJzPzogSURpY3Rpb25hcnk8c3RyaW5nPixcbiAgb3B0aW9ucz86IElSZXF1ZXN0T3B0aW9ucyxcbik6IFByb21pc2U8UmVzcG9uc2U8VD4+IHtcbiAgY29uc3QgY29sbGVjdGlvbiA9IGdldE1vZGVsQ29sbGVjdGlvbihtb2RlbCk7XG4gIGNvbnN0IGxpbmtzID0gZ2V0TW9kZWxMaW5rcyhtb2RlbCk7XG4gIGlmICghKGtleSBpbiBsaW5rcykpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYExpbmsgJHtrZXl9IGRvZXNuJ3QgZXhpc3Qgb24gdGhlIG1vZGVsYCk7XG4gIH1cbiAgY29uc3QgbGluayA9IGxpbmtzW2tleV07XG4gIGNvbnN0IHJlc3BvbnNlT2JqID0gZmV0Y2hMaW5rPFQ+KGxpbmssIGNvbGxlY3Rpb24gYXMgSUpzb25hcGlDb2xsZWN0aW9uLCByZXF1ZXN0SGVhZGVycywgb3B0aW9ucyk7XG5cbiAgaWYgKGdldE1vZGVsTWV0YUtleShtb2RlbCwgTU9ERUxfUVVFVUVfRklFTEQpKSB7XG4gICAgcmV0dXJuIHJlc3BvbnNlT2JqLnRoZW4oKHJlc3BvbnNlKSA9PiB7XG4gICAgICBjb25zdCByZWxhdGVkID0gZ2V0TW9kZWxNZXRhS2V5KG1vZGVsLCBNT0RFTF9SRUxBVEVEX0ZJRUxEKTtcbiAgICAgIGNvbnN0IHByb3AgPSBnZXRNb2RlbE1ldGFLZXkobW9kZWwsIE1PREVMX1BST1BfRklFTEQpO1xuICAgICAgY29uc3QgcmVjb3JkID0gcmVzcG9uc2UuZGF0YTtcbiAgICAgIGNvbnN0IHJlY29yZFR5cGUgPSByZWNvcmQgJiYgZ2V0TW9kZWxUeXBlKHJlY29yZCk7XG4gICAgICBpZiAocmVjb3JkICYmIHJlY29yZFR5cGUgIT09IGdldE1vZGVsVHlwZShtb2RlbCkgJiYgcmVjb3JkVHlwZSA9PT0gZ2V0TW9kZWxUeXBlKHJlbGF0ZWQpKSB7XG4gICAgICAgIGlmIChwcm9wKSB7XG4gICAgICAgICAgcmVsYXRlZFtwcm9wXSA9IHJlY29yZDtcblxuICAgICAgICAgIHJldHVybiByZXNwb25zZTtcbiAgICAgICAgfVxuICAgICAgICBzZXRNb2RlbE1ldGFLZXkocmVsYXRlZCwgTU9ERUxfUEVSU0lTVEVEX0ZJRUxELCB0cnVlKTtcblxuICAgICAgICByZXR1cm4gcmVzcG9uc2UucmVwbGFjZURhdGEocmVsYXRlZCk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZXNwb25zZTtcbiAgICB9KTtcbiAgfVxuXG4gIHJldHVybiByZXNwb25zZU9iajtcbn1cblxuZnVuY3Rpb24gZ2V0TGluayhtb2RlbDogUHVyZU1vZGVsLCByZWY6IHN0cmluZywga2V5OiBzdHJpbmcpIHtcbiAgY29uc3QgY29sbGVjdGlvbiA9IGdldE1vZGVsQ29sbGVjdGlvbihtb2RlbCk7XG4gIGlmICghY29sbGVjdGlvbikge1xuICAgIHRocm93IG5ldyBFcnJvcignVGhlIG1vZGVsIG5lZWRzIHRvIGJlIGluIGEgY29sbGVjdGlvbicpO1xuICB9XG4gIGNvbnN0IGxpbmtzID0gZ2V0TW9kZWxSZWZMaW5rcyhtb2RlbCk7XG4gIGlmICghKHJlZiBpbiBsaW5rcykpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSByZWZlcmVuY2UgJHtyZWZ9IGRvZXNuJ3QgaGF2ZSBhbnkgbGlua3NgKTtcbiAgfVxuICBjb25zdCByZWZMaW5rcyA9IGxpbmtzW3JlZl07XG4gIGlmICghKGtleSBpbiByZWZMaW5rcykpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYExpbmsgJHtrZXl9IGRvZXNuJ3QgZXhpc3Qgb24gdGhlIG1vZGVsYCk7XG4gIH1cblxuICByZXR1cm4gcmVmTGlua3Nba2V5XTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGZldGNoTW9kZWxSZWZMaW5rPFQgZXh0ZW5kcyBJSnNvbmFwaU1vZGVsID0gSUpzb25hcGlNb2RlbD4oXG4gIG1vZGVsOiBQdXJlTW9kZWwsXG4gIHJlZjogc3RyaW5nLFxuICBrZXk6IHN0cmluZyxcbiAgcmVxdWVzdEhlYWRlcnM/OiBJRGljdGlvbmFyeTxzdHJpbmc+LFxuICBvcHRpb25zPzogSVJlcXVlc3RPcHRpb25zLFxuKTogUHJvbWlzZTxSZXNwb25zZTxUPj4ge1xuICBjb25zdCBjb2xsZWN0aW9uID0gZ2V0TW9kZWxDb2xsZWN0aW9uKG1vZGVsKTtcbiAgY29uc3QgbGluayA9IGdldExpbmsobW9kZWwsIHJlZiwga2V5KTtcblxuICByZXR1cm4gZmV0Y2hMaW5rPFQ+KGxpbmssIGNvbGxlY3Rpb24gYXMgSUpzb25hcGlDb2xsZWN0aW9uLCByZXF1ZXN0SGVhZGVycywgb3B0aW9ucyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRNb2RlbFJlZkxpbmtzKG1vZGVsOiBQdXJlTW9kZWwpOiBJRGljdGlvbmFyeTxJRGljdGlvbmFyeTxJTGluaz4+IHtcbiAgcmV0dXJuIGdldE1vZGVsTWV0YUtleShtb2RlbCwgTU9ERUxfUkVGX0xJTktTX0ZJRUxEKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldE1vZGVsUmVmTWV0YShtb2RlbDogUHVyZU1vZGVsKTogSURpY3Rpb25hcnkge1xuICByZXR1cm4gZ2V0TW9kZWxNZXRhS2V5KG1vZGVsLCBNT0RFTF9SRUZfTUVUQV9GSUVMRCk7XG59XG5cbmZ1bmN0aW9uIGlzTW9kZWxQZXJzaXN0ZWQobW9kZWw6IFB1cmVNb2RlbCk6IGJvb2xlYW4ge1xuICByZXR1cm4gZ2V0TW9kZWxNZXRhS2V5KG1vZGVsLCBNT0RFTF9QRVJTSVNURURfRklFTEQpO1xufVxuXG5mdW5jdGlvbiBzZXRNb2RlbFBlcnNpc3RlZChtb2RlbDogUHVyZU1vZGVsLCBzdGF0dXM6IGJvb2xlYW4pIHtcbiAgc2V0TW9kZWxNZXRhS2V5KG1vZGVsLCBNT0RFTF9QRVJTSVNURURfRklFTEQsIHN0YXR1cyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtb2RlbFRvSnNvbkFwaShtb2RlbDogSUpzb25hcGlNb2RlbCk6IElSZWNvcmQge1xuICBjb25zdCBzdGF0aWNNb2RlbCA9IG1vZGVsLmNvbnN0cnVjdG9yIGFzIHR5cGVvZiBQdXJlTW9kZWw7XG4gIGNvbnN0IGF0dHJpYnV0ZXM6IElEaWN0aW9uYXJ5ID0gbW9kZWxUb0pTT04obW9kZWwpO1xuXG4gIGNvbnN0IHVzZUF1dG9nZW5lcmF0ZWQ6IGJvb2xlYW4gPSBzdGF0aWNNb2RlbFsndXNlQXV0b2dlbmVyYXRlZElkcyddO1xuICBjb25zdCBpc1BlcnNpc3RlZCA9IGlzTW9kZWxQZXJzaXN0ZWQobW9kZWwpO1xuXG4gIGNvbnN0IGRhdGE6IElSZWNvcmQgPSB7XG4gICAgYXR0cmlidXRlcyxcbiAgICBpZDogKGlzUGVyc2lzdGVkIHx8IHVzZUF1dG9nZW5lcmF0ZWQpID8gZ2V0TW9kZWxJZChtb2RlbCkgOiB1bmRlZmluZWQsXG4gICAgdHlwZTogZ2V0TW9kZWxUeXBlKG1vZGVsKSBhcyBzdHJpbmcsXG4gIH07XG5cbiAgY29uc3QgcmVmcyA9IGdldE1vZGVsTWV0YUtleShtb2RlbCwgJ3JlZnMnKTtcblxuICBPYmplY3Qua2V5cyhyZWZzKS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICBkYXRhLnJlbGF0aW9uc2hpcHMgPSBkYXRhLnJlbGF0aW9uc2hpcHMgfHwge307XG4gICAgY29uc3QgcmVmSWRzID0gZ2V0UmVmSWQobW9kZWwsIGtleSk7XG4gICAgbGV0IHJlbDogSURlZmluaXRpb258QXJyYXk8SURlZmluaXRpb24+fHVuZGVmaW5lZDtcbiAgICBpZiAocmVmSWRzIGluc3RhbmNlb2YgQXJyYXkgfHwgaXNPYnNlcnZhYmxlQXJyYXkocmVmSWRzKSkge1xuICAgICAgcmVsID0gKHJlZklkcyBhcyBBcnJheTxJSWRlbnRpZmllcj4pLm1hcCgoaWQsIGluZGV4KSA9PiB7XG4gICAgICAgIGNvbnN0IHR5cGUgPSBtb2RlbFtrZXldW2luZGV4XSA/IGdldE1vZGVsVHlwZShtb2RlbFtrZXldW2luZGV4XSkgOiByZWZzW2tleV0ubW9kZWw7XG5cbiAgICAgICAgcmV0dXJuIHtpZCwgdHlwZX07XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgdHlwZTogc3RyaW5nID0gbW9kZWxba2V5XSA/IGdldE1vZGVsVHlwZShtb2RlbFtrZXldKSA6IHJlZnNba2V5XS5tb2RlbDtcbiAgICAgIHJlbCA9IHJlZklkcyA/IHtpZDogcmVmSWRzLCB0eXBlfSA6IHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICBkYXRhLnJlbGF0aW9uc2hpcHNba2V5XSA9IHtkYXRhOiByZWx9O1xuICAgIGRlbGV0ZSBkYXRhLmF0dHJpYnV0ZXNba2V5XTtcbiAgfSk7XG5cbiAgZGVsZXRlIGRhdGEuYXR0cmlidXRlcy5pZDtcblxuICBkZWxldGUgZGF0YS5hdHRyaWJ1dGVzW01FVEFfRklFTERdO1xuXG4gIHJldHVybiBkYXRhO1xufVxuXG5mdW5jdGlvbiBnZXRNb2RlbEVuZHBvaW50VXJsKG1vZGVsOiBQdXJlTW9kZWwpOiBzdHJpbmcge1xuICBjb25zdCBzdGF0aWNNb2RlbCA9IG1vZGVsLmNvbnN0cnVjdG9yO1xuICBjb25zdCBsaW5rczogSURpY3Rpb25hcnk8SUxpbms+ID0gZ2V0TW9kZWxMaW5rcyhtb2RlbCk7XG4gIGlmIChsaW5rcyAmJiBsaW5rcy5zZWxmKSB7XG4gICAgY29uc3Qgc2VsZjogSUxpbmsgPSBsaW5rcy5zZWxmO1xuXG4gICAgcmV0dXJuIHR5cGVvZiBzZWxmID09PSAnc3RyaW5nJyA/IHNlbGYgOiBzZWxmLmhyZWY7XG4gIH1cblxuICBjb25zdCB1cmwgPSBnZXRWYWx1ZTxzdHJpbmc+KHN0YXRpY01vZGVsWydlbmRwb2ludCddKSB8fCBnZXRNb2RlbFR5cGUobW9kZWwpO1xuXG4gIHJldHVybiBpc01vZGVsUGVyc2lzdGVkKG1vZGVsKVxuICAgID8gYCR7Y29uZmlnLmJhc2VVcmx9JHt1cmx9LyR7Z2V0TW9kZWxJZChtb2RlbCl9YFxuICAgIDogYCR7Y29uZmlnLmJhc2VVcmx9JHt1cmx9YDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNhdmVNb2RlbChtb2RlbDogSUpzb25hcGlNb2RlbCwgb3B0aW9ucz86IElSZXF1ZXN0T3B0aW9ucyk6IFByb21pc2U8SUpzb25hcGlNb2RlbD4ge1xuICBjb25zdCBjb2xsZWN0aW9uID0gZ2V0TW9kZWxDb2xsZWN0aW9uKG1vZGVsKSBhcyBJSnNvbmFwaUNvbGxlY3Rpb247XG5cbiAgY29uc3QgZGF0YTogSVJlY29yZCA9IG1vZGVsVG9Kc29uQXBpKG1vZGVsKTtcbiAgY29uc3QgcmVxdWVzdE1ldGhvZCA9IGlzTW9kZWxQZXJzaXN0ZWQobW9kZWwpID8gdXBkYXRlIDogY3JlYXRlO1xuICBjb25zdCB1cmwgPSBnZXRNb2RlbEVuZHBvaW50VXJsKG1vZGVsKTtcblxuICByZXR1cm4gcmVxdWVzdE1ldGhvZCh1cmwsIHtkYXRhfSwgY29sbGVjdGlvbiwgb3B0aW9ucyAmJiBvcHRpb25zLmhlYWRlcnMpXG4gICAgLnRoZW4oaGFuZGxlUmVzcG9uc2UobW9kZWwpKVxuICAgIC50aGVuKChyZXNwb25zZSkgPT4ge1xuICAgICAgY2xlYXJDYWNoZUJ5VHlwZShnZXRNb2RlbFR5cGUobW9kZWwpKTtcblxuICAgICAgcmV0dXJuIHJlc3BvbnNlO1xuICAgIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVtb3ZlTW9kZWw8VCBleHRlbmRzIElKc29uYXBpTW9kZWw+KG1vZGVsOiBULCBvcHRpb25zPzogSVJlcXVlc3RPcHRpb25zKTogUHJvbWlzZTx2b2lkPiB7XG4gIGNvbnN0IGNvbGxlY3Rpb24gPSBnZXRNb2RlbENvbGxlY3Rpb24obW9kZWwpIGFzIElKc29uYXBpQ29sbGVjdGlvbjtcblxuICBjb25zdCBpc1BlcnNpc3RlZCA9IGlzTW9kZWxQZXJzaXN0ZWQobW9kZWwpO1xuICBjb25zdCB1cmwgPSBnZXRNb2RlbEVuZHBvaW50VXJsKG1vZGVsKTtcblxuICBpZiAoaXNQZXJzaXN0ZWQpIHtcbiAgICByZXR1cm4gcmVtb3ZlKHVybCwgY29sbGVjdGlvbiwgb3B0aW9ucyAmJiBvcHRpb25zLmhlYWRlcnMpXG4gICAgICAudGhlbigocmVzcG9uc2U6IFJlc3BvbnNlPFQ+KSA9PiB7XG4gICAgICAgIGlmIChyZXNwb25zZS5lcnJvcikge1xuICAgICAgICAgIHRocm93IHJlc3BvbnNlLmVycm9yO1xuICAgICAgICB9XG5cbiAgICAgICAgc2V0TW9kZWxQZXJzaXN0ZWQobW9kZWwsIGZhbHNlKTtcblxuICAgICAgICBpZiAoY29sbGVjdGlvbikge1xuICAgICAgICAgIGNvbGxlY3Rpb24ucmVtb3ZlKG1vZGVsKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gIH0gZWxzZSBpZiAoY29sbGVjdGlvbikge1xuICAgIGNvbGxlY3Rpb24ucmVtb3ZlKG1vZGVsKTtcbiAgfVxuXG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNhdmVSZWxhdGlvbnNoaXA8VCBleHRlbmRzIElKc29uYXBpTW9kZWw+KFxuICBtb2RlbDogVCxcbiAgcmVmOiBzdHJpbmcsXG4gIG9wdGlvbnM/OiBJUmVxdWVzdE9wdGlvbnMsXG4pOiBQcm9taXNlPFQ+IHtcbiAgY29uc3QgY29sbGVjdGlvbiA9IGdldE1vZGVsQ29sbGVjdGlvbihtb2RlbCkgYXMgSUpzb25hcGlDb2xsZWN0aW9uO1xuICBjb25zdCBsaW5rID0gZ2V0TGluayhtb2RlbCwgcmVmLCAnc2VsZicpO1xuICBjb25zdCBocmVmOiBzdHJpbmcgPSB0eXBlb2YgbGluayA9PT0gJ29iamVjdCcgPyBsaW5rLmhyZWYgOiBsaW5rO1xuXG4gIGNvbnN0IGlkcyA9IGdldFJlZklkKG1vZGVsLCByZWYpO1xuICBjb25zdCB0eXBlID0gZ2V0TW9kZWxUeXBlKGdldE1vZGVsTWV0YUtleShtb2RlbCwgJ3JlZnMnKVtyZWZdLm1vZGVsKTtcbiAgdHlwZSBJRCA9IElEZWZpbml0aW9ufEFycmF5PElEZWZpbml0aW9uPjtcbiAgY29uc3QgZGF0YTogSUQgPSBtYXBJdGVtcyhpZHMsIChpZCkgPT4gKHtpZCwgdHlwZX0pKSBhcyBJRDtcblxuICByZXR1cm4gdXBkYXRlKGhyZWYsIHtkYXRhfSwgY29sbGVjdGlvbiwgb3B0aW9ucyAmJiBvcHRpb25zLmhlYWRlcnMpXG4gICAgLnRoZW4oaGFuZGxlUmVzcG9uc2UobW9kZWwsIHJlZikpO1xufVxuIl19","dts":{"name":"/Users/darko/Projects/mobx/datx/packages/datx-jsonapi/helpers/model.d.ts","text":"import { PureModel } from 'datx';\r\nimport { IDictionary, IRawModel } from 'datx-utils';\r\nimport { IJsonapiModel } from '../interfaces/IJsonapiModel';\r\nimport { IRequestOptions } from '../interfaces/IRequestOptions';\r\nimport { ILink, IRecord } from '../interfaces/JsonApi';\r\nimport { Response } from '../Response';\r\nexport declare function flattenModel(): null;\r\nexport declare function flattenModel(data?: IRecord): IRawModel;\r\nexport declare function getModelMeta(model: PureModel): IDictionary;\r\nexport declare function getModelLinks(model: PureModel): IDictionary<ILink>;\r\nexport declare function fetchModelLink<T extends IJsonapiModel = IJsonapiModel>(model: PureModel, key: string, requestHeaders?: IDictionary<string>, options?: IRequestOptions): Promise<Response<T>>;\r\nexport declare function fetchModelRefLink<T extends IJsonapiModel = IJsonapiModel>(model: PureModel, ref: string, key: string, requestHeaders?: IDictionary<string>, options?: IRequestOptions): Promise<Response<T>>;\r\nexport declare function getModelRefLinks(model: PureModel): IDictionary<IDictionary<ILink>>;\r\nexport declare function getModelRefMeta(model: PureModel): IDictionary;\r\nexport declare function modelToJsonApi(model: IJsonapiModel): IRecord;\r\nexport declare function saveModel(model: IJsonapiModel, options?: IRequestOptions): Promise<IJsonapiModel>;\r\nexport declare function removeModel<T extends IJsonapiModel>(model: T, options?: IRequestOptions): Promise<void>;\r\nexport declare function saveRelationship<T extends IJsonapiModel>(model: T, ref: string, options?: IRequestOptions): Promise<T>;\r\n"}}
