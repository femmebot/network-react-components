{"code":"import * as tslib_1 from \"tslib\";\r\nimport { getModelCollection, getModelId, getModelMetaKey, getModelType, getRefId, modelToJSON, ReferenceType, setModelMetaKey, } from 'datx';\r\nimport { mapItems, META_FIELD } from 'datx-utils';\r\nimport { isObservableArray } from 'mobx';\r\nimport { MODEL_LINKS_FIELD, MODEL_META_FIELD, MODEL_PERSISTED_FIELD, MODEL_PROP_FIELD, MODEL_QUEUE_FIELD, MODEL_REF_LINKS_FIELD, MODEL_REF_META_FIELD, MODEL_RELATED_FIELD, } from '../consts';\r\nimport { config, create, fetchLink, handleResponse, remove, update } from '../NetworkUtils';\r\nimport { getValue } from './utils';\r\nexport function flattenModel(data) {\r\n    if (!data) {\r\n        return null;\r\n    }\r\n    var rawData = (_a = {},\r\n        _a[META_FIELD] = (_b = {\r\n                fields: Object.keys(data.attributes),\r\n                id: data.id\r\n            },\r\n            _b[MODEL_LINKS_FIELD] = data.links,\r\n            _b[MODEL_META_FIELD] = data.meta,\r\n            _b[MODEL_PERSISTED_FIELD] = Boolean(data.id),\r\n            _b.refs = {},\r\n            _b.type = data.type,\r\n            _b),\r\n        _a);\r\n    if (data.relationships) {\r\n        var refLinks_1 = {};\r\n        var refMeta_1 = {};\r\n        var refs_1 = {};\r\n        Object.keys(data.relationships).forEach(function (key) {\r\n            var ref = data.relationships[key];\r\n            if ('data' in ref && ref.data) {\r\n                rawData[key] = mapItems(ref.data, function (item) { return item.id; });\r\n                refs_1[key] = {\r\n                    model: ref.data instanceof Array ? ref.data[0].type : ref.data.type,\r\n                    type: ref.data instanceof Array ? ReferenceType.TO_MANY : ReferenceType.TO_ONE,\r\n                };\r\n            }\r\n            if ('links' in ref) {\r\n                refLinks_1[key] = ref.links;\r\n            }\r\n            if ('meta' in ref) {\r\n                refMeta_1[key] = ref.meta;\r\n            }\r\n        });\r\n        rawData[META_FIELD].refs = refs_1;\r\n        rawData[META_FIELD][MODEL_REF_LINKS_FIELD] = refLinks_1;\r\n        rawData[META_FIELD][MODEL_REF_META_FIELD] = refMeta_1;\r\n    }\r\n    return Object.assign(rawData, data.attributes);\r\n    var _a, _b;\r\n}\r\nexport function getModelMeta(model) {\r\n    return getModelMetaKey(model, MODEL_META_FIELD);\r\n}\r\nexport function getModelLinks(model) {\r\n    return getModelMetaKey(model, MODEL_LINKS_FIELD);\r\n}\r\nexport function fetchModelLink(model, key, requestHeaders, options) {\r\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n        var collection, links, link, responseObj;\r\n        return tslib_1.__generator(this, function (_a) {\r\n            collection = getModelCollection(model);\r\n            links = getModelLinks(model);\r\n            if (!(key in links)) {\r\n                throw new Error(\"Link \" + key + \" doesn't exist on the model\");\r\n            }\r\n            link = links[key];\r\n            responseObj = fetchLink(link, collection, requestHeaders, options);\r\n            if (getModelMetaKey(model, MODEL_QUEUE_FIELD)) {\r\n                return [2 /*return*/, responseObj.then(function (response) {\r\n                        var related = getModelMetaKey(model, MODEL_RELATED_FIELD);\r\n                        var prop = getModelMetaKey(model, MODEL_PROP_FIELD);\r\n                        var record = response.data;\r\n                        var recordType = record && getModelType(record);\r\n                        if (record && recordType !== getModelType(model) && recordType === getModelType(related)) {\r\n                            if (prop) {\r\n                                related[prop] = record;\r\n                                return response;\r\n                            }\r\n                            setModelMetaKey(related, MODEL_PERSISTED_FIELD, true);\r\n                            return response.replaceData(related);\r\n                        }\r\n                        return response;\r\n                    })];\r\n            }\r\n            return [2 /*return*/, responseObj];\r\n        });\r\n    });\r\n}\r\nfunction getLink(model, ref, key) {\r\n    var collection = getModelCollection(model);\r\n    if (!collection) {\r\n        throw new Error('The model needs to be in a collection');\r\n    }\r\n    var links = getModelRefLinks(model);\r\n    if (!(ref in links)) {\r\n        throw new Error(\"The reference \" + ref + \" doesn't have any links\");\r\n    }\r\n    var refLinks = links[ref];\r\n    if (!(key in refLinks)) {\r\n        throw new Error(\"Link \" + key + \" doesn't exist on the model\");\r\n    }\r\n    return refLinks[key];\r\n}\r\nexport function fetchModelRefLink(model, ref, key, requestHeaders, options) {\r\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n        var collection, link;\r\n        return tslib_1.__generator(this, function (_a) {\r\n            collection = getModelCollection(model);\r\n            link = getLink(model, ref, key);\r\n            return [2 /*return*/, fetchLink(link, collection, requestHeaders, options)];\r\n        });\r\n    });\r\n}\r\nexport function getModelRefLinks(model) {\r\n    return getModelMetaKey(model, MODEL_REF_LINKS_FIELD);\r\n}\r\nexport function getModelRefMeta(model) {\r\n    return getModelMetaKey(model, MODEL_REF_META_FIELD);\r\n}\r\nfunction isModelPersisted(model) {\r\n    return getModelMetaKey(model, MODEL_PERSISTED_FIELD);\r\n}\r\nfunction setModelPersisted(model, status) {\r\n    setModelMetaKey(model, MODEL_PERSISTED_FIELD, status);\r\n}\r\nexport function modelToJsonApi(model) {\r\n    var staticModel = model.constructor;\r\n    var attributes = modelToJSON(model);\r\n    var useAutogenerated = staticModel['useAutogeneratedIds'];\r\n    var isPersisted = isModelPersisted(model);\r\n    var data = {\r\n        attributes: attributes,\r\n        id: (isPersisted || useAutogenerated) ? getModelId(model) : undefined,\r\n        type: getModelType(model),\r\n    };\r\n    var refs = getModelMetaKey(model, 'refs');\r\n    Object.keys(refs).forEach(function (key) {\r\n        data.relationships = data.relationships || {};\r\n        var refIds = getRefId(model, key);\r\n        var rel;\r\n        if (refIds instanceof Array || isObservableArray(refIds)) {\r\n            rel = refIds.map(function (id, index) {\r\n                var type = model[key][index] ? getModelType(model[key][index]) : refs[key].model;\r\n                return { id: id, type: type };\r\n            });\r\n        }\r\n        else {\r\n            var type = model[key] ? getModelType(model[key]) : refs[key].model;\r\n            rel = { id: refIds, type: type };\r\n        }\r\n        data.relationships[key] = { data: rel };\r\n        delete data.attributes[key];\r\n    });\r\n    delete data.attributes[META_FIELD];\r\n    return data;\r\n}\r\nfunction getModelEndpointUrl(model) {\r\n    var staticModel = model.constructor;\r\n    var links = getModelLinks(model);\r\n    if (links && links.self) {\r\n        var self = links.self;\r\n        return typeof self === 'string' ? self : self.href;\r\n    }\r\n    var url = getValue(staticModel['endpoint']) || getModelType(model);\r\n    return isModelPersisted(model)\r\n        ? \"\" + config.baseUrl + url + \"/\" + getModelId(model)\r\n        : \"\" + config.baseUrl + url;\r\n}\r\nexport function saveModel(model, options) {\r\n    var collection = getModelCollection(model);\r\n    var data = modelToJsonApi(model);\r\n    var requestMethod = isModelPersisted(model) ? update : create;\r\n    var url = getModelEndpointUrl(model);\r\n    return requestMethod(url, { data: data }, collection, options && options.headers)\r\n        .then(handleResponse(model));\r\n}\r\nexport function removeModel(model, options) {\r\n    var collection = getModelCollection(model);\r\n    var isPersisted = isModelPersisted(model);\r\n    var url = getModelEndpointUrl(model);\r\n    if (isPersisted) {\r\n        return remove(url, collection, options && options.headers)\r\n            .then(function (response) {\r\n            if (response.error) {\r\n                throw response.error;\r\n            }\r\n            setModelPersisted(model, false);\r\n            if (collection) {\r\n                collection.remove(model);\r\n            }\r\n        });\r\n    }\r\n    else if (collection) {\r\n        collection.remove(model);\r\n    }\r\n    return Promise.resolve();\r\n}\r\nexport function saveRelationship(model, ref, options) {\r\n    var collection = getModelCollection(model);\r\n    var link = getLink(model, ref, 'self');\r\n    var href = typeof link === 'object' ? link.href : link;\r\n    var ids = getRefId(model, ref);\r\n    var type = getModelType(getModelMetaKey(model, 'refs')[ref].model);\r\n    var data = mapItems(ids, function (id) { return ({ id: id, type: type }); });\r\n    return update(href, { data: data }, collection, options && options.headers)\r\n        .then(handleResponse(model, ref));\r\n}\r\n//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kZWwuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaGVscGVycy9tb2RlbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLGtCQUFrQixFQUNsQixVQUFVLEVBQ1YsZUFBZSxFQUNmLFlBQVksRUFDWixRQUFRLEVBRVIsV0FBVyxFQUVYLGFBQWEsRUFDYixlQUFlLEdBQ2hCLE1BQU0sTUFBTSxDQUFDO0FBQ2QsT0FBTyxFQUF5QixRQUFRLEVBQUUsVUFBVSxFQUFDLE1BQU0sWUFBWSxDQUFDO0FBQ3hFLE9BQU8sRUFBQyxpQkFBaUIsRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUV2QyxPQUFPLEVBQ0wsaUJBQWlCLEVBQ2pCLGdCQUFnQixFQUNoQixxQkFBcUIsRUFDckIsZ0JBQWdCLEVBQ2hCLGlCQUFpQixFQUNqQixxQkFBcUIsRUFDckIsb0JBQW9CLEVBQ3BCLG1CQUFtQixHQUNwQixNQUFNLFdBQVcsQ0FBQztBQUtuQixPQUFPLEVBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsY0FBYyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUMsTUFBTSxpQkFBaUIsQ0FBQztBQUUxRixPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0sU0FBUyxDQUFDO0FBSWpDLE1BQU0sdUJBQXVCLElBQWM7SUFDekMsSUFBSSxDQUFDLElBQUksRUFBRTtRQUNULE9BQU8sSUFBSSxDQUFDO0tBQ2I7SUFFRCxJQUFNLE9BQU87UUFDWCxHQUFDLFVBQVU7Z0JBQ1QsTUFBTSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQztnQkFDcEMsRUFBRSxFQUFFLElBQUksQ0FBQyxFQUFFOztZQUNYLEdBQUMsaUJBQWlCLElBQUcsSUFBSSxDQUFDLEtBQUs7WUFDL0IsR0FBQyxnQkFBZ0IsSUFBRyxJQUFJLENBQUMsSUFBSTtZQUM3QixHQUFDLHFCQUFxQixJQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFB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Q3RDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBnZXRNb2RlbENvbGxlY3Rpb24sXG4gIGdldE1vZGVsSWQsXG4gIGdldE1vZGVsTWV0YUtleSxcbiAgZ2V0TW9kZWxUeXBlLFxuICBnZXRSZWZJZCxcbiAgSUlkZW50aWZpZXIsXG4gIG1vZGVsVG9KU09OLFxuICBQdXJlTW9kZWwsXG4gIFJlZmVyZW5jZVR5cGUsXG4gIHNldE1vZGVsTWV0YUtleSxcbn0gZnJvbSAnZGF0eCc7XG5pbXBvcnQge0lEaWN0aW9uYXJ5LCBJUmF3TW9kZWwsIG1hcEl0ZW1zLCBNRVRBX0ZJRUxEfSBmcm9tICdkYXR4LXV0aWxzJztcbmltcG9ydCB7aXNPYnNlcnZhYmxlQXJyYXl9IGZyb20gJ21vYngnO1xuXG5pbXBvcnQge1xuICBNT0RFTF9MSU5LU19GSUVMRCxcbiAgTU9ERUxfTUVUQV9GSUVMRCxcbiAgTU9ERUxfUEVSU0lTVEVEX0ZJRUxELFxuICBNT0RFTF9QUk9QX0ZJRUxELFxuICBNT0RFTF9RVUVVRV9GSUVMRCxcbiAgTU9ERUxfUkVGX0xJTktTX0ZJRUxELFxuICBNT0RFTF9SRUZfTUVUQV9GSUVMRCxcbiAgTU9ERUxfUkVMQVRFRF9GSUVMRCxcbn0gZnJvbSAnLi4vY29uc3RzJztcbmltcG9ydCB7SUpzb25hcGlDb2xsZWN0aW9ufSBmcm9tICcuLi9pbnRlcmZhY2VzL0lKc29uYXBpQ29sbGVjdGlvbic7XG5pbXBvcnQge0lKc29uYXBpTW9kZWx9IGZyb20gJy4uL2ludGVyZmFjZXMvSUpzb25hcGlNb2RlbCc7XG5pbXBvcnQge0lSZXF1ZXN0T3B0aW9uc30gZnJvbSAnLi4vaW50ZXJmYWNlcy9JUmVxdWVzdE9wdGlvbnMnO1xuaW1wb3J0IHtJRGVmaW5pdGlvbiwgSUxpbmssIElSZWNvcmQsIElSZWxhdGlvbnNoaXB9IGZyb20gJy4uL2ludGVyZmFjZXMvSnNvbkFwaSc7XG5pbXBvcnQge2NvbmZpZywgY3JlYXRlLCBmZXRjaExpbmssIGhhbmRsZVJlc3BvbnNlLCByZW1vdmUsIHVwZGF0ZX0gZnJvbSAnLi4vTmV0d29ya1V0aWxzJztcbmltcG9ydCB7UmVzcG9uc2V9IGZyb20gJy4uL1Jlc3BvbnNlJztcbmltcG9ydCB7Z2V0VmFsdWV9IGZyb20gJy4vdXRpbHMnO1xuXG5leHBvcnQgZnVuY3Rpb24gZmxhdHRlbk1vZGVsKCk6IG51bGw7XG5leHBvcnQgZnVuY3Rpb24gZmxhdHRlbk1vZGVsKGRhdGE/OiBJUmVjb3JkKTogSVJhd01vZGVsO1xuZXhwb3J0IGZ1bmN0aW9uIGZsYXR0ZW5Nb2RlbChkYXRhPzogSVJlY29yZCk6IElSYXdNb2RlbHxudWxsIHtcbiAgaWYgKCFkYXRhKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBjb25zdCByYXdEYXRhID0ge1xuICAgIFtNRVRBX0ZJRUxEXToge1xuICAgICAgZmllbGRzOiBPYmplY3Qua2V5cyhkYXRhLmF0dHJpYnV0ZXMpLFxuICAgICAgaWQ6IGRhdGEuaWQsXG4gICAgICBbTU9ERUxfTElOS1NfRklFTERdOiBkYXRhLmxpbmtzLFxuICAgICAgW01PREVMX01FVEFfRklFTERdOiBkYXRhLm1ldGEsXG4gICAgICBbTU9ERUxfUEVSU0lTVEVEX0ZJRUxEXTogQm9vbGVhbihkYXRhLmlkKSxcbiAgICAgIHJlZnM6IHt9LFxuICAgICAgdHlwZTogZGF0YS50eXBlLFxuICAgIH0sXG4gIH07XG5cbiAgaWYgKGRhdGEucmVsYXRpb25zaGlwcykge1xuICAgIGNvbnN0IHJlZkxpbmtzID0ge307XG4gICAgY29uc3QgcmVmTWV0YSA9IHt9O1xuICAgIGNvbnN0IHJlZnMgPSB7fTtcbiAgICBPYmplY3Qua2V5cyhkYXRhLnJlbGF0aW9uc2hpcHMpLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgY29uc3QgcmVmID0gKGRhdGEucmVsYXRpb25zaGlwcyBhcyBJRGljdGlvbmFyeTxJUmVsYXRpb25zaGlwPilba2V5XSBhcyBJUmVsYXRpb25zaGlwO1xuICAgICAgaWYgKCdkYXRhJyBpbiByZWYgJiYgcmVmLmRhdGEpIHtcbiAgICAgICAgcmF3RGF0YVtrZXldID0gbWFwSXRlbXMocmVmLmRhdGEsIChpdGVtOiBJRGVmaW5pdGlvbikgPT4gaXRlbS5pZCk7XG4gICAgICAgIHJlZnNba2V5XSA9IHtcbiAgICAgICAgICBtb2RlbDogcmVmLmRhdGEgaW5zdGFuY2VvZiBBcnJheSA/IHJlZi5kYXRhWzBdLnR5cGUgOiByZWYuZGF0YS50eXBlLFxuICAgICAgICAgIHR5cGU6IHJlZi5kYXRhIGluc3RhbmNlb2YgQXJyYXkgPyBSZWZlcmVuY2VUeXBlLlRPX01BTlkgOiBSZWZlcmVuY2VUeXBlLlRPX09ORSxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICAgIGlmICgnbGlua3MnIGluIHJlZikge1xuICAgICAgICByZWZMaW5rc1trZXldID0gcmVmLmxpbmtzO1xuICAgICAgfVxuICAgICAgaWYgKCdtZXRhJyBpbiByZWYpIHtcbiAgICAgICAgcmVmTWV0YVtrZXldID0gcmVmLm1ldGE7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByYXdEYXRhW01FVEFfRklFTERdLnJlZnMgPSByZWZzO1xuICAgIHJhd0RhdGFbTUVUQV9GSUVMRF1bTU9ERUxfUkVGX0xJTktTX0ZJRUxEXSA9IHJlZkxpbmtzO1xuICAgIHJhd0RhdGFbTUVUQV9GSUVMRF1bTU9ERUxfUkVGX01FVEFfRklFTERdID0gcmVmTWV0YTtcbiAgfVxuXG4gIHJldHVybiBPYmplY3QuYXNzaWduKHJhd0RhdGEsIGRhdGEuYXR0cmlidXRlcyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRNb2RlbE1ldGEobW9kZWw6IFB1cmVNb2RlbCk6IElEaWN0aW9uYXJ5PGFueT4ge1xuICByZXR1cm4gZ2V0TW9kZWxNZXRhS2V5KG1vZGVsLCBNT0RFTF9NRVRBX0ZJRUxEKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldE1vZGVsTGlua3MobW9kZWw6IFB1cmVNb2RlbCk6IElEaWN0aW9uYXJ5PElMaW5rPiB7XG4gIHJldHVybiBnZXRNb2RlbE1ldGFLZXkobW9kZWwsIE1PREVMX0xJTktTX0ZJRUxEKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGZldGNoTW9kZWxMaW5rPFQgZXh0ZW5kcyBJSnNvbmFwaU1vZGVsID0gSUpzb25hcGlNb2RlbD4oXG4gIG1vZGVsOiBQdXJlTW9kZWwsXG4gIGtleTogc3RyaW5nLFxuICByZXF1ZXN0SGVhZGVycz86IElEaWN0aW9uYXJ5PHN0cmluZz4sXG4gIG9wdGlvbnM/OiBJUmVxdWVzdE9wdGlvbnMsXG4pOiBQcm9taXNlPFJlc3BvbnNlPFQ+PiB7XG4gIGNvbnN0IGNvbGxlY3Rpb24gPSBnZXRNb2RlbENvbGxlY3Rpb24obW9kZWwpO1xuICBjb25zdCBsaW5rcyA9IGdldE1vZGVsTGlua3MobW9kZWwpO1xuICBpZiAoIShrZXkgaW4gbGlua3MpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBMaW5rICR7a2V5fSBkb2Vzbid0IGV4aXN0IG9uIHRoZSBtb2RlbGApO1xuICB9XG4gIGNvbnN0IGxpbmsgPSBsaW5rc1trZXldO1xuICBjb25zdCByZXNwb25zZU9iaiA9IGZldGNoTGluazxUPihsaW5rLCBjb2xsZWN0aW9uIGFzIElKc29uYXBpQ29sbGVjdGlvbiwgcmVxdWVzdEhlYWRlcnMsIG9wdGlvbnMpO1xuXG4gIGlmIChnZXRNb2RlbE1ldGFLZXkobW9kZWwsIE1PREVMX1FVRVVFX0ZJRUxEKSkge1xuICAgIHJldHVybiByZXNwb25zZU9iai50aGVuKChyZXNwb25zZSkgPT4ge1xuICAgICAgY29uc3QgcmVsYXRlZCA9IGdldE1vZGVsTWV0YUtleShtb2RlbCwgTU9ERUxfUkVMQVRFRF9GSUVMRCk7XG4gICAgICBjb25zdCBwcm9wID0gZ2V0TW9kZWxNZXRhS2V5KG1vZGVsLCBNT0RFTF9QUk9QX0ZJRUxEKTtcbiAgICAgIGNvbnN0IHJlY29yZCA9IHJlc3BvbnNlLmRhdGE7XG4gICAgICBjb25zdCByZWNvcmRUeXBlID0gcmVjb3JkICYmIGdldE1vZGVsVHlwZShyZWNvcmQpO1xuICAgICAgaWYgKHJlY29yZCAmJiByZWNvcmRUeXBlICE9PSBnZXRNb2RlbFR5cGUobW9kZWwpICYmIHJlY29yZFR5cGUgPT09IGdldE1vZGVsVHlwZShyZWxhdGVkKSkge1xuICAgICAgICBpZiAocHJvcCkge1xuICAgICAgICAgIHJlbGF0ZWRbcHJvcF0gPSByZWNvcmQ7XG4gICAgICAgICAgcmV0dXJuIHJlc3BvbnNlO1xuICAgICAgICB9XG4gICAgICAgIHNldE1vZGVsTWV0YUtleShyZWxhdGVkLCBNT0RFTF9QRVJTSVNURURfRklFTEQsIHRydWUpO1xuICAgICAgICByZXR1cm4gcmVzcG9uc2UucmVwbGFjZURhdGEocmVsYXRlZCk7XG4gICAgICB9XG4gICAgICByZXR1cm4gcmVzcG9uc2U7XG4gICAgfSk7XG4gIH1cblxuICByZXR1cm4gcmVzcG9uc2VPYmo7XG59XG5cbmZ1bmN0aW9uIGdldExpbmsobW9kZWw6IFB1cmVNb2RlbCwgcmVmOiBzdHJpbmcsIGtleTogc3RyaW5nKSB7XG4gIGNvbnN0IGNvbGxlY3Rpb24gPSBnZXRNb2RlbENvbGxlY3Rpb24obW9kZWwpO1xuICBpZiAoIWNvbGxlY3Rpb24pIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBtb2RlbCBuZWVkcyB0byBiZSBpbiBhIGNvbGxlY3Rpb24nKTtcbiAgfVxuICBjb25zdCBsaW5rcyA9IGdldE1vZGVsUmVmTGlua3MobW9kZWwpO1xuICBpZiAoIShyZWYgaW4gbGlua3MpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgcmVmZXJlbmNlICR7cmVmfSBkb2Vzbid0IGhhdmUgYW55IGxpbmtzYCk7XG4gIH1cbiAgY29uc3QgcmVmTGlua3MgPSBsaW5rc1tyZWZdO1xuICBpZiAoIShrZXkgaW4gcmVmTGlua3MpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBMaW5rICR7a2V5fSBkb2Vzbid0IGV4aXN0IG9uIHRoZSBtb2RlbGApO1xuICB9XG4gIHJldHVybiByZWZMaW5rc1trZXldO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZmV0Y2hNb2RlbFJlZkxpbms8VCBleHRlbmRzIElKc29uYXBpTW9kZWwgPSBJSnNvbmFwaU1vZGVsPihcbiAgbW9kZWw6IFB1cmVNb2RlbCxcbiAgcmVmOiBzdHJpbmcsXG4gIGtleTogc3RyaW5nLFxuICByZXF1ZXN0SGVhZGVycz86IElEaWN0aW9uYXJ5PHN0cmluZz4sXG4gIG9wdGlvbnM/OiBJUmVxdWVzdE9wdGlvbnMsXG4pOiBQcm9taXNlPFJlc3BvbnNlPFQ+PiB7XG4gIGNvbnN0IGNvbGxlY3Rpb24gPSBnZXRNb2RlbENvbGxlY3Rpb24obW9kZWwpO1xuICBjb25zdCBsaW5rID0gZ2V0TGluayhtb2RlbCwgcmVmLCBrZXkpO1xuICByZXR1cm4gZmV0Y2hMaW5rPFQ+KGxpbmssIGNvbGxlY3Rpb24gYXMgSUpzb25hcGlDb2xsZWN0aW9uLCByZXF1ZXN0SGVhZGVycywgb3B0aW9ucyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRNb2RlbFJlZkxpbmtzKG1vZGVsOiBQdXJlTW9kZWwpOiBJRGljdGlvbmFyeTxJRGljdGlvbmFyeTxJTGluaz4+IHtcbiAgcmV0dXJuIGdldE1vZGVsTWV0YUtleShtb2RlbCwgTU9ERUxfUkVGX0xJTktTX0ZJRUxEKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldE1vZGVsUmVmTWV0YShtb2RlbDogUHVyZU1vZGVsKTogSURpY3Rpb25hcnk8YW55PiB7XG4gIHJldHVybiBnZXRNb2RlbE1ldGFLZXkobW9kZWwsIE1PREVMX1JFRl9NRVRBX0ZJRUxEKTtcbn1cblxuZnVuY3Rpb24gaXNNb2RlbFBlcnNpc3RlZChtb2RlbDogUHVyZU1vZGVsKTogYm9vbGVhbiB7XG4gIHJldHVybiBnZXRNb2RlbE1ldGFLZXkobW9kZWwsIE1PREVMX1BFUlNJU1RFRF9GSUVMRCk7XG59XG5cbmZ1bmN0aW9uIHNldE1vZGVsUGVyc2lzdGVkKG1vZGVsOiBQdXJlTW9kZWwsIHN0YXR1czogYm9vbGVhbikge1xuICBzZXRNb2RlbE1ldGFLZXkobW9kZWwsIE1PREVMX1BFUlNJU1RFRF9GSUVMRCwgc3RhdHVzKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1vZGVsVG9Kc29uQXBpKG1vZGVsOiBJSnNvbmFwaU1vZGVsKTogSVJlY29yZCB7XG4gIGNvbnN0IHN0YXRpY01vZGVsID0gbW9kZWwuY29uc3RydWN0b3IgYXMgdHlwZW9mIFB1cmVNb2RlbDtcbiAgY29uc3QgYXR0cmlidXRlczogSURpY3Rpb25hcnk8YW55PiA9IG1vZGVsVG9KU09OKG1vZGVsKTtcblxuICBjb25zdCB1c2VBdXRvZ2VuZXJhdGVkOiBib29sZWFuID0gc3RhdGljTW9kZWxbJ3VzZUF1dG9nZW5lcmF0ZWRJZHMnXTtcbiAgY29uc3QgaXNQZXJzaXN0ZWQgPSBpc01vZGVsUGVyc2lzdGVkKG1vZGVsKTtcblxuICBjb25zdCBkYXRhOiBJUmVjb3JkID0ge1xuICAgIGF0dHJpYnV0ZXMsXG4gICAgaWQ6IChpc1BlcnNpc3RlZCB8fCB1c2VBdXRvZ2VuZXJhdGVkKSA/IGdldE1vZGVsSWQobW9kZWwpIDogdW5kZWZpbmVkLFxuICAgIHR5cGU6IGdldE1vZGVsVHlwZShtb2RlbCkgYXMgc3RyaW5nLFxuICB9O1xuXG4gIGNvbnN0IHJlZnMgPSBnZXRNb2RlbE1ldGFLZXkobW9kZWwsICdyZWZzJyk7XG5cbiAgT2JqZWN0LmtleXMocmVmcykuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgZGF0YS5yZWxhdGlvbnNoaXBzID0gZGF0YS5yZWxhdGlvbnNoaXBzIHx8IHt9O1xuICAgIGNvbnN0IHJlZklkcyA9IGdldFJlZklkKG1vZGVsLCBrZXkpO1xuICAgIGxldCByZWw6IElEZWZpbml0aW9ufEFycmF5PElEZWZpbml0aW9uPjtcbiAgICBpZiAocmVmSWRzIGluc3RhbmNlb2YgQXJyYXkgfHwgaXNPYnNlcnZhYmxlQXJyYXkocmVmSWRzKSkge1xuICAgICAgcmVsID0gKHJlZklkcyBhcyBBcnJheTxJSWRlbnRpZmllcj4pLm1hcCgoaWQsIGluZGV4KSA9PiB7XG4gICAgICAgIGNvbnN0IHR5cGUgPSBtb2RlbFtrZXldW2luZGV4XSA/IGdldE1vZGVsVHlwZShtb2RlbFtrZXldW2luZGV4XSkgOiByZWZzW2tleV0ubW9kZWw7XG4gICAgICAgIHJldHVybiB7aWQsIHR5cGV9O1xuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHR5cGU6IHN0cmluZyA9IG1vZGVsW2tleV0gPyBnZXRNb2RlbFR5cGUobW9kZWxba2V5XSkgOiByZWZzW2tleV0ubW9kZWw7XG4gICAgICByZWwgPSB7aWQ6IHJlZklkcywgdHlwZX07XG4gICAgfVxuXG4gICAgZGF0YS5yZWxhdGlvbnNoaXBzW2tleV0gPSB7ZGF0YTogcmVsfSBhcyBJUmVsYXRpb25zaGlwO1xuICAgIGRlbGV0ZSBkYXRhLmF0dHJpYnV0ZXNba2V5XTtcbiAgfSk7XG5cbiAgZGVsZXRlIGRhdGEuYXR0cmlidXRlc1tNRVRBX0ZJRUxEXTtcblxuICByZXR1cm4gZGF0YTtcbn1cblxuZnVuY3Rpb24gZ2V0TW9kZWxFbmRwb2ludFVybChtb2RlbDogUHVyZU1vZGVsKTogc3RyaW5nIHtcbiAgY29uc3Qgc3RhdGljTW9kZWwgPSBtb2RlbC5jb25zdHJ1Y3RvciBhcyBQdXJlTW9kZWw7XG4gIGNvbnN0IGxpbmtzOiBJRGljdGlvbmFyeTxJTGluaz4gPSBnZXRNb2RlbExpbmtzKG1vZGVsKTtcbiAgaWYgKGxpbmtzICYmIGxpbmtzLnNlbGYpIHtcbiAgICBjb25zdCBzZWxmOiBJTGluayA9IGxpbmtzLnNlbGY7XG4gICAgcmV0dXJuIHR5cGVvZiBzZWxmID09PSAnc3RyaW5nJyA/IHNlbGYgOiBzZWxmLmhyZWY7XG4gIH1cblxuICBjb25zdCB1cmwgPSBnZXRWYWx1ZTxzdHJpbmc+KHN0YXRpY01vZGVsWydlbmRwb2ludCddKSB8fCBnZXRNb2RlbFR5cGUobW9kZWwpO1xuXG4gIHJldHVybiBpc01vZGVsUGVyc2lzdGVkKG1vZGVsKVxuICAgID8gYCR7Y29uZmlnLmJhc2VVcmx9JHt1cmx9LyR7Z2V0TW9kZWxJZChtb2RlbCl9YFxuICAgIDogYCR7Y29uZmlnLmJhc2VVcmx9JHt1cmx9YDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNhdmVNb2RlbChtb2RlbDogSUpzb25hcGlNb2RlbCwgb3B0aW9ucz86IElSZXF1ZXN0T3B0aW9ucyk6IFByb21pc2U8SUpzb25hcGlNb2RlbD4ge1xuICBjb25zdCBjb2xsZWN0aW9uID0gZ2V0TW9kZWxDb2xsZWN0aW9uKG1vZGVsKSBhcyBJSnNvbmFwaUNvbGxlY3Rpb247XG5cbiAgY29uc3QgZGF0YTogSVJlY29yZCA9IG1vZGVsVG9Kc29uQXBpKG1vZGVsKTtcbiAgY29uc3QgcmVxdWVzdE1ldGhvZCA9IGlzTW9kZWxQZXJzaXN0ZWQobW9kZWwpID8gdXBkYXRlIDogY3JlYXRlO1xuICBjb25zdCB1cmwgPSBnZXRNb2RlbEVuZHBvaW50VXJsKG1vZGVsKTtcbiAgcmV0dXJuIHJlcXVlc3RNZXRob2QodXJsLCB7ZGF0YX0sIGNvbGxlY3Rpb24sIG9wdGlvbnMgJiYgb3B0aW9ucy5oZWFkZXJzKVxuICAgIC50aGVuKGhhbmRsZVJlc3BvbnNlKG1vZGVsKSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZW1vdmVNb2RlbDxUIGV4dGVuZHMgSUpzb25hcGlNb2RlbD4obW9kZWw6IFQsIG9wdGlvbnM/OiBJUmVxdWVzdE9wdGlvbnMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgY29uc3QgY29sbGVjdGlvbiA9IGdldE1vZGVsQ29sbGVjdGlvbihtb2RlbCkgYXMgSUpzb25hcGlDb2xsZWN0aW9uO1xuXG4gIGNvbnN0IGlzUGVyc2lzdGVkID0gaXNNb2RlbFBlcnNpc3RlZChtb2RlbCk7XG4gIGNvbnN0IHVybCA9IGdldE1vZGVsRW5kcG9pbnRVcmwobW9kZWwpO1xuXG4gIGlmIChpc1BlcnNpc3RlZCkge1xuICAgIHJldHVybiByZW1vdmUodXJsLCBjb2xsZWN0aW9uLCBvcHRpb25zICYmIG9wdGlvbnMuaGVhZGVycylcbiAgICAgIC50aGVuKChyZXNwb25zZTogUmVzcG9uc2U8VD4pID0+IHtcbiAgICAgICAgaWYgKHJlc3BvbnNlLmVycm9yKSB7XG4gICAgICAgICAgdGhyb3cgcmVzcG9uc2UuZXJyb3I7XG4gICAgICAgIH1cblxuICAgICAgICBzZXRNb2RlbFBlcnNpc3RlZChtb2RlbCwgZmFsc2UpO1xuXG4gICAgICAgIGlmIChjb2xsZWN0aW9uKSB7XG4gICAgICAgICAgY29sbGVjdGlvbi5yZW1vdmUobW9kZWwpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgfSBlbHNlIGlmIChjb2xsZWN0aW9uKSB7XG4gICAgY29sbGVjdGlvbi5yZW1vdmUobW9kZWwpO1xuICB9XG5cbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2F2ZVJlbGF0aW9uc2hpcDxUIGV4dGVuZHMgSUpzb25hcGlNb2RlbD4oXG4gIG1vZGVsOiBULFxuICByZWY6IHN0cmluZyxcbiAgb3B0aW9ucz86IElSZXF1ZXN0T3B0aW9ucyxcbik6IFByb21pc2U8VD4ge1xuICBjb25zdCBjb2xsZWN0aW9uID0gZ2V0TW9kZWxDb2xsZWN0aW9uKG1vZGVsKSBhcyBJSnNvbmFwaUNvbGxlY3Rpb247XG4gIGNvbnN0IGxpbmsgPSBnZXRMaW5rKG1vZGVsLCByZWYsICdzZWxmJyk7XG4gIGNvbnN0IGhyZWY6IHN0cmluZyA9IHR5cGVvZiBsaW5rID09PSAnb2JqZWN0JyA/IGxpbmsuaHJlZiA6IGxpbms7XG5cbiAgY29uc3QgaWRzID0gZ2V0UmVmSWQobW9kZWwsIHJlZik7XG4gIGNvbnN0IHR5cGUgPSBnZXRNb2RlbFR5cGUoZ2V0TW9kZWxNZXRhS2V5KG1vZGVsLCAncmVmcycpW3JlZl0ubW9kZWwpO1xuICB0eXBlIElEID0gSURlZmluaXRpb258QXJyYXk8SURlZmluaXRpb24+O1xuICBjb25zdCBkYXRhOiBJRCA9IG1hcEl0ZW1zKGlkcywgKGlkKSA9PiAoe2lkLCB0eXBlfSkpIGFzIElEO1xuXG4gIHJldHVybiB1cGRhdGUoaHJlZiwge2RhdGF9LCBjb2xsZWN0aW9uLCBvcHRpb25zICYmIG9wdGlvbnMuaGVhZGVycylcbiAgICAudGhlbihoYW5kbGVSZXNwb25zZShtb2RlbCwgcmVmKSk7XG59XG4iXX0=","map":{"mappings":""},"dts":{"name":"/Users/darko/Projects/mobx/datx/packages/datx-jsonapi/helpers/model.d.ts","text":"import { PureModel } from 'datx';\r\nimport { IDictionary, IRawModel } from 'datx-utils';\r\nimport { IJsonapiModel } from '../interfaces/IJsonapiModel';\r\nimport { IRequestOptions } from '../interfaces/IRequestOptions';\r\nimport { ILink, IRecord } from '../interfaces/JsonApi';\r\nimport { Response } from '../Response';\r\nexport declare function flattenModel(): null;\r\nexport declare function flattenModel(data?: IRecord): IRawModel;\r\nexport declare function getModelMeta(model: PureModel): IDictionary<any>;\r\nexport declare function getModelLinks(model: PureModel): IDictionary<ILink>;\r\nexport declare function fetchModelLink<T extends IJsonapiModel = IJsonapiModel>(model: PureModel, key: string, requestHeaders?: IDictionary<string>, options?: IRequestOptions): Promise<Response<T>>;\r\nexport declare function fetchModelRefLink<T extends IJsonapiModel = IJsonapiModel>(model: PureModel, ref: string, key: string, requestHeaders?: IDictionary<string>, options?: IRequestOptions): Promise<Response<T>>;\r\nexport declare function getModelRefLinks(model: PureModel): IDictionary<IDictionary<ILink>>;\r\nexport declare function getModelRefMeta(model: PureModel): IDictionary<any>;\r\nexport declare function modelToJsonApi(model: IJsonapiModel): IRecord;\r\nexport declare function saveModel(model: IJsonapiModel, options?: IRequestOptions): Promise<IJsonapiModel>;\r\nexport declare function removeModel<T extends IJsonapiModel>(model: T, options?: IRequestOptions): Promise<void>;\r\nexport declare function saveRelationship<T extends IJsonapiModel>(model: T, ref: string, options?: IRequestOptions): Promise<T>;\r\n"}}
