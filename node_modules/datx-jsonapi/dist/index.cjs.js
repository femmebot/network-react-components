"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var datx=require("datx"),datxUtils=require("datx-utils"),mobx=require("mobx"),extendStatics=function(e,t){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function __extends(e,t){function r(){this.constructor=e}extendStatics(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var __assign=function(){return(__assign=Object.assign||function(e){for(var t,r=1,o=arguments.length;r<o;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)};function __decorate(e,t,r,o){var n,a=arguments.length,i=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var s=e.length-1;s>=0;s--)(n=e[s])&&(i=(a<3?n(i):a>3?n(t,r,i):n(t,r))||i);return a>3&&i&&Object.defineProperty(t,r,i),i}function __awaiter(e,t,r,o){return new(r||(r=Promise))(function(n,a){function i(e){try{d(o.next(e))}catch(e){a(e)}}function s(e){try{d(o.throw(e))}catch(e){a(e)}}function d(e){e.done?n(e.value):new r(function(t){t(e.value)}).then(i,s)}d((o=o.apply(e,t||[])).next())})}function __generator(e,t){var r,o,n,a,i={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;i;)try{if(r=1,o&&(n=2&a[0]?o.return:a[0]?o.throw||((n=o.return)&&n.call(o),0):o.next)&&!(n=n.call(o,a[1])).done)return n;switch(o=0,n&&(a=[2&a[0],n.value]),a[0]){case 0:case 1:n=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,o=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!(n=(n=i.trys).length>0&&n[n.length-1])&&(6===a[0]||2===a[0])){i=0;continue}if(3===a[0]&&(!n||a[1]>n[0]&&a[1]<n[3])){i.label=a[1];break}if(6===a[0]&&i.label<n[1]){i.label=n[1],n=a;break}if(n&&i.label<n[2]){i.label=n[2],i.ops.push(a);break}n[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],o=0}finally{r=n=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}}var cacheStorage=[];function saveCache(e,t,r){if("data"in t&&(!("error"in t)||!t.error)&&t.data){var o=r||datx.getModelType(t.data instanceof Array?t.data[0]:t.data);cacheStorage.push({response:t,time:new Date,type:o,url:e})}}function getCache(e){return cacheStorage.find(function(t){return t.url===e})}function clearAllCache(){cacheStorage.length=0}function clearCacheByType(e){cacheStorage=cacheStorage.filter(function(t){return t.type!==e})}var MODEL_LINKS_FIELD="jsonapiLinks",MODEL_REF_LINKS_FIELD="jsonapiRefLinks",MODEL_REF_META_FIELD="jsonapiRefMeta",MODEL_META_FIELD="jsonapiMeta",MODEL_PERSISTED_FIELD="jsonapiPersisted",MODEL_PROP_FIELD="jsonapiProp",MODEL_QUEUE_FIELD="jsonapiQueue",MODEL_RELATED_FIELD="jsonapiRelated",URL_REGEX=/^(?:http(s)?:\/\/)[\w.-]+(?:\.[\w\.-]+)+[\w\-\._~:/?#[\]@!\$&'\(\)\*\+,;=.]+$/;!function(e){e[e.MULTIPLE_PARAMS=0]="MULTIPLE_PARAMS",e[e.COMMA_SEPARATED=1]="COMMA_SEPARATED",e[e.PARAM_ARRAY=2]="PARAM_ARRAY",e[e.OBJECT_PATH=3]="OBJECT_PATH"}(exports.ParamArrayType||(exports.ParamArrayType={}));var isBrowser="undefined"!=typeof window;function getValue(e){return"function"==typeof e?e():e}var Response=function(){function e(e,t,r,o,n){var a=this;if(this.data=null,this.views=[],this.__cache={},this.__collection=t,this.__options=r,this.__response=e,this.status=e.status,n&&(this.views=n),t)this.data=o?t.add(o):t.sync(e.data);else if(e.data){var i=e.data;if(i.data){if(i.data instanceof Array)throw new Error("A save/remove operation should not return an array of results");this.data=o||new GenericModel(flattenModel(i.data))}}if(this.views.forEach(function(e){a.data&&e.add(a.data)}),this.meta=e.data&&e.data.meta||{},this.links=e.data&&e.data.links||{},this.jsonapi=e.data&&e.data.jsonapi||{},this.headers=e.headers,this.requestHeaders=e.requestHeaders,this.error=e.data&&e.data.errors||e.error,this.links&&Object.keys(this.links).forEach(function(e){datxUtils.assignComputed(a,e,function(){return a.__fetchLink(e)})}),Object.freeze(this),this.error)throw this}return e.prototype.replaceData=function(t){var r=this.data;if(r===t)return this;datx.getModelId(t);var o=datx.getModelId(r),n=(datx.getModelType(r),this.views.map(function(e){return e.list.indexOf(r)}));return this.__collection&&(this.__collection.remove(r),this.__collection.add(t)),datx.updateModel(t,datx.modelToJSON(r)),datx.updateModelId(t,o),this.views.forEach(function(e,r){-1!==n[r]&&(e.list[n[r]]=t)}),new e(this.__response,this.__collection,this.__options,t)},e.prototype.__fetchLink=function(e){if(!this.__cache[e]){var t=this.links&&e in this.links?this.links[e]:null;t&&(this.__cache[e]=fetchLink(t,this.__collection,this.requestHeaders,this.__options,this.views))}return this.__cache[e]},__decorate([mobx.action],e.prototype,"replaceData",null),e}(),config={baseUrl:"/",cache:isBrowser,defaultFetchOptions:{headers:{"content-type":"application/vnd.api+json"}},fetchReference:isBrowser&&"fetch"in window&&window.fetch.bind(window),paramArrayType:exports.ParamArrayType.COMMA_SEPARATED,baseFetch:function(e,t,r,o){var n,a,i,s=this,d=Promise.resolve(),c=e.toUpperCase(),l="GET"!==c&&"HEAD"!==c;return d.then(function(){var n=config.defaultFetchOptions.headers||{},a=Object.assign({},n,o),i=Object.assign({},config.defaultFetchOptions,{body:l&&JSON.stringify(r)||void 0,headers:a,method:e});return s.fetchReference(t,i)}).then(function(e){return a=e.status,i=e.headers,e.json()}).catch(function(e){if(204===a)return null;throw e}).then(function(e){if(n=e,a>=400)throw{message:"Invalid HTTP status: "+a,status:a};return{data:n,headers:i,requestHeaders:o,status:a}}).catch(function(e){return s.onError({data:n,error:e,headers:i,requestHeaders:o,status:a})})},onError:function(e){return e},transformRequest:function(e){return e},transformResponse:function(e){return e}};function collectionFetch(e){var t=config.transformRequest(e),r=t.url,o=t.options,n=t.data,a=t.method,i=void 0===a?"GET":a,s=t.collection,d=t.views,c=s&&s.constructor,l=c&&c.cache,u="GET"===i.toUpperCase(),p=e.options&&e.options.skipCache;if(config.cache&&u&&l&&!p){var f=getCache(r);if(f)return Promise.resolve(f.response)}return config.baseFetch(i,r,n,o&&o.headers).then(function(e){var t=Object.assign(e,{collection:s}),n=new Response(config.transformResponse(t),s,o,void 0,d);return config.cache&&u&&saveCache(r,n),n})}function fetch(e){return collectionFetch(e)}function read(e,t,r,o,n){return collectionFetch({collection:t,data:void 0,method:"GET",options:__assign({},o,{headers:r}),url:e,views:n})}function create(e,t,r,o,n,a){return collectionFetch({collection:r,data:t,method:"POST",options:__assign({},n,{headers:o}),url:e,views:a})}function update(e,t,r,o,n,a){return collectionFetch({collection:r,data:t,method:"PATCH",options:__assign({},n,{headers:o}),url:e,views:a})}function remove(e,t,r,o,n){return collectionFetch({collection:t,data:void 0,method:"DELETE",options:__assign({},o,{headers:r}),url:e,views:n})}function fetchLink(e,t,r,o,n){if(e){var a="object"==typeof e?e.href:e;if(a)return read(a,t,r,o,n)}return Promise.resolve(new Response({data:void 0},t))}function handleResponse(e,t){return mobx.action(function(r){if(r.error)throw r.error;if(204===r.status)return datx.setModelMetaKey(e,MODEL_PERSISTED_FIELD,!0),e;if(202===r.status){var o=r.data;return datx.setModelMetaKey(o,MODEL_PROP_FIELD,t),datx.setModelMetaKey(o,MODEL_QUEUE_FIELD,!0),datx.setModelMetaKey(o,MODEL_RELATED_FIELD,e),o}return datx.setModelMetaKey(e,MODEL_PERSISTED_FIELD,!0),r.replaceData(e).data})}function flattenModel(e){if(!e)return null;var t,r,o=((t={})[datxUtils.META_FIELD]=((r={fields:Object.keys(e.attributes),id:e.id})[MODEL_LINKS_FIELD]=e.links,r[MODEL_META_FIELD]=e.meta,r[MODEL_PERSISTED_FIELD]=Boolean(e.id),r.refs={},r.type=e.type,r),t);if(e.relationships){var n={},a={},i={};Object.keys(e.relationships).forEach(function(t){var r=e.relationships[t];"data"in r&&r.data&&(!(r.data instanceof Array)||r.data.length>0)&&(o[t]=datxUtils.mapItems(r.data,function(e){return e.id}),i[t]={model:r.data instanceof Array?r.data[0].type:r.data.type,type:r.data instanceof Array?datx.ReferenceType.TO_MANY:datx.ReferenceType.TO_ONE}),"links"in r&&(n[t]=r.links),"meta"in r&&(a[t]=r.meta)}),o[datxUtils.META_FIELD].refs=i,o[datxUtils.META_FIELD][MODEL_REF_LINKS_FIELD]=n,o[datxUtils.META_FIELD][MODEL_REF_META_FIELD]=a}return Object.assign(o,e.attributes)}function getModelMeta(e){return datx.getModelMetaKey(e,MODEL_META_FIELD)}function getModelLinks(e){return datx.getModelMetaKey(e,MODEL_LINKS_FIELD)}function fetchModelLink(e,t,r,o){return __awaiter(this,void 0,void 0,function(){var n,a,i,s;return __generator(this,function(d){if(n=datx.getModelCollection(e),a=getModelLinks(e),!(t in a))throw new Error("Link "+t+" doesn't exist on the model");return i=a[t],s=fetchLink(i,n,r,o),datx.getModelMetaKey(e,MODEL_QUEUE_FIELD)?[2,s.then(function(t){var r=datx.getModelMetaKey(e,MODEL_RELATED_FIELD),o=datx.getModelMetaKey(e,MODEL_PROP_FIELD),n=t.data,a=n&&datx.getModelType(n);return n&&a!==datx.getModelType(e)&&a===datx.getModelType(r)?o?(r[o]=n,t):(datx.setModelMetaKey(r,MODEL_PERSISTED_FIELD,!0),t.replaceData(r)):t})]:[2,s]})})}function getLink(e,t,r){if(!datx.getModelCollection(e))throw new Error("The model needs to be in a collection");var o=getModelRefLinks(e);if(!(t in o))throw new Error("The reference "+t+" doesn't have any links");var n=o[t];if(!(r in n))throw new Error("Link "+r+" doesn't exist on the model");return n[r]}function fetchModelRefLink(e,t,r,o,n){return __awaiter(this,void 0,void 0,function(){var a;return __generator(this,function(i){return a=datx.getModelCollection(e),[2,fetchLink(getLink(e,t,r),a,o,n)]})})}function getModelRefLinks(e){return datx.getModelMetaKey(e,MODEL_REF_LINKS_FIELD)}function getModelRefMeta(e){return datx.getModelMetaKey(e,MODEL_REF_META_FIELD)}function isModelPersisted(e){return datx.getModelMetaKey(e,MODEL_PERSISTED_FIELD)}function setModelPersisted(e,t){datx.setModelMetaKey(e,MODEL_PERSISTED_FIELD,t)}function modelToJsonApi(e){var t=e.constructor,r=datx.modelToJSON(e),o=t.useAutogeneratedIds,n={attributes:r,id:isModelPersisted(e)||o?datx.getModelId(e):void 0,type:datx.getModelType(e)},a=datx.getModelMetaKey(e,"refs");return Object.keys(a).forEach(function(t){n.relationships=n.relationships||{};var r,o=datx.getRefId(e,t);if(o instanceof Array||mobx.isObservableArray(o))r=o.map(function(r,o){return{id:r,type:e[t][o]?datx.getModelType(e[t][o]):a[t].model}});else{var i=e[t]?datx.getModelType(e[t]):a[t].model;r=o?{id:o,type:i}:void 0}n.relationships[t]={data:r},delete n.attributes[t]}),delete n.attributes.id,delete n.attributes[datxUtils.META_FIELD],n}function getModelEndpointUrl(e){var t=e.constructor,r=getModelLinks(e);if(r&&r.self){var o=r.self;return"string"==typeof o?o:o.href}var n=getValue(t.endpoint)||datx.getModelType(e);return isModelPersisted(e)?""+config.baseUrl+n+"/"+datx.getModelId(e):""+config.baseUrl+n}function saveModel(e,t){var r=datx.getModelCollection(e),o=modelToJsonApi(e);return(isModelPersisted(e)?update:create)(getModelEndpointUrl(e),{data:o},r,t&&t.headers).then(handleResponse(e)).then(function(t){return clearCacheByType(datx.getModelType(e)),t})}function removeModel(e,t){var r=datx.getModelCollection(e),o=isModelPersisted(e),n=getModelEndpointUrl(e);return o?remove(n,r,t&&t.headers).then(function(t){if(t.error)throw t.error;setModelPersisted(e,!1),r&&r.remove(e)}):(r&&r.remove(e),Promise.resolve())}function saveRelationship(e,t,r){var o=datx.getModelCollection(e),n=getLink(e,t,"self"),a="object"==typeof n?n.href:n,i=datx.getRefId(e,t),s=datx.getModelType(datx.getModelMetaKey(e,"refs")[t].model);return update(a,{data:datxUtils.mapItems(i,function(e){return{id:e,type:s}})},o,r&&r.headers).then(handleResponse(e,t))}function decorateModel(e){return function(t){function r(e,r){void 0===e&&(e={});var o=e;return"type"in e&&("attributes"in e||"relationships"in e)&&(o=flattenModel(e)),t.call(this,o,r)||this}return __extends(r,t),r.prototype.save=function(e){return saveModel(this,e)},r.prototype.destroy=function(e){return removeModel(this,e)},r.useAutogeneratedIds=e.useAutogeneratedIds||!1,r}(e)}var DecoratedModel=decorateModel(datx.PureModel),GenericModel=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t}(DecoratedModel);function decorateCollection(e){return function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return __extends(r,t),r.prototype.sync=function(e){var t=this;if(!e)return null;var r=this.__iterateEntries(e,function(e){return t.__addRecord(e)});return this.__iterateEntries(e,this.__updateRelationships.bind(this)),r},r.prototype.fetch=function(e,t,r){var o=this,n=datx.getModelType(e),a=this.__prepareQuery(n,t,void 0,r);return read(a.url,this,a.headers,r).then(function(e){return o.__handleErrors(e)})},r.prototype.fetchAll=function(e,t){var r=this,o=datx.getModelType(e),n=this.__prepareQuery(o,void 0,void 0,t);return read(n.url,this,n.headers,t).then(function(e){return r.__handleErrors(e)})},r.prototype.request=function(e,t,r,o){return void 0===t&&(t="GET"),fetch({url:this.__buildUrl(e,r,o).url,options:o,data:r,method:t,collection:this})},r.prototype.remove=function(e,r,o){var n="boolean"==typeof r||"object"==typeof r?r:o,a="boolean"!=typeof r&&"object"!=typeof r?r:void 0,i=datx.getModelType(e),s=this.find(i,a);return s&&n?removeModel(s,"object"==typeof n?n:void 0):(s&&t.prototype.remove.call(this,s),clearCacheByType(i),Promise.resolve())},r.prototype.removeAll=function(e){t.prototype.removeAll.call(this,e),clearCacheByType(datx.getModelType(e))},r.prototype.reset=function(){t.prototype.reset.call(this),clearAllCache()},r.prototype.__handleErrors=function(e){if(e.error)throw e.error;return e},r.prototype.__addRecord=function(e){var t=this.constructor,r=e.type,o=e.id,n=this.find(r,o),a=flattenModel(e);return n?datx.updateModel(n,a):n=t.types.filter(function(e){return e.type===r}).length?this.add(a,r):this.add(new GenericModel(a)),n},r.prototype.__updateRelationships=function(e){var t=this,r=this.find(e.type,e.id);(e.relationships?Object.keys(e.relationships):[]).forEach(function(o){var n=e.relationships[o].data;if(!(n instanceof Array&&n.length<1)&&n&&r){var a=datxUtils.mapItems(n,function(e){return t.find(e.type,e.id)||e.id})||null,i=n instanceof Array?n[0].type:n.type;o in r?r[o]=a:datx.initModelRef(r,o,{model:i,type:datx.ReferenceType.TO_ONE_OR_MANY},a)}})},r.prototype.__iterateEntries=function(e,t){return datxUtils.mapItems(e&&e.included||[],t),datxUtils.mapItems(e&&e.data||[],t)},r.prototype.__prepareQuery=function(e,t,r,o){var n=this.constructor.types.filter(function(t){return t.type===e})[0],a=n?getValue(n.endpoint)||n.baseUrl||datx.getModelType(n):e,i=t?a+"/"+t:""+a;return this.__buildUrl(i,r,o)},r.prototype.__buildUrl=function(e,t,r){var o=r&&r.headers||{},n=this.__prepareFilters(r&&r.filter||{}).concat(this.__prepareSort(r&&r.sort),this.__prepareIncludes(r&&r.include),this.__prepareFields(r&&r.fields||{}),this.__prepareRawParams(r&&r.params||[]));return{data:t,headers:o,url:this.__appendParams(this.__prefixUrl(e),n)}},r.prototype.__prepareFilters=function(e){return this.__parametrize(e).map(function(e){return"filter["+e.key+"]="+e.value})},r.prototype.__prepareSort=function(e){return e?["sort="+e]:[]},r.prototype.__prepareIncludes=function(e){return e?["include="+e]:[]},r.prototype.__prepareFields=function(e){var t=[];return Object.keys(e).forEach(function(r){t.push("fields["+r+"]="+e[r])}),t},r.prototype.__prepareRawParams=function(e){return e.map(function(e){return"string"==typeof e?e:e.key+"="+e.value})},r.prototype.__prefixUrl=function(e){return URL_REGEX.test(e)?e:""+config.baseUrl+e},r.prototype.__appendParams=function(e,t){var r=e;t.length&&(r+=(-1===r.indexOf("?")?"?":"&")+t.join("&"));return r},r.prototype.__parametrize=function(e,t){var r=this;void 0===t&&(t="");var o=[];return Object.keys(e).forEach(function(n){e[n]instanceof Array?config.paramArrayType===exports.ParamArrayType.OBJECT_PATH?o.push.apply(o,r.__parametrize(e[n],n+".")):config.paramArrayType===exports.ParamArrayType.COMMA_SEPARATED?o.push({key:""+t+n,value:e[n].join(",")}):config.paramArrayType===exports.ParamArrayType.MULTIPLE_PARAMS?o.push.apply(o,e[n].map(function(e){return{key:""+t+n,value:e}})):config.paramArrayType===exports.ParamArrayType.PARAM_ARRAY&&o.push.apply(o,e[n].map(function(e){return{key:""+t+n+"][",value:e}})):"object"==typeof e[n]?o.push.apply(o,r.__parametrize(e[n],n+".")):o.push({key:""+t+n,value:e[n]})}),o},r.types=e.types&&e.types.length?e.types.concat(GenericModel):[GenericModel],r.cache=void 0===e.cache?isBrowser:e.cache,r.defaultModel=e.defaultModel||GenericModel,__decorate([mobx.action],r.prototype,"sync",null),__decorate([mobx.action],r.prototype,"remove",null),__decorate([mobx.action],r.prototype,"removeAll",null),__decorate([mobx.action],r.prototype,"reset",null),r}(e)}function decorateView(e){return function(e){function t(t,r,o,n,a){void 0===n&&(n=[]),void 0===a&&(a=!1);var i=e.call(this,t,r,o,n,a)||this;return i.__collection=r,i}return __extends(t,e),t.prototype.sync=function(e){var t=this.__collection.sync(e);return t&&this.add(t),t},t.prototype.fetch=function(e,t){return this.__collection.fetch(this.modelType,e,t).then(this.__addFromResponse.bind(this))},t.prototype.fetchAll=function(e){return this.__collection.fetchAll(this.modelType,e).then(this.__addFromResponse.bind(this))},t.prototype.__addFromResponse=function(e){return e.data&&this.add(e.data),e.views.push(this),e},t}(e)}function jsonapi(e){if(datx.isModel(e))return decorateModel(e);if(datx.isCollection(e))return decorateCollection(e);if(datx.isView(e))return decorateView(e);throw new Error("The instance needs to be a model, collection or a view")}exports.jsonapi=jsonapi,exports.Response=Response,exports.config=config,exports.GenericModel=GenericModel,exports.fetchModelLink=fetchModelLink,exports.fetchModelRefLink=fetchModelRefLink,exports.getModelLinks=getModelLinks,exports.getModelMeta=getModelMeta,exports.getModelRefLinks=getModelRefLinks,exports.getModelRefMeta=getModelRefMeta,exports.modelToJsonApi=modelToJsonApi,exports.saveModel=saveModel,exports.saveRelationship=saveRelationship,exports.clearAllCache=clearAllCache,exports.clearCacheByType=clearCacheByType;
