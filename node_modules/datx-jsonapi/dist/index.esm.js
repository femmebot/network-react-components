import{getModelType,getModelId,modelToJSON,updateModel,updateModelId,setModelMetaKey,getModelCollection,getModelMetaKey,getRefId,ReferenceType,PureModel,initModelRef,isCollection,isModel,isView}from"datx";import{assignComputed,mapItems,META_FIELD}from"datx-utils";import{action,isObservableArray}from"mobx";var extendStatics=function(e,t){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function __extends(e,t){function r(){this.constructor=e}extendStatics(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var __assign=function(){return(__assign=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function __decorate(e,t,r,n){var o,i=arguments.length,a=i<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(o=e[s])&&(a=(i<3?o(a):i>3?o(t,r,a):o(t,r))||a);return i>3&&a&&Object.defineProperty(t,r,a),a}function __awaiter(e,t,r,n){return new(r||(r=Promise))(function(o,i){function a(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){e.done?o(e.value):new r(function(t){t(e.value)}).then(a,s)}c((n=n.apply(e,t||[])).next())})}function __generator(e,t){var r,n,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,n=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=(o=a.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}var cacheStorage=[];function saveCache(e,t,r){if("data"in t&&(!("error"in t)||!t.error)&&t.data){var n=r||getModelType(t.data instanceof Array?t.data[0]:t.data);cacheStorage.push({response:t,time:new Date,type:n,url:e})}}function getCache(e){return cacheStorage.find(function(t){return t.url===e})}function clearAllCache(){cacheStorage.length=0}function clearCacheByType(e){cacheStorage=cacheStorage.filter(function(t){return t.type!==e})}var ParamArrayType,MODEL_LINKS_FIELD="jsonapiLinks",MODEL_REF_LINKS_FIELD="jsonapiRefLinks",MODEL_REF_META_FIELD="jsonapiRefMeta",MODEL_META_FIELD="jsonapiMeta",MODEL_PERSISTED_FIELD="jsonapiPersisted",MODEL_PROP_FIELD="jsonapiProp",MODEL_QUEUE_FIELD="jsonapiQueue",MODEL_RELATED_FIELD="jsonapiRelated",URL_REGEX=/^(?:http(s)?:\/\/)[\w.-]+(?:\.[\w\.-]+)+[\w\-\._~:/?#[\]@!\$&'\(\)\*\+,;=.]+$/;!function(e){e[e.MULTIPLE_PARAMS=0]="MULTIPLE_PARAMS",e[e.COMMA_SEPARATED=1]="COMMA_SEPARATED",e[e.PARAM_ARRAY=2]="PARAM_ARRAY",e[e.OBJECT_PATH=3]="OBJECT_PATH"}(ParamArrayType||(ParamArrayType={}));var isBrowser="undefined"!=typeof window;function getValue(e){return"function"==typeof e?e():e}var Response=function(){function e(e,t,r,n,o){var i=this;if(this.data=null,this.views=[],this.__cache={},this.__collection=t,this.__options=r,this.__response=e,this.status=e.status,o&&(this.views=o),t)this.data=n?t.add(n):t.sync(e.data);else if(e.data){var a=e.data;if(a.data){if(a.data instanceof Array)throw new Error("A save/remove operation should not return an array of results");this.data=n||new GenericModel(flattenModel(a.data))}}if(this.views.forEach(function(e){i.data&&e.add(i.data)}),this.meta=e.data&&e.data.meta||{},this.links=e.data&&e.data.links||{},this.jsonapi=e.data&&e.data.jsonapi||{},this.headers=e.headers,this.requestHeaders=e.requestHeaders,this.error=e.data&&e.data.errors||e.error,this.links&&Object.keys(this.links).forEach(function(e){assignComputed(i,e,function(){return i.__fetchLink(e)})}),Object.freeze(this),this.error)throw this}return e.prototype.replaceData=function(t){var r=this.data;if(r===t)return this;getModelId(t);var n=getModelId(r),o=(getModelType(r),this.views.map(function(e){return e.list.indexOf(r)}));return this.__collection&&(this.__collection.remove(r),this.__collection.add(t)),updateModel(t,modelToJSON(r)),updateModelId(t,n),this.views.forEach(function(e,r){-1!==o[r]&&(e.list[o[r]]=t)}),new e(this.__response,this.__collection,this.__options,t)},e.prototype.__fetchLink=function(e){if(!this.__cache[e]){var t=this.links&&e in this.links?this.links[e]:null;t&&(this.__cache[e]=fetchLink(t,this.__collection,this.requestHeaders,this.__options,this.views))}return this.__cache[e]},__decorate([action],e.prototype,"replaceData",null),e}(),config={baseUrl:"/",cache:isBrowser,defaultFetchOptions:{headers:{"content-type":"application/vnd.api+json"}},fetchReference:isBrowser&&"fetch"in window&&window.fetch.bind(window),paramArrayType:ParamArrayType.COMMA_SEPARATED,baseFetch:function(e,t,r,n){var o,i,a,s=this,c=Promise.resolve(),l=e.toUpperCase(),d="GET"!==l&&"HEAD"!==l;return c.then(function(){var o=config.defaultFetchOptions.headers||{},i=Object.assign({},o,n),a=Object.assign({},config.defaultFetchOptions,{body:d&&JSON.stringify(r)||void 0,headers:i,method:e});return s.fetchReference(t,a)}).then(function(e){return i=e.status,a=e.headers,e.json()}).catch(function(e){if(204===i)return null;throw e}).then(function(e){if(o=e,i>=400)throw{message:"Invalid HTTP status: "+i,status:i};return{data:o,headers:a,requestHeaders:n,status:i}}).catch(function(e){return s.onError({data:o,error:e,headers:a,requestHeaders:n,status:i})})},onError:function(e){return e},transformRequest:function(e){return e},transformResponse:function(e){return e}};function collectionFetch(e){var t=config.transformRequest(e),r=t.url,n=t.options,o=t.data,i=t.method,a=void 0===i?"GET":i,s=t.collection,c=t.views,l=s&&s.constructor,d=l&&l.cache,u="GET"===a.toUpperCase(),p=e.options&&e.options.skipCache;if(config.cache&&u&&d&&!p){var f=getCache(r);if(f)return Promise.resolve(f.response)}return config.baseFetch(a,r,o,n&&n.headers).then(function(e){var t=Object.assign(e,{collection:s}),o=new Response(config.transformResponse(t),s,n,void 0,c);return config.cache&&u&&saveCache(r,o),o})}function fetch(e){return collectionFetch(e)}function read(e,t,r,n,o){return collectionFetch({collection:t,data:void 0,method:"GET",options:__assign({},n,{headers:r}),url:e,views:o})}function create(e,t,r,n,o,i){return collectionFetch({collection:r,data:t,method:"POST",options:__assign({},o,{headers:n}),url:e,views:i})}function update(e,t,r,n,o,i){return collectionFetch({collection:r,data:t,method:"PATCH",options:__assign({},o,{headers:n}),url:e,views:i})}function remove(e,t,r,n,o){return collectionFetch({collection:t,data:void 0,method:"DELETE",options:__assign({},n,{headers:r}),url:e,views:o})}function fetchLink(e,t,r,n,o){if(e){var i="object"==typeof e?e.href:e;if(i)return read(i,t,r,n,o)}return Promise.resolve(new Response({data:void 0},t))}function handleResponse(e,t){return action(function(r){if(r.error)throw r.error;if(204===r.status)return setModelMetaKey(e,MODEL_PERSISTED_FIELD,!0),e;if(202===r.status){var n=r.data;return setModelMetaKey(n,MODEL_PROP_FIELD,t),setModelMetaKey(n,MODEL_QUEUE_FIELD,!0),setModelMetaKey(n,MODEL_RELATED_FIELD,e),n}return setModelMetaKey(e,MODEL_PERSISTED_FIELD,!0),r.replaceData(e).data})}function flattenModel(e){if(!e)return null;var t,r,n=((t={})[META_FIELD]=((r={fields:Object.keys(e.attributes),id:e.id})[MODEL_LINKS_FIELD]=e.links,r[MODEL_META_FIELD]=e.meta,r[MODEL_PERSISTED_FIELD]=Boolean(e.id),r.refs={},r.type=e.type,r),t);if(e.relationships){var o={},i={},a={};Object.keys(e.relationships).forEach(function(t){var r=e.relationships[t];"data"in r&&r.data&&(!(r.data instanceof Array)||r.data.length>0)&&(n[t]=mapItems(r.data,function(e){return e.id}),a[t]={model:r.data instanceof Array?r.data[0].type:r.data.type,type:r.data instanceof Array?ReferenceType.TO_MANY:ReferenceType.TO_ONE}),"links"in r&&(o[t]=r.links),"meta"in r&&(i[t]=r.meta)}),n[META_FIELD].refs=a,n[META_FIELD][MODEL_REF_LINKS_FIELD]=o,n[META_FIELD][MODEL_REF_META_FIELD]=i}return Object.assign(n,e.attributes)}function getModelMeta(e){return getModelMetaKey(e,MODEL_META_FIELD)}function getModelLinks(e){return getModelMetaKey(e,MODEL_LINKS_FIELD)}function fetchModelLink(e,t,r,n){return __awaiter(this,void 0,void 0,function(){var o,i,a,s;return __generator(this,function(c){if(o=getModelCollection(e),i=getModelLinks(e),!(t in i))throw new Error("Link "+t+" doesn't exist on the model");return a=i[t],s=fetchLink(a,o,r,n),getModelMetaKey(e,MODEL_QUEUE_FIELD)?[2,s.then(function(t){var r=getModelMetaKey(e,MODEL_RELATED_FIELD),n=getModelMetaKey(e,MODEL_PROP_FIELD),o=t.data,i=o&&getModelType(o);return o&&i!==getModelType(e)&&i===getModelType(r)?n?(r[n]=o,t):(setModelMetaKey(r,MODEL_PERSISTED_FIELD,!0),t.replaceData(r)):t})]:[2,s]})})}function getLink(e,t,r){if(!getModelCollection(e))throw new Error("The model needs to be in a collection");var n=getModelRefLinks(e);if(!(t in n))throw new Error("The reference "+t+" doesn't have any links");var o=n[t];if(!(r in o))throw new Error("Link "+r+" doesn't exist on the model");return o[r]}function fetchModelRefLink(e,t,r,n,o){return __awaiter(this,void 0,void 0,function(){var i;return __generator(this,function(a){return i=getModelCollection(e),[2,fetchLink(getLink(e,t,r),i,n,o)]})})}function getModelRefLinks(e){return getModelMetaKey(e,MODEL_REF_LINKS_FIELD)}function getModelRefMeta(e){return getModelMetaKey(e,MODEL_REF_META_FIELD)}function isModelPersisted(e){return getModelMetaKey(e,MODEL_PERSISTED_FIELD)}function setModelPersisted(e,t){setModelMetaKey(e,MODEL_PERSISTED_FIELD,t)}function modelToJsonApi(e){var t=e.constructor,r=modelToJSON(e),n=t.useAutogeneratedIds,o={attributes:r,id:isModelPersisted(e)||n?getModelId(e):void 0,type:getModelType(e)},i=getModelMetaKey(e,"refs");return Object.keys(i).forEach(function(t){o.relationships=o.relationships||{};var r,n=getRefId(e,t);if(n instanceof Array||isObservableArray(n))r=n.map(function(r,n){return{id:r,type:e[t][n]?getModelType(e[t][n]):i[t].model}});else{var a=e[t]?getModelType(e[t]):i[t].model;r=n?{id:n,type:a}:void 0}o.relationships[t]={data:r},delete o.attributes[t]}),delete o.attributes.id,delete o.attributes[META_FIELD],o}function getModelEndpointUrl(e){var t=e.constructor,r=getModelLinks(e);if(r&&r.self){var n=r.self;return"string"==typeof n?n:n.href}var o=getValue(t.endpoint)||getModelType(e);return isModelPersisted(e)?""+config.baseUrl+o+"/"+getModelId(e):""+config.baseUrl+o}function saveModel(e,t){var r=getModelCollection(e),n=modelToJsonApi(e);return(isModelPersisted(e)?update:create)(getModelEndpointUrl(e),{data:n},r,t&&t.headers).then(handleResponse(e)).then(function(t){return clearCacheByType(getModelType(e)),t})}function removeModel(e,t){var r=getModelCollection(e),n=isModelPersisted(e),o=getModelEndpointUrl(e);return n?remove(o,r,t&&t.headers).then(function(t){if(t.error)throw t.error;setModelPersisted(e,!1),r&&r.remove(e)}):(r&&r.remove(e),Promise.resolve())}function saveRelationship(e,t,r){var n=getModelCollection(e),o=getLink(e,t,"self"),i="object"==typeof o?o.href:o,a=getRefId(e,t),s=getModelType(getModelMetaKey(e,"refs")[t].model);return update(i,{data:mapItems(a,function(e){return{id:e,type:s}})},n,r&&r.headers).then(handleResponse(e,t))}function decorateModel(e){return function(t){function r(e,r){void 0===e&&(e={});var n=e;return"type"in e&&("attributes"in e||"relationships"in e)&&(n=flattenModel(e)),t.call(this,n,r)||this}return __extends(r,t),r.prototype.save=function(e){return saveModel(this,e)},r.prototype.destroy=function(e){return removeModel(this,e)},r.useAutogeneratedIds=e.useAutogeneratedIds||!1,r}(e)}var DecoratedModel=decorateModel(PureModel),GenericModel=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t}(DecoratedModel);function decorateCollection(e){return function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return __extends(r,t),r.prototype.sync=function(e){var t=this;if(!e)return null;var r=this.__iterateEntries(e,function(e){return t.__addRecord(e)});return this.__iterateEntries(e,this.__updateRelationships.bind(this)),r},r.prototype.fetch=function(e,t,r){var n=this,o=getModelType(e),i=this.__prepareQuery(o,t,void 0,r);return read(i.url,this,i.headers,r).then(function(e){return n.__handleErrors(e)})},r.prototype.fetchAll=function(e,t){var r=this,n=getModelType(e),o=this.__prepareQuery(n,void 0,void 0,t);return read(o.url,this,o.headers,t).then(function(e){return r.__handleErrors(e)})},r.prototype.request=function(e,t,r,n){return void 0===t&&(t="GET"),fetch({url:this.__buildUrl(e,r,n).url,options:n,data:r,method:t,collection:this})},r.prototype.remove=function(e,r,n){var o="boolean"==typeof r||"object"==typeof r?r:n,i="boolean"!=typeof r&&"object"!=typeof r?r:void 0,a=getModelType(e),s=this.find(a,i);return s&&o?removeModel(s,"object"==typeof o?o:void 0):(s&&t.prototype.remove.call(this,s),clearCacheByType(a),Promise.resolve())},r.prototype.removeAll=function(e){t.prototype.removeAll.call(this,e),clearCacheByType(getModelType(e))},r.prototype.reset=function(){t.prototype.reset.call(this),clearAllCache()},r.prototype.__handleErrors=function(e){if(e.error)throw e.error;return e},r.prototype.__addRecord=function(e){var t=this.constructor,r=e.type,n=e.id,o=this.find(r,n),i=flattenModel(e);return o?updateModel(o,i):o=t.types.filter(function(e){return e.type===r}).length?this.add(i,r):this.add(new GenericModel(i)),o},r.prototype.__updateRelationships=function(e){var t=this,r=this.find(e.type,e.id);(e.relationships?Object.keys(e.relationships):[]).forEach(function(n){var o=e.relationships[n].data;if(!(o instanceof Array&&o.length<1)&&o&&r){var i=mapItems(o,function(e){return t.find(e.type,e.id)||e.id})||null,a=o instanceof Array?o[0].type:o.type;n in r?r[n]=i:initModelRef(r,n,{model:a,type:ReferenceType.TO_ONE_OR_MANY},i)}})},r.prototype.__iterateEntries=function(e,t){return mapItems(e&&e.included||[],t),mapItems(e&&e.data||[],t)},r.prototype.__prepareQuery=function(e,t,r,n){var o=this.constructor.types.filter(function(t){return t.type===e})[0],i=o?getValue(o.endpoint)||o.baseUrl||getModelType(o):e,a=t?i+"/"+t:""+i;return this.__buildUrl(a,r,n)},r.prototype.__buildUrl=function(e,t,r){var n=r&&r.headers||{},o=this.__prepareFilters(r&&r.filter||{}).concat(this.__prepareSort(r&&r.sort),this.__prepareIncludes(r&&r.include),this.__prepareFields(r&&r.fields||{}),this.__prepareRawParams(r&&r.params||[]));return{data:t,headers:n,url:this.__appendParams(this.__prefixUrl(e),o)}},r.prototype.__prepareFilters=function(e){return this.__parametrize(e).map(function(e){return"filter["+e.key+"]="+e.value})},r.prototype.__prepareSort=function(e){return e?["sort="+e]:[]},r.prototype.__prepareIncludes=function(e){return e?["include="+e]:[]},r.prototype.__prepareFields=function(e){var t=[];return Object.keys(e).forEach(function(r){t.push("fields["+r+"]="+e[r])}),t},r.prototype.__prepareRawParams=function(e){return e.map(function(e){return"string"==typeof e?e:e.key+"="+e.value})},r.prototype.__prefixUrl=function(e){return URL_REGEX.test(e)?e:""+config.baseUrl+e},r.prototype.__appendParams=function(e,t){var r=e;t.length&&(r+=(-1===r.indexOf("?")?"?":"&")+t.join("&"));return r},r.prototype.__parametrize=function(e,t){var r=this;void 0===t&&(t="");var n=[];return Object.keys(e).forEach(function(o){e[o]instanceof Array?config.paramArrayType===ParamArrayType.OBJECT_PATH?n.push.apply(n,r.__parametrize(e[o],o+".")):config.paramArrayType===ParamArrayType.COMMA_SEPARATED?n.push({key:""+t+o,value:e[o].join(",")}):config.paramArrayType===ParamArrayType.MULTIPLE_PARAMS?n.push.apply(n,e[o].map(function(e){return{key:""+t+o,value:e}})):config.paramArrayType===ParamArrayType.PARAM_ARRAY&&n.push.apply(n,e[o].map(function(e){return{key:""+t+o+"][",value:e}})):"object"==typeof e[o]?n.push.apply(n,r.__parametrize(e[o],o+".")):n.push({key:""+t+o,value:e[o]})}),n},r.types=e.types&&e.types.length?e.types.concat(GenericModel):[GenericModel],r.cache=void 0===e.cache?isBrowser:e.cache,r.defaultModel=e.defaultModel||GenericModel,__decorate([action],r.prototype,"sync",null),__decorate([action],r.prototype,"remove",null),__decorate([action],r.prototype,"removeAll",null),__decorate([action],r.prototype,"reset",null),r}(e)}function decorateView(e){return function(e){function t(t,r,n,o,i){void 0===o&&(o=[]),void 0===i&&(i=!1);var a=e.call(this,t,r,n,o,i)||this;return a.__collection=r,a}return __extends(t,e),t.prototype.sync=function(e){var t=this.__collection.sync(e);return t&&this.add(t),t},t.prototype.fetch=function(e,t){return this.__collection.fetch(this.modelType,e,t).then(this.__addFromResponse.bind(this))},t.prototype.fetchAll=function(e){return this.__collection.fetchAll(this.modelType,e).then(this.__addFromResponse.bind(this))},t.prototype.__addFromResponse=function(e){return e.data&&this.add(e.data),e.views.push(this),e},t}(e)}function jsonapi(e){if(isModel(e))return decorateModel(e);if(isCollection(e))return decorateCollection(e);if(isView(e))return decorateView(e);throw new Error("The instance needs to be a model, collection or a view")}export{jsonapi,Response,config,ParamArrayType,GenericModel,fetchModelLink,fetchModelRefLink,getModelLinks,getModelMeta,getModelRefLinks,getModelRefMeta,modelToJsonApi,saveModel,saveRelationship,clearAllCache,clearCacheByType};
