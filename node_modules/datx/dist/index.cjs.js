"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var mobx=require("mobx"),datxUtils=require("datx-utils"),extendStatics=function(e,t){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])})(e,t)};function __extends(e,t){function o(){this.constructor=e}extendStatics(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}function __decorate(e,t,o,r){var n,i=arguments.length,a=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,o,r);else for(var d=e.length-1;d>=0;d--)(n=e[d])&&(a=(i<3?n(a):i>3?n(t,o,a):n(t,o))||a);return i>3&&a&&Object.defineProperty(t,o,a),a}var FieldType,UNDEFINED_TYPE="The type needs to be defined if the object is not an instance of the model.",UNDEFINED_MODEL="No model is defined for the type ${type}.",NOT_A_CLONE="The given model is not a clone.",REF_NEEDS_COLLECTION="The model needs to be in a collection to be referenceable",REF_SINGLE="The reference ${key} can't be an array of values.",REF_ARRAY="The reference ${key} must be an array of values.",NO_REFS="You should save this value as a reference.",BACK_REF_READ_ONLY="Back references are read only",ID_READONLY="Model ID can't be updated directly. Use the `updateModelId` helper function instead.",TYPE_READONLY="Model type can't be changed after initialization.",MODEL_SINGLE_COLLECTION="A model can be in a single collection at once",ID_REQUIRED="Model id is required (autoincrement is disabled)",WRONG_REF_TYPE="The new reference type doesn't match to the declared one.",MODEL_REQUIRED="The model type is a required parameter. Do you maybe have a circular dependency?",SORTED_NO_WRITE="New models can't be added directly to a sorted view list",UNIQUE_MODEL="The models in this view need to be unique",VIEW_NAME_TAKEN="The name is already taken",DECORATE_MODEL="This mixin can only decorate models";!function(e){e[e.ID=0]="ID",e[e.TYPE=1]="TYPE",e[e.DATA=2]="DATA"}(FieldType||(FieldType={})),function(e){e[e.TO_ONE=0]="TO_ONE",e[e.TO_MANY=1]="TO_MANY",e[e.TO_ONE_OR_MANY=2]="TO_ONE_OR_MANY"}(exports.ReferenceType||(exports.ReferenceType={}));var REGEX=/\$\{\s*([a-zA-Z0-9\-\_]+)\s*\}/g;function msg(e,t){for(var o=e,r=REGEX.exec(o);r;)o=o.replace(r[0],t[r[1]]),r=REGEX.exec(o);return o}function error(e,t){return void 0===t&&(t={}),new Error("[datx exception] "+msg(e,t))}function reducePrototypeChain(e,t,o){for(var r=o,n=e;n;)r=t(r,n),n=Object.getPrototypeOf(n);return r}var DataStorage=function(){function e(){this.modelData=new WeakMap,this.modelClassData=new WeakMap}return e.prototype.initModel=function(e){var t=mobx.observable({data:{},meta:{}});return this.modelData.set(e,t),t},e.prototype.getModelData=function(e){return this.__getModelData(e).data},e.prototype.getModelDataKey=function(e,t){return this.__getModelData(e).data[t]},e.prototype.setModelData=function(e,t){var o=this.__getModelData(e);mobx.set(o.data,t)},e.prototype.setModelDataKey=function(e,t,o){var r;this.setModelData(e,((r={})[t]=o,r))},e.prototype.getModelMeta=function(e){return this.modelData.get(e).meta},e.prototype.getModelMetaKey=function(e,t){return this.getModelMeta(e)[t]},e.prototype.setModelMeta=function(e,t){var o=this.__getModelData(e);return mobx.set(o.meta,t),o.meta},e.prototype.setModelMetaKey=function(e,t,o){var r;this.setModelMeta(e,((r={})[t]=o,r))},e.prototype.setModelClassMetaKey=function(e,t,o){var r,n=this.modelClassData.get(e);Object.assign(n.meta,((r={})[t]=o,r))},e.prototype.getModelClassMetaKey=function(e,t){var o=this;return reducePrototypeChain(e,function(e,r){return e||(o.modelClassData.get(r)||{meta:{}}).meta[t]||null},null)},e.prototype.addModelDefaultField=function(e,t,o){var r,n,i=this.modelClassData.get(e);i?Object.assign(i.data,((r={})[t]=o,r)):this.modelClassData.set(e,{data:(n={},n[t]=o,n),meta:{},references:{}})},e.prototype.getModelDefaults=function(e){var t=this,o=reducePrototypeChain(e,function(e,o){return e.concat((t.modelClassData.get(o)||{data:[]}).data)},[]);return Object.assign.apply(Object,[{}].concat(o.reverse()))},e.prototype.addModelClassReference=function(e,t,o){if(!o.model&&0!==o.model)throw error(MODEL_REQUIRED);var r,n,i=this.modelClassData.get(e);i?Object.assign(i.references,((r={})[t]=o,r)):this.modelClassData.set(e,{data:{},meta:{},references:(n={},n[t]=o,n)})},e.prototype.getModelClassReferences=function(e){var t=this,o=reducePrototypeChain(e,function(e,o){return e.concat((t.modelClassData.get(o)||{references:{}}).references)},[]);return Object.assign.apply(Object,[{}].concat(o.reverse()))},e.prototype.getModelReferenceOptions=function(e,t){return this.getModelMetaKey(e,"refs")[t]},e.prototype.__getModelData=function(e){return this.modelData.get(e)||this.initModel(e)},e.prototype.clear=function(){this.modelData=new WeakMap,this.modelClassData=new WeakMap},e}(),storage=new DataStorage;function getModelType(e){return"function"==typeof e?e.type:"object"==typeof e?getModelMetaKey(e,"type")||e.constructor.type:e}function getModelId(e){return e instanceof PureModel?getModelMetaKey(e,"id"):e}function getModelCollection(e){return getModelMetaKey(e,"collection")}function cloneModel(e){var t=e.constructor,o=modelToJSON(e),r=o[datxUtils.META_FIELD]||{};r.originalId=r.id,delete r.id;var n=new t(o),i=getModelCollection(e);return i?i.add(n):datxUtils.warn("The model is not in the collection. Referencing the original model won't be possible"),n}function getOriginalModel(e){var t=getModelCollection(e),o=getModelMetaKey(e,"originalId");if(o){if(!t)throw error(REF_NEEDS_COLLECTION);return t.find(e,o)}throw error(NOT_A_CLONE)}function updateModel(e,t){var o=storage.getModelClassMetaKey(e.constructor,"id")||"id",r=storage.getModelClassMetaKey(e.constructor,"type")||"type";return Object.keys(t instanceof PureModel?modelToJSON(t):t).forEach(function(n){n!==datxUtils.META_FIELD&&n!==o&&n!==r&&assignModel(e,n,t[n])}),e}function assignModel(e,t,o){if(t in getModelMetaKey(e,"refs"))assignModelRef(e,t,o);else{if(o instanceof PureModel)throw error(NO_REFS,{key:t});assignModelField(e,t,o)}}function assignModelField(e,t,o){-1!==getModelMetaKey(e,"fields").indexOf(t)?e[t]=o:initModelField(e,t,o)}function assignModelRef(e,t,o){getModelMetaKey(e,"refs");e[t]=o}function getMetaKeyFromRaw(e,t,o){if(datxUtils.META_FIELD in e&&"object"==typeof e[datxUtils.META_FIELD]&&void 0!==e[datxUtils.META_FIELD])return(e[datxUtils.META_FIELD]||{})[t];if(o){var r=storage.getModelClassMetaKey(o,t);return r&&e[r]}return e&&e[t]}function modelToJSON(e){var t=mobx.toJS(storage.getModelData(e)),o=Object.assign({},storage.getModelMeta(e));delete o.collection;var r=mobx.toJS(o);delete r.collection;var n,i=Object.assign(t,((n={})[datxUtils.META_FIELD]=r,n)),a=e.constructor,d=storage.getModelClassMetaKey(a,"id"),s=storage.getModelClassMetaKey(a,"type");return r&&d&&(i[d]=r.id),r&&s&&(i[s]=r.type),i}function getModelMetaKey(e,t){return storage.getModelMetaKey(e,t)}function setModelMetaKey(e,t,o){storage.setModelMetaKey(e,t,o)}function modelAddReference(e,t,o){var r=storage.getModelReferenceOptions(e,t),n=getModelId(o),i=storage.getModelDataKey(e,t);r.type===exports.ReferenceType.TO_ONE?storage.setModelDataKey(e,t,n):r.type===exports.ReferenceType.TO_MANY||mobx.isObservableArray(i)?i.push(n):storage.setModelDataKey(e,t,o)}function modelRemoveReference(e,t,o){var r=storage.getModelReferenceOptions(e,t),n=getModelId(o),i=storage.getModelDataKey(e,t);r.type===exports.ReferenceType.TO_ONE?storage.setModelDataKey(e,t,null):r.type===exports.ReferenceType.TO_MANY||mobx.isObservableArray(i)?i.remove(n):storage.setModelDataKey(e,t,null)}function ensureModel(e,t){return function(o){var r=o;if(!(o instanceof PureModel)&&"object"==typeof o){if(!t)throw new Error(REF_NEEDS_COLLECTION);r=t.add(o,e.model)}return getModelId(r)}}function partialRefUpdate(e,t,o){var r=storage.getModelReferenceOptions(e,t),n=storage.getModelDataKey(e,t),i=getModelCollection(e);if("splice"===o.type){var a=o.added.map(ensureModel(r,i));return n.splice.apply(n,[o.index,o.removedCount].concat(a)),null}return n[o.index]=ensureModel(r,i)(o.newValue),null}function backRefSplice(e,t,o,r){var n=r.property;return o.added.forEach(function(t){modelAddReference(t,n,e)}),e[t].slice(o.index,o.index+o.removedCount).forEach(function(t){modelRemoveReference(t,n,e)}),null}function backRefChange(e,t,o,r){var n=r.property,i=e[t].length>o.index?e[t][o.index]:null;return o.newValue&&modelAddReference(o.newValue,n,e),i&&modelRemoveReference(i,n,e),datxUtils.warn("This shouldn't have happened. Please open an issue: https://github.com/infinum/datx/issues/new"),null}function partialBackRefUpdate(e,t,o){var r=storage.getModelReferenceOptions(e,t);return"splice"===o.type?backRefSplice(e,t,o,r):backRefChange(e,t,o,r)}function getField(e,t){return storage.getModelDataKey(e,t)}function updateField(e,t,o,r){if(r===FieldType.TYPE)throw error(TYPE_READONLY);if(r===FieldType.ID)throw error(ID_READONLY);t in getModelMetaKey(e,"refs")?updateRef(e,t,o):storage.setModelDataKey(e,t,o)}function hasBackRef(e,t,o){return null!==e[t]&&void 0!==e[t]&&(e[t]instanceof PureModel?e[t]===o:-1!==e[t].indexOf(o))}function getBackRef(e,t,o){var r=getModelType(o.model),n=getModelCollection(e);if(!n)return null;var i=n.findAll(r).filter(function(t){return hasBackRef(t,o.property,e)}),a=mobx.observable.array(i,{deep:!1});return mobx.intercept(a,function(o){return partialBackRefUpdate(e,t,o)}),a}function getNormalRef(e,t,o){var r=storage.getModelDataKey(e,t),n=getModelCollection(e);if(!n)return null;var i=datxUtils.mapItems(r,function(e){return e?n.find(o.model,e):e});if(o.type!==exports.ReferenceType.TO_MANY||i instanceof Array||(i=[i]),i instanceof Array){var a=mobx.observable.array(i,{deep:!1});return mobx.intercept(a,function(o){return partialRefUpdate(e,t,o)}),a}return i}function getRef(e,t){var o=storage.getModelReferenceOptions(e,t);return"string"==typeof o.property?getBackRef(e,t,o):getNormalRef(e,t,o)}function validateRef(e,t,o){if(e.type===exports.ReferenceType.TO_ONE&&t)throw error(REF_SINGLE,{key:o});if(e.type===exports.ReferenceType.TO_MANY&&!t)throw error(REF_ARRAY,{key:o});if(e.property)throw error(BACK_REF_READ_ONLY)}function updateRef(e,t,o){var r=storage.getModelReferenceOptions(e,t),n=r.type===exports.ReferenceType.TO_MANY?o||[]:o,i=n instanceof Array||mobx.isObservableArray(n);validateRef(r,i,t);var a=getModelCollection(e),d=datxUtils.mapItems(o,function(e){if(e&&a){if(e instanceof PureModel)if(getModelType(e)!==getModelType(r.model))throw new Error(WRONG_REF_TYPE);var t=a.find(r.model,e);return t||"object"!=typeof e||(t=a.add(e,r.model)),getModelId(t||e)}if(e instanceof PureModel)throw error(REF_NEEDS_COLLECTION);return e});r.type===exports.ReferenceType.TO_MANY&&(d=d||[]),storage.setModelDataKey(e,t,d)}function getModelRefsByType(e,t){var o=getModelMetaKey(e,"refs");return Object.keys(o).filter(function(e){return!o[e].property}).filter(function(e){return getModelType(o[e].model)===t})}function updateModelReferences(e,t,o,r){var n=getModelCollection(e);if(n)n.getAllModels().map(function(e){getModelRefsByType(e,r).forEach(function(r){var n=storage.getModelDataKey(e,r);if(n instanceof Array||mobx.isObservableArray(n)){var i=n.indexOf(o);-1!==i&&(n[i]=t)}else n===o&&storage.setModelDataKey(e,r,t)})})}function updateModelId(e,t){var o=getModelCollection(e),r=getModelId(e),n=getModelType(e);setModelMetaKey(e,"id",t);var i=e.constructor,a=storage.getModelClassMetaKey(i,"id");a&&setRefId(e,a,t),o&&o.__changeModelId(r,t,n),updateModelReferences(e,t,r,n)}function getRefId(e,t){return storage.getModelDataKey(e,t)}function setRefId(e,t,o){storage.setModelDataKey(e,t,o)}function initModelField(e,t,o,r){void 0===r&&(r=FieldType.DATA);var n=getModelMetaKey(e,"fields");r===FieldType.ID&&t in e&&delete e[t],storage.setModelDataKey(e,t,o),-1===n.indexOf(t)&&n.push(t),datxUtils.assignComputed(e,t,function(){return getField(e,t)},function(o){updateField(e,t,o,r)})}function initModelRef(e,t,o,r){getModelMetaKey(e,"refs")[t]=o;var n=o.type===exports.ReferenceType.TO_MANY;storage.setModelDataKey(e,t,n?[]:void 0),datxUtils.assignComputed(e,t,function(){return getRef(e,t)},function(o){updateRef(e,t,o)}),o.property||void 0===r||(e[t]=r)}function prepareFields(e,t,o){var r=o.constructor,n=t.fields?t.fields.slice():[],i=storage.getModelClassReferences(r),a=Object.assign({},i,t.refs),d=storage.getModelDefaults(r);return Object.keys(e).concat(Object.keys(d)).forEach(function(e){e in a||-1!==n.indexOf(e)||n.push(e)}),{defaults:d,fields:n,refs:a}}function initModelData(e,t,o,r){var n=prepareFields(t,o,e),i=n.defaults,a=n.fields,d=n.refs,s=e.constructor,l=storage.getModelClassMetaKey(s,"id"),c=storage.getModelClassMetaKey(s,"type");a.forEach(function(r){var n=FieldType.DATA,a=t[r];void 0===a&&(a=i[r]),r===(l||"id")?(n=FieldType.ID,a=o.id):r===c&&(n=FieldType.TYPE,a=o.type),initModelField(e,r,a,n)}),!l||l in a||initModelField(e,l,o.id,FieldType.ID),Object.keys(d).forEach(function(o){var n=d[o],a=t[o]||i[o]||void 0,s=r?r.add(a,getModelType(n.model)):a;initModelRef(e,o,n,s)})}function initModelMeta(e,t,o){var r=e.constructor,n=storage.getModelClassMetaKey(r,"id")||"id",i=storage.getModelClassMetaKey(r,"type"),a=i&&t[i]||getModelType(e),d=n&&t[n];if(!d){if(!r.enableAutoId)throw new Error(ID_REQUIRED);for(d=r.getAutoId();o&&o.find(a,d);)d=r.getAutoId()}var s,l={fields:[],id:d,refs:{},type:a},c={fields:[],refs:{}};if(datxUtils.META_FIELD in t&&t[datxUtils.META_FIELD]){var p=t[datxUtils.META_FIELD]||{};c.fields=p.fields,delete p.fields,c.refs=p.refs,delete p.refs,s=storage.setModelMeta(e,Object.assign(l,p)),delete t[datxUtils.META_FIELD]}else s=storage.setModelMeta(e,l);return Object.assign({},s,c)}function initModel(e,t,o){var r=e.constructor,n=Object.assign({},r.preprocess(t,o));setModelMetaKey(e,"collection",o),initModelData(e,n,initModelMeta(e,n,o),o)}var PureModel=function(){function e(e,t){void 0===e&&(e={}),mobx.extendObservable(this,{}),initModel(this,e,t)}return e.preprocess=function(e,t){return e},e.getAutoId=function(){return"number"==typeof this.autoIdValue?--this.autoIdValue:this.autoIdValue},e.toJSON=function(){return this.type},e.type=datxUtils.DEFAULT_TYPE,e.autoIdValue=0,e.enableAutoId=!0,e}();function initCollectionModel(e,t){return upsertModel(t,getMetaKeyFromRaw(t,"type"),e)}function upsertModel(e,t,o){if(!t&&0!==t)throw error(UNDEFINED_TYPE);var r=o.constructor,n=r.types.find(function(e){return e.type===t})||r.defaultModel;if(!n)throw error(UNDEFINED_MODEL,{type:t});var i=getMetaKeyFromRaw(e,"id",n),a=i&&o.find(t,i);return a?updateModel(a,e):new n(e,o)}function isSelectorFunction(e){return"function"==typeof e&&e!==PureModel&&!(e.prototype instanceof PureModel)}function initModels(e,t){return t.map(function(t){return initCollectionModel(e,t)})}var View=function(){function e(e,t,o,r,n){void 0===r&&(r=[]),void 0===n&&(n=!1),this.__collection=t,this.unique=n,this.__models=mobx.observable.array([]),this.__models.replace(r.map(getModelId)),this.sortMethod=o,this.modelType=getModelType(e),this.__collection.__viewList.push(this)}return Object.defineProperty(e.prototype,"length",{get:function(){return this.__models.length},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"list",{get:function(){var e=this,t=this.__models.map(function(t){return e.__collection.find(e.modelType,t)});if(this.sortMethod){var o="string"==typeof this.sortMethod?function(t){return t[e.sortMethod]}:this.sortMethod;t.sort(function(e,t){return(e?o(e):1/0)-(t?o(t):1/0)})}var r=mobx.observable.array(t,{deep:!1});return mobx.intercept(r,this.__partialListUpdate.bind(this)),r},enumerable:!0,configurable:!0}),e.prototype.toJSON=function(){return{modelType:this.modelType,models:this.__models.slice(),unique:this.unique}},Object.defineProperty(e.prototype,"snapshot",{get:function(){return this.toJSON()},enumerable:!0,configurable:!0}),e.prototype.add=function(e){var t=this,o=datxUtils.mapItems(e,function(e){return t.__collection.add(e,t.modelType)});return datxUtils.mapItems(o,function(e){var o=getModelId(e);t.unique&&-1!==t.__models.indexOf(o)||t.__models.push(o)}),o},e.prototype.hasItem=function(e){var t=getModelId(e);return-1!==this.__models.indexOf(t)},e.prototype.remove=function(e){var t=getModelId(e);this.__models.remove(t)},e.prototype.removeAll=function(){this.__models.replace([])},e.prototype.__partialListUpdate=function(e){var t=this;if("splice"===e.type){if(this.sortMethod&&e.added.length>0)throw error(SORTED_NO_WRITE);var o=e.added.map(getModelId),r=this.__models.slice(e.index,e.removedCount);return this.unique&&o.forEach(function(e){if(-1!==t.__models.indexOf(e)&&-1===r.indexOf(e))throw error(UNIQUE_MODEL)}),(n=this.__models).splice.apply(n,[e.index,e.removedCount].concat(o)),null}if(this.sortMethod&&e.newValue)throw error(SORTED_NO_WRITE);var n,i=getModelId(e.newValue),a=this.__models.indexOf(i);if(this.unique&&-1!==a&&a!==e.index)throw error(UNIQUE_MODEL);return this.__models[e.index]=i,null},e.prototype.__changeModelId=function(e,t){var o=this.__models.indexOf(e);-1!==o&&(this.__models[o]=t)},__decorate([mobx.observable],e.prototype,"sortMethod",void 0),__decorate([mobx.computed],e.prototype,"length",null),__decorate([mobx.computed],e.prototype,"list",null),__decorate([mobx.computed],e.prototype,"snapshot",null),__decorate([mobx.action],e.prototype,"add",null),__decorate([mobx.action],e.prototype,"remove",null),__decorate([mobx.action],e.prototype,"removeAll",null),e}(),PureCollection=function(){function e(e){void 0===e&&(e=[]);var t=this;this.__data=mobx.observable.array([],{deep:!1}),this.__views=[],this.__viewList=[],this.__dataMap={},this.__dataList={},mobx.extendObservable(this,{}),e instanceof Array?this.insert(e):e&&"models"in e&&this.insert(e.models);var o=this.constructor,r=e&&"views"in e?e.views:{};Object.keys(o.views).forEach(function(e){var n=o.views[e],i=r[e]||n;t.addView(e,i.modelType,{mixins:n.mixins,models:i.models||[],sortMethod:n.sortMethod,unique:i.unique})})}return e.prototype.insert=function(e){var t=initModels(this,e);return this.__insertModel(t),t},e.prototype.add=function(e,t){return e instanceof Array?this.__addArray(e,t):this.__addSingle(e,t)},e.prototype.find=function(e,t){return t instanceof PureModel?t:isSelectorFunction(e)?this.__data.find(e)||null:this.__findByType(e,t)||null},e.prototype.filter=function(e){return this.__data.filter(e)},e.prototype.findAll=function(e){if(e){var t=getModelType(e);return t in this.__dataList||mobx.set(this.__dataList,((o={})[t]=mobx.observable.array([]),o)),this.__dataList[t]}return this.__data;var o},e.prototype.hasItem=function(e){var t=getModelId(e);return Boolean(this.find(e,t))},e.prototype.remove=function(e,t){var o="object"==typeof e?e:this.find(e,t);o&&this.__removeModel(o)},e.prototype.removeAll=function(e){this.__removeModel(this.findAll(e).slice())},Object.defineProperty(e.prototype,"length",{get:function(){return this.__data.length},enumerable:!0,configurable:!0}),e.prototype.toJSON=function(){var e=this,t={};return this.__views.forEach(function(o){t[o]=e[o].toJSON()}),{models:this.__data.map(modelToJSON),views:t}},Object.defineProperty(e.prototype,"snapshot",{get:function(){return this.toJSON()},enumerable:!0,configurable:!0}),e.prototype.reset=function(){this.__data.forEach(function(e){setModelMetaKey(e,"collection",void 0)}),this.__data.replace([]),this.__dataList=mobx.observable({},{},{deep:!1}),this.__dataMap=mobx.observable({},{},{deep:!1})},e.prototype.getAllModels=function(){return this.__data.slice()},e.prototype.addView=function(e,t,o){var r=void 0===o?{}:o,n=r.sortMethod,i=r.models,a=void 0===i?[]:i,d=r.unique,s=r.mixins;if(e in this)throw error(VIEW_NAME_TAKEN);var l=s?s.reduce(function(e,t){return t(e)},View):View;return this.__views.push(e),this[e]=new l(t,this,n,a,d),this[e]},e.prototype.__addArray=function(e,t){var o=this;return e.filter(Boolean).map(function(e){return o.__addSingle(e,t)})},e.prototype.__addSingle=function(e,t){if(!e||"number"==typeof e||"string"==typeof e)return e;if(e instanceof PureModel)return this.hasItem(e)||this.__insertModel(e),e;if(!t&&0!==t)throw error(UNDEFINED_TYPE);var o=getModelType(t),r=upsertModel(e,o,this);return this.__insertModel(r,o),r},e.prototype.__insertModel=function(e,t,o){var r=this;if(e instanceof Array)e.forEach(function(e){r.__insertModel(e,t,o)});else{var n=getModelCollection(e);if(n&&n!==this)throw error(MODEL_SINGLE_COLLECTION);var i,a=t||getModelType(e),d=o||getModelId(e),s=a.toString(),l=this.find(a,d);if(l)updateModel(l,e);else this.__data.push(e),a in this.__dataList?this.__dataList[a].push(e):mobx.set(this.__dataList,s,mobx.observable.array([e],{deep:!1})),a in this.__dataMap?mobx.set(this.__dataMap[a],d.toString(),e):mobx.set(this.__dataMap,s,mobx.observable.object(((i={})[d]=e,i),{},{deep:!1})),setModelMetaKey(e,"collection",this)}},e.prototype.__removeModel=function(e,t,o){var r=this;if(e instanceof Array)e.forEach(function(e){r.__removeModel(e,t,o)});else{var n=t||getModelType(e),i=o||getModelId(e);this.__data.remove(e),this.__dataList[n].remove(e),mobx.set(this.__dataMap[n],i.toString(),void 0),setModelMetaKey(e,"collection",void 0)}},e.prototype.__findByType=function(e,t){var o,r=getModelType(e),n=r.toString();return t?(r in this.__dataMap?t in this.__dataMap[r]||mobx.set(this.__dataMap[r],t.toString(),void 0):mobx.set(this.__dataMap,n,mobx.observable.object(((o={})[t]=void 0,o),{},{deep:!1})),this.__dataMap[r][t]):(r in this.__dataList||mobx.set(this.__dataList,n,mobx.observable.array([],{deep:!1})),this.__dataList[r].length?this.__dataList[r][0]:null)},e.prototype.__changeModelId=function(e,t,o){this.__dataMap[o][t]=this.__dataMap[o][e],delete this.__dataMap[o][e],this.__viewList.filter(function(e){return e.modelType===o}).forEach(function(o){o.__changeModelId(e,t)})},e.types=[],e.views={},__decorate([mobx.observable.shallow],e.prototype,"__dataMap",void 0),__decorate([mobx.observable.shallow],e.prototype,"__dataList",void 0),__decorate([mobx.action],e.prototype,"insert",null),__decorate([mobx.action],e.prototype,"add",null),__decorate([mobx.action],e.prototype,"remove",null),__decorate([mobx.action],e.prototype,"removeAll",null),__decorate([mobx.computed],e.prototype,"length",null),__decorate([mobx.action],e.prototype,"reset",null),e}();function isOfType(e,t){for(var o=e;o;){if(o===t)return!0;o=Object.getPrototypeOf(o)}return!1}function isModel(e){return isOfType(e,PureModel)}function isCollection(e){return isOfType(e,PureCollection)}function isView(e){return isOfType(e,View)}function withActions(e){var t=e;if(!isModel(e))throw error(DECORATE_MODEL);return function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.update=function(e){updateModel(this,e)},t.prototype.clone=function(){return cloneModel(this)},t.prototype.assign=function(e,t){assignModel(this,e,t)},t.prototype.addReference=function(e,t,o){initModelRef(this,e,o,t)},t.prototype.toJSON=function(){return modelToJSON(this)},t}(t)}function withMeta(e){var t=e;if(!isModel(t))throw error(DECORATE_MODEL);return function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),Object.defineProperty(t.prototype,"meta",{get:function(){var e=this,t=getModelMetaKey(this,"refs"),o={};return Object.keys(t).forEach(function(t){o[t]=getRefId(e,t)}),Object.freeze({collection:getModelCollection(this),id:getModelId(this),original:getModelMetaKey(this,"originalId")&&getOriginalModel(this)||void 0,refs:o,snapshot:modelToJSON(this),type:getModelType(this)})},enumerable:!0,configurable:!0}),__decorate([mobx.computed],t.prototype,"meta",null),t}(t)}var Model=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t}(withActions(withMeta(PureModel))),CompatModel=function(e){function t(t,o){var r=e.call(this,t,o)||this;return datxUtils.deprecated("CompatModel is just a migration tool. Please move to Model or PureModel as soon as possible."),Object.keys(r.static.refs).forEach(function(e){if(!(e in getModelMetaKey(r,"refs"))){var t=r.static.refs[e],o=datxUtils.mapItems(r[e]||r.static.defaults[e],getModelId);delete r[e],initModelRef(r,e,"object"==typeof t?{model:t.model,property:t.property,type:exports.ReferenceType.TO_ONE_OR_MANY}:{model:t,type:exports.ReferenceType.TO_ONE_OR_MANY},o)}}),Object.keys(r.static.defaults).forEach(function(e){e in r.static.refs||e in r||initModelField(r,e,r.static.defaults[e])}),r}return __extends(t,e),t.prototype.getRecordId=function(){return datxUtils.deprecated("model.getRecordId is deprecated. Use getModelId() instead."),getModelId(this)},t.prototype.getRecordType=function(){return datxUtils.deprecated("model.getRecordType is deprecated. Use getModelType() instead."),getModelType(this)},t.prototype.assign=function(e,t){datxUtils.deprecated("model.assign is deprecated. Use assignModel() instead.");var o=FieldType.DATA,r=storage.getModelClassMetaKey(this.static,"id"),n=storage.getModelClassMetaKey(this.static,"type");return e===r?o=FieldType.ID:e===n&&(o=FieldType.TYPE),updateField(this,e,t,o),t},t.prototype.assignRef=function(e,t,o){if(datxUtils.deprecated("model.assignRef is deprecated. Use initModelRef() instead."),getModelMetaKey(this,"refs")[e])return this[e]=t;var r=o;if(r||(t instanceof Array||mobx.isObservableArray(t)?r=t.reduce(function(e,t){return e||getModelType(t)},null):t instanceof PureModel&&(r=getModelType(t))),!r)throw new Error("The type property is missing");return initModelRef(this,e,{model:r,type:exports.ReferenceType.TO_ONE_OR_MANY},t),this[e]},t.prototype.update=function(e){var t=this;datxUtils.deprecated("model.update is deprecated. Use updateModel() instead.");var o=Object.assign({},e);return Object.keys(o).forEach(function(e){"function"==typeof t[e]&&delete o[e]}),updateModel(this,o)},Object.defineProperty(t.prototype,"static",{get:function(){return datxUtils.deprecated("model.static is deprecated."),this.constructor},enumerable:!0,configurable:!0}),t.prototype.toJS=function(){return datxUtils.deprecated("model.toJS() is deprecated. Use modelToJSON() instead."),modelToJSON(this)},Object.defineProperty(t.prototype,"snapshot",{get:function(){return datxUtils.deprecated("model.snapshot is deprecated. Use modelToJSON() instead."),modelToJSON(this)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"__collection",{get:function(){return datxUtils.deprecated("model.__collection is deprecated. Use getModelCollection() instead."),getModelCollection(this)},enumerable:!0,configurable:!0}),t.refs={},t.defaults={},t}(PureModel),CompatCollection=function(e){function t(t){var o=e.call(this,t)||this;return datxUtils.deprecated("CompatCollection is just a migration tool. Please move to Collection as soon as possible."),o.static.types.forEach(function(e){var t=getModelType(e);datxUtils.assignComputed(o,t.toString(),function(){return o.findAll(t)})}),o}return __extends(t,e),Object.defineProperty(t.prototype,"static",{get:function(){return datxUtils.deprecated("collection.static is deprecated."),this.constructor},enumerable:!0,configurable:!0}),t.prototype.toJS=function(){return datxUtils.deprecated("collection.toJS() is deprecated. Use collection.toJSON() instead"),this.toJSON()},t.types=[CompatModel],t}(PureCollection);function propFn(e,t){storage.addModelDefaultField(e.constructor,t)}var prop=Object.assign(propFn,{defaultValue:function(e){return function(t,o){storage.addModelDefaultField(t.constructor,o,e)}},toOne:function(e){return function(t,o){storage.addModelClassReference(t.constructor,o,{model:e,type:exports.ReferenceType.TO_ONE})}},toMany:function(e,t){return function(o,r){storage.addModelClassReference(o.constructor,r,{model:e,property:t,type:exports.ReferenceType.TO_MANY})}},toOneOrMany:function(e){return function(t,o){storage.addModelClassReference(t.constructor,o,{model:e,type:exports.ReferenceType.TO_ONE_OR_MANY})}},identifier:function(e,t){storage.addModelDefaultField(e.constructor,t),storage.setModelClassMetaKey(e.constructor,"id",t)},type:function(e,t){storage.addModelDefaultField(e.constructor,t),storage.setModelClassMetaKey(e.constructor,"type",t)}});function setupModel(e,t){var o=void 0===t?{fields:{}}:t,r=o.fields,n=o.references,i=o.type,a=o.idAttribute,d=o.typeAttribute,s=e;if(!isModel(s))throw error(DECORATE_MODEL);var l=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t}(s);return i&&(l.type=i),a&&prop.identifier(l.prototype,a),d&&prop.type(l.prototype,d),r&&Object.keys(r).forEach(function(e){prop.defaultValue(r[e])(l.prototype,e)}),n&&Object.keys(n).forEach(function(e){var t=n[e],o=t.model,r=t.property;switch(n[e].type){case exports.ReferenceType.TO_ONE:return void prop.toOne(o)(l.prototype,e);case exports.ReferenceType.TO_MANY:return void prop.toMany(o,r)(l.prototype,e);default:return void prop.toOneOrMany(o)(l.prototype,e)}}),l}exports.prop=prop,exports.Collection=PureCollection,exports.Model=Model,exports.View=View,exports.PureCollection=PureCollection,exports.PureModel=PureModel,exports.CompatCollection=CompatCollection,exports.CompatModel=CompatModel,exports.getRefId=getRefId,exports.setRefId=setRefId,exports.updateModelId=updateModelId,exports.initModelRef=initModelRef,exports.assignModel=assignModel,exports.cloneModel=cloneModel,exports.getModelCollection=getModelCollection,exports.getModelId=getModelId,exports.getModelMetaKey=getModelMetaKey,exports.getModelType=getModelType,exports.getOriginalModel=getOriginalModel,exports.modelToJSON=modelToJSON,exports.setModelMetaKey=setModelMetaKey,exports.updateModel=updateModel,exports.isCollection=isCollection,exports.isModel=isModel,exports.isView=isView,exports.setupModel=setupModel,exports.withActions=withActions,exports.withMeta=withMeta;
