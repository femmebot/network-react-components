{"code":"import { assignComputed, META_FIELD } from 'datx-utils';\r\nimport { FieldType } from '../../enums/FieldType';\r\nimport { ReferenceType } from '../../enums/ReferenceType';\r\nimport { ID_REQUIRED } from '../../errors';\r\nimport { storage } from '../../services/storage';\r\nimport { getField, getRef, updateField, updateRef } from './fields';\r\nimport { getModelMetaKey, getModelType, setModelMetaKey } from './utils';\r\nexport function initModelField(obj, key, defValue, type) {\r\n    if (type === void 0) { type = FieldType.DATA; }\r\n    var fields = getModelMetaKey(obj, 'fields');\r\n    if (type === FieldType.ID && key in obj) {\r\n        delete obj[key];\r\n    }\r\n    // Initialize the observable field to the default value\r\n    storage.setModelDataKey(obj, key, defValue);\r\n    if (fields.indexOf(key) === -1) {\r\n        fields.push(key);\r\n    }\r\n    assignComputed(obj, key, function () { return getField(obj, key); }, function (value) {\r\n        updateField(obj, key, value, type);\r\n    });\r\n}\r\n/**\r\n * Initialize a reference to other models\r\n *\r\n * @export\r\n * @param {PureModel} obj Model to which the reference should be added\r\n * @param {string} key Model property where the reference will be defined\r\n * @param {IReferenceOptions} options Reference options\r\n * @param {TRefValue} initialVal Initial reference value\r\n */\r\nexport function initModelRef(obj, key, options, initialVal) {\r\n    var refs = getModelMetaKey(obj, 'refs');\r\n    // Initialize the observable field to the given value\r\n    refs[key] = options;\r\n    var isArray = options.type === ReferenceType.TO_MANY;\r\n    storage.setModelDataKey(obj, key, isArray ? [] : undefined);\r\n    assignComputed(obj, key, function () { return getRef(obj, key); }, function (value) {\r\n        updateRef(obj, key, value);\r\n    });\r\n    if (!options.property && initialVal !== undefined) {\r\n        obj[key] = initialVal;\r\n    }\r\n}\r\nfunction prepareFields(data, meta, model) {\r\n    var staticModel = model.constructor;\r\n    var fields = meta.fields ? meta.fields.slice() : [];\r\n    var classRefs = storage.getModelClassReferences(staticModel);\r\n    var refs = Object.assign({}, classRefs, meta.refs);\r\n    var defaults = storage.getModelDefaults(staticModel);\r\n    Object.keys(data).concat(Object.keys(defaults))\r\n        .forEach(function (key) {\r\n        if (!(key in refs) && fields.indexOf(key) === -1) {\r\n            fields.push(key);\r\n        }\r\n    });\r\n    return { defaults: defaults, fields: fields, refs: refs };\r\n}\r\nfunction initModelData(model, data, meta, collection) {\r\n    var _a = prepareFields(data, meta, model), defaults = _a.defaults, fields = _a.fields, refs = _a.refs;\r\n    var staticModel = model.constructor;\r\n    var modelId = storage.getModelClassMetaKey(staticModel, 'id');\r\n    var modelType = storage.getModelClassMetaKey(staticModel, 'type');\r\n    fields.forEach(function (key) {\r\n        var type = FieldType.DATA;\r\n        var value = data[key];\r\n        if (value === undefined) {\r\n            value = defaults[key];\r\n        }\r\n        if (key === (modelId || 'id')) {\r\n            type = FieldType.ID;\r\n            value = meta.id;\r\n        }\r\n        else if (key === modelType) {\r\n            type = FieldType.TYPE;\r\n            value = meta.type;\r\n        }\r\n        initModelField(model, key, value, type);\r\n    });\r\n    if (modelId && !(modelId in fields)) {\r\n        initModelField(model, modelId, meta.id, FieldType.ID);\r\n    }\r\n    Object.keys(refs).forEach(function (key) {\r\n        var opts = refs[key];\r\n        var value = data[key] || defaults[key] || undefined;\r\n        var models = collection ? collection.add(value, getModelType(opts.model)) : value;\r\n        initModelRef(model, key, opts, models);\r\n    });\r\n}\r\nfunction initModelMeta(model, data, collection) {\r\n    var staticModel = model.constructor;\r\n    var modelId = storage.getModelClassMetaKey(staticModel, 'id') || 'id';\r\n    var modelType = storage.getModelClassMetaKey(staticModel, 'type');\r\n    var type = (modelType && data[modelType]) || getModelType(model);\r\n    var id = (modelId && data[modelId]);\r\n    if (!id) {\r\n        if (!staticModel.enableAutoId) {\r\n            throw new Error(ID_REQUIRED);\r\n        }\r\n        id = staticModel.getAutoId();\r\n        while (collection && collection.find(type, id)) {\r\n            id = staticModel.getAutoId();\r\n        }\r\n    }\r\n    var meta = {\r\n        fields: [],\r\n        id: id,\r\n        refs: {},\r\n        type: type,\r\n    };\r\n    var newMeta;\r\n    var toInit = { fields: [], refs: {} };\r\n    if (META_FIELD in data && data[META_FIELD]) {\r\n        var oldMeta = data[META_FIELD] || {};\r\n        toInit.fields = oldMeta.fields;\r\n        delete oldMeta.fields;\r\n        toInit.refs = oldMeta.refs;\r\n        delete oldMeta.refs;\r\n        newMeta = storage.setModelMeta(model, Object.assign(meta, oldMeta));\r\n        delete data[META_FIELD];\r\n    }\r\n    else {\r\n        newMeta = storage.setModelMeta(model, meta);\r\n    }\r\n    return Object.assign({}, newMeta, toInit);\r\n}\r\nexport function initModel(model, rawData, collection) {\r\n    var staticModel = model.constructor;\r\n    var data = Object.assign({}, staticModel.preprocess(rawData, collection));\r\n    setModelMetaKey(model, 'collection', collection);\r\n    var meta = initModelMeta(model, data, collection);\r\n    initModelData(model, data, meta, collection);\r\n}\r\n//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5pdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9oZWxwZXJzL21vZGVsL2luaXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLGNBQWMsRUFBMEIsVUFBVSxFQUFDLE1BQU0sWUFBWSxDQUFDO0FBRTlFLE9BQU8sRUFBQyxTQUFTLEVBQUMsTUFBTSx1QkFBdUIsQ0FBQztBQUNoRCxPQUFPLEVBQUMsYUFBYSxFQUFDLE1BQU0sMkJBQTJCLENBQUM7QUFDeEQsT0FBTyxFQUFDLFdBQVcsRUFBZSxNQUFNLGNBQWMsQ0FBQztBQU92RCxPQUFPLEVBQUMsT0FBTyxFQUFDLE1BQU0sd0JBQXdCLENBQUM7QUFFL0MsT0FBTyxFQUFDLFFBQVEsRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBQyxNQUFNLFVBQVUsQ0FBQztBQUNsRSxPQUFPLEVBQUMsZUFBZSxFQUFFLFlBQVksRUFBRSxlQUFlLEVBQUMsTUFBTSxTQUFTLENBQUM7QUFTdkUsTUFBTSx5QkFDSixHQUFNLEVBQ04sR0FBVyxFQUNYLFFBQWEsRUFDYixJQUFnQztJQUFoQyxxQkFBQSxFQUFBLE9BQWtCLFNBQVMsQ0FBQyxJQUFJO0lBRWhDLElBQU0sTUFBTSxHQUFHLGVBQWUsQ0FBQyxHQUFHLEVBQUUsUUFBUSxDQUFrQixDQUFDO0lBRS9ELElBQUksSUFBSSxLQUFLLFNBQVMsQ0FBQyxFQUFFLElBQUksR0FBRyxJQUFJLEdBQUcsRUFBRTtRQUN2QyxPQUFPLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztLQUNqQjtJQUVELHVEQUF1RDtJQUN2RCxPQUFPLENBQUMsZUFBZSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDNUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFO1FBQzlCLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7S0FDbEI7SUFFRCxjQUFjLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFDckIsY0FBTSxPQUFBLFFBQVEsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLEVBQWxCLENBQWtCLEVBQ3hCLFVBQUMsS0FBSztRQUNKLFdBQVcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNyQyxDQUFDLENBQ0YsQ0FBQztBQUNKLENBQUM7QUFFRDs7Ozs7Ozs7R0FRRztBQUNILE1BQU0sdUJBQXVCLEdBQWMsRUFBRSxHQUFXLEVBQUUsT0FBMEIsRUFBRSxVQUFxQjtJQUN6RyxJQUFNLElBQUksR0FBRyxlQUFlLENBQUMsR0FBRyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBRTFDLHFEQUFxRDtJQUNyRCxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsT0FBTyxDQUFDO0lBRXBCLElBQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxJQUFJLEtBQUssYUFBYSxDQUFDLE9BQU8sQ0FBQztJQUN2RCxPQUFPLENBQUMsZUFBZSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBRTVELGNBQWMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUNyQixjQUFNLE9BQUEsTUFBTSxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsRUFBaEIsQ0FBZ0IsRUFDdEIsVUFBQyxLQUFLO1FBQ0osU0FBUyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDN0IsQ0FBQyxDQUNGLENBQUM7SUFFRixJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsSUFBSSxVQUFVLEtBQUssU0FBUyxFQUFFO1FBQ2pELEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxVQUFVLENBQUM7S0FDdkI7QUFDSCxDQUFDO0FBRUQsdUJBQXVCLElBQWUsRUFBRSxJQUFpQixFQUFFLEtBQWdCO0lBQ3pFLElBQU0sV0FBVyxHQUFHLEtBQUssQ0FBQyxXQUErQixDQUFDO0lBQzFELElBQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUN0RCxJQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsdUJBQXVCLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDL0QsSUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsU0FBUyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUVyRCxJQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLENBQUM7SUFFdkQsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUM1QyxPQUFPLENBQUMsVUFBQyxHQUFHO1FBQ1gsSUFBSSxDQUFDLENBQUMsR0FBRyxJQUFJLElBQUksQ0FBQyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7WUFDaEQsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUNsQjtJQUNILENBQUMsQ0FBQyxDQUFDO0lBRUwsT0FBTyxFQUFDLFFBQVEsVUFBQSxFQUFFLE1BQU0sUUFBQSxFQUFFLElBQUksTUFBQSxFQUFDLENBQUM7QUFDbEMsQ0FBQztBQUVELHVCQUF1QixLQUFnQixFQUFFLElBQWUsRUFBRSxJQUFpQixFQUFFLFVBQTJCO0lBQ2hHLElBQUEscUNBQTJELEVBQTFELHNCQUFRLEVBQUUsa0JBQU0sRUFBRSxjQUFJLENBQXFDO0lBRWxFLElBQU0sV0FBVyxHQUFHLEtBQUssQ0FBQyxXQUErQixDQUFDO0lBQzFELElBQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDaEUsSUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLG9CQUFvQixDQUFDLFdBQVcsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUVwRSxNQUFNLENBQUMsT0FBTyxDQUFDLFVBQUMsR0FBRztRQUNqQixJQUFJLElBQUksR0FBRyxTQUFTLENBQUMsSUFBSSxDQUFDO1FBQzFCLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN0QixJQUFJLEtBQUssS0FBSyxTQUFTLEVBQUU7WUFDdkIsS0FBSyxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUN2QjtRQUNELElBQUksR0FBRyxLQUFLLENBQUMsT0FBTyxJQUFJLElBQUksQ0FBQyxFQUFFO1lBQzdCLElBQUksR0FBRyxTQUFTLENBQUMsRUFBRSxDQUFDO1lBQ3BCLEtBQUssR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDO1NBQ2pCO2FBQU0sSUFBSSxHQUFHLEtBQUssU0FBUyxFQUFFO1lBQzVCLElBQUksR0FBRyxTQUFTLENBQUMsSUFBSSxDQUFDO1lBQ3RCLEtBQUssR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1NBQ25CO1FBQ0QsY0FBYyxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQzFDLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxPQUFPLElBQUksQ0FBQyxDQUFDLE9BQU8sSUFBSSxNQUFNLENBQUMsRUFBRTtRQUNuQyxjQUFjLENBQUMsS0FBSyxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLFNBQVMsQ0FBQyxFQUFFLENBQUMsQ0FBQztLQUN2RDtJQUVELE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQUMsR0FBRztRQUM1QixJQUFNLElBQUksR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDdkIsSUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxTQUFTLENBQUM7UUFDdEQsSUFBTSxNQUFNLEdBQVEsVUFBVSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxZQUFZLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQztRQUN6RixZQUFZLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDekMsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDO0FBRUQsdUJBQXVCLEtBQWdCLEVBQUUsSUFBZSxFQUFFLFVBQTJCO0lBQ25GLElBQU0sV0FBVyxHQUFHLEtBQUssQ0FBQyxXQUErQixDQUFDO0lBQzFELElBQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDO0lBQ3hFLElBQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxXQUFXLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFFcEUsSUFBTSxJQUFJLEdBQUcsQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQUksWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ25FLElBQUksRUFBRSxHQUFHLENBQUMsT0FBTyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBRXBDLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDUCxJQUFJLENBQUMsV0FBVyxDQUFDLFlBQVksRUFBRTtZQUM3QixNQUFNLElBQUksS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1NBQzlCO1FBQ0QsRUFBRSxHQUFHLFdBQVcsQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUM3QixPQUFPLFVBQVUsSUFBSSxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsRUFBRTtZQUM5QyxFQUFFLEdBQUcsV0FBVyxDQUFDLFNBQVMsRUFBRSxDQUFDO1NBQzlCO0tBQ0Y7SUFFRCxJQUFNLElBQUksR0FBRztRQUNYLE1BQU0sRUFBRSxFQUFFO1FBQ1YsRUFBRSxJQUFBO1FBQ0YsSUFBSSxFQUFFLEVBQUU7UUFDUixJQUFJLE1BQUE7S0FDTCxDQUFDO0lBRUYsSUFBSSxPQUFPLENBQUM7SUFDWixJQUFNLE1BQU0sR0FBZ0IsRUFBQyxNQUFNLEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUMsQ0FBQztJQUNuRCxJQUFJLFVBQVUsSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFO1FBQzFDLElBQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDdkMsTUFBTSxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDO1FBQy9CLE9BQU8sT0FBTyxDQUFDLE1BQU0sQ0FBQztRQUN0QixNQUFNLENBQUMsSUFBSSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUM7UUFDM0IsT0FBTyxPQUFPLENBQUMsSUFBSSxDQUFDO1FBRXBCLE9BQU8sR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBQ3BFLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0tBQ3pCO1NBQU07UUFDTCxPQUFPLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7S0FDN0M7SUFFRCxPQUFPLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLE9BQU8sRUFBRSxNQUFNLENBQUMsQ0FBQztBQUM1QyxDQUFDO0FBRUQsTUFBTSxvQkFBb0IsS0FBZ0IsRUFBRSxPQUFrQixFQUFFLFVBQTJCO0lBQ3pGLElBQU0sV0FBVyxHQUFHLEtBQUssQ0FBQyxXQUErQixDQUFDO0lBQzFELElBQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLFdBQVcsQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUM7SUFDNUUsZUFBZSxDQUFDLEtBQUssRUFBRSxZQUFZLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFDakQsSUFBTSxJQUFJLEdBQUcsYUFBYSxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFDcEQsYUFBYSxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0FBQy9DLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge2Fzc2lnbkNvbXB1dGVkLCBJRGljdGlvbmFyeSwgSVJhd01vZGVsLCBNRVRBX0ZJRUxEfSBmcm9tICdkYXR4LXV0aWxzJztcblxuaW1wb3J0IHtGaWVsZFR5cGV9IGZyb20gJy4uLy4uL2VudW1zL0ZpZWxkVHlwZSc7XG5pbXBvcnQge1JlZmVyZW5jZVR5cGV9IGZyb20gJy4uLy4uL2VudW1zL1JlZmVyZW5jZVR5cGUnO1xuaW1wb3J0IHtJRF9SRVFVSVJFRCwgTU9ERUxfRVhJU1RTfSBmcm9tICcuLi8uLi9lcnJvcnMnO1xuaW1wb3J0IHtJSWRlbnRpZmllcn0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9JSWRlbnRpZmllcic7XG5pbXBvcnQge0lSZWZlcmVuY2VPcHRpb25zfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL0lSZWZlcmVuY2VPcHRpb25zJztcbmltcG9ydCB7SVR5cGV9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvSVR5cGUnO1xuaW1wb3J0IHtUUmVmVmFsdWV9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvVFJlZlZhbHVlJztcbmltcG9ydCB7UHVyZUNvbGxlY3Rpb259IGZyb20gJy4uLy4uL1B1cmVDb2xsZWN0aW9uJztcbmltcG9ydCB7UHVyZU1vZGVsfSBmcm9tICcuLi8uLi9QdXJlTW9kZWwnO1xuaW1wb3J0IHtzdG9yYWdlfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9zdG9yYWdlJztcbmltcG9ydCB7ZXJyb3J9IGZyb20gJy4uL2Zvcm1hdCc7XG5pbXBvcnQge2dldEZpZWxkLCBnZXRSZWYsIHVwZGF0ZUZpZWxkLCB1cGRhdGVSZWZ9IGZyb20gJy4vZmllbGRzJztcbmltcG9ydCB7Z2V0TW9kZWxNZXRhS2V5LCBnZXRNb2RlbFR5cGUsIHNldE1vZGVsTWV0YUtleX0gZnJvbSAnLi91dGlscyc7XG5cbmludGVyZmFjZSBJTWV0YVRvSW5pdCBleHRlbmRzIElEaWN0aW9uYXJ5IHtcbiAgZmllbGRzOiBBcnJheTxzdHJpbmc+O1xuICBpZD86IElJZGVudGlmaWVyO1xuICByZWZzOiBJRGljdGlvbmFyeTxJUmVmZXJlbmNlT3B0aW9ucz47XG4gIHR5cGU/OiBJVHlwZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGluaXRNb2RlbEZpZWxkPFQgZXh0ZW5kcyBQdXJlTW9kZWw+KFxuICBvYmo6IFQsXG4gIGtleTogc3RyaW5nLFxuICBkZWZWYWx1ZTogYW55LFxuICB0eXBlOiBGaWVsZFR5cGUgPSBGaWVsZFR5cGUuREFUQSxcbikge1xuICBjb25zdCBmaWVsZHMgPSBnZXRNb2RlbE1ldGFLZXkob2JqLCAnZmllbGRzJykgYXMgQXJyYXk8c3RyaW5nPjtcblxuICBpZiAodHlwZSA9PT0gRmllbGRUeXBlLklEICYmIGtleSBpbiBvYmopIHtcbiAgICBkZWxldGUgb2JqW2tleV07XG4gIH1cblxuICAvLyBJbml0aWFsaXplIHRoZSBvYnNlcnZhYmxlIGZpZWxkIHRvIHRoZSBkZWZhdWx0IHZhbHVlXG4gIHN0b3JhZ2Uuc2V0TW9kZWxEYXRhS2V5KG9iaiwga2V5LCBkZWZWYWx1ZSk7XG4gIGlmIChmaWVsZHMuaW5kZXhPZihrZXkpID09PSAtMSkge1xuICAgIGZpZWxkcy5wdXNoKGtleSk7XG4gIH1cblxuICBhc3NpZ25Db21wdXRlZChvYmosIGtleSxcbiAgICAoKSA9PiBnZXRGaWVsZChvYmosIGtleSksXG4gICAgKHZhbHVlKSA9PiB7XG4gICAgICB1cGRhdGVGaWVsZChvYmosIGtleSwgdmFsdWUsIHR5cGUpO1xuICAgIH0sXG4gICk7XG59XG5cbi8qKlxuICogSW5pdGlhbGl6ZSBhIHJlZmVyZW5jZSB0byBvdGhlciBtb2RlbHNcbiAqXG4gKiBAZXhwb3J0XG4gKiBAcGFyYW0ge1B1cmVNb2RlbH0gb2JqIE1vZGVsIHRvIHdoaWNoIHRoZSByZWZlcmVuY2Ugc2hvdWxkIGJlIGFkZGVkXG4gKiBAcGFyYW0ge3N0cmluZ30ga2V5IE1vZGVsIHByb3BlcnR5IHdoZXJlIHRoZSByZWZlcmVuY2Ugd2lsbCBiZSBkZWZpbmVkXG4gKiBAcGFyYW0ge0lSZWZlcmVuY2VPcHRpb25zfSBvcHRpb25zIFJlZmVyZW5jZSBvcHRpb25zXG4gKiBAcGFyYW0ge1RSZWZWYWx1ZX0gaW5pdGlhbFZhbCBJbml0aWFsIHJlZmVyZW5jZSB2YWx1ZVxuICovXG5leHBvcnQgZnVuY3Rpb24gaW5pdE1vZGVsUmVmKG9iajogUHVyZU1vZGVsLCBrZXk6IHN0cmluZywgb3B0aW9uczogSVJlZmVyZW5jZU9wdGlvbnMsIGluaXRpYWxWYWw6IFRSZWZWYWx1ZSkge1xuICBjb25zdCByZWZzID0gZ2V0TW9kZWxNZXRhS2V5KG9iaiwgJ3JlZnMnKTtcblxuICAvLyBJbml0aWFsaXplIHRoZSBvYnNlcnZhYmxlIGZpZWxkIHRvIHRoZSBnaXZlbiB2YWx1ZVxuICByZWZzW2tleV0gPSBvcHRpb25zO1xuXG4gIGNvbnN0IGlzQXJyYXkgPSBvcHRpb25zLnR5cGUgPT09IFJlZmVyZW5jZVR5cGUuVE9fTUFOWTtcbiAgc3RvcmFnZS5zZXRNb2RlbERhdGFLZXkob2JqLCBrZXksIGlzQXJyYXkgPyBbXSA6IHVuZGVmaW5lZCk7XG5cbiAgYXNzaWduQ29tcHV0ZWQob2JqLCBrZXksXG4gICAgKCkgPT4gZ2V0UmVmKG9iaiwga2V5KSxcbiAgICAodmFsdWUpID0+IHtcbiAgICAgIHVwZGF0ZVJlZihvYmosIGtleSwgdmFsdWUpO1xuICAgIH0sXG4gICk7XG5cbiAgaWYgKCFvcHRpb25zLnByb3BlcnR5ICYmIGluaXRpYWxWYWwgIT09IHVuZGVmaW5lZCkge1xuICAgIG9ialtrZXldID0gaW5pdGlhbFZhbDtcbiAgfVxufVxuXG5mdW5jdGlvbiBwcmVwYXJlRmllbGRzKGRhdGE6IElSYXdNb2RlbCwgbWV0YTogSU1ldGFUb0luaXQsIG1vZGVsOiBQdXJlTW9kZWwpIHtcbiAgY29uc3Qgc3RhdGljTW9kZWwgPSBtb2RlbC5jb25zdHJ1Y3RvciBhcyB0eXBlb2YgUHVyZU1vZGVsO1xuICBjb25zdCBmaWVsZHMgPSBtZXRhLmZpZWxkcyA/IG1ldGEuZmllbGRzLnNsaWNlKCkgOiBbXTtcbiAgY29uc3QgY2xhc3NSZWZzID0gc3RvcmFnZS5nZXRNb2RlbENsYXNzUmVmZXJlbmNlcyhzdGF0aWNNb2RlbCk7XG4gIGNvbnN0IHJlZnMgPSBPYmplY3QuYXNzaWduKHt9LCBjbGFzc1JlZnMsIG1ldGEucmVmcyk7XG5cbiAgY29uc3QgZGVmYXVsdHMgPSBzdG9yYWdlLmdldE1vZGVsRGVmYXVsdHMoc3RhdGljTW9kZWwpO1xuXG4gIE9iamVjdC5rZXlzKGRhdGEpLmNvbmNhdChPYmplY3Qua2V5cyhkZWZhdWx0cykpXG4gICAgLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgaWYgKCEoa2V5IGluIHJlZnMpICYmIGZpZWxkcy5pbmRleE9mKGtleSkgPT09IC0xKSB7XG4gICAgICAgIGZpZWxkcy5wdXNoKGtleSk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgcmV0dXJuIHtkZWZhdWx0cywgZmllbGRzLCByZWZzfTtcbn1cblxuZnVuY3Rpb24gaW5pdE1vZGVsRGF0YShtb2RlbDogUHVyZU1vZGVsLCBkYXRhOiBJUmF3TW9kZWwsIG1ldGE6IElNZXRhVG9Jbml0LCBjb2xsZWN0aW9uPzogUHVyZUNvbGxlY3Rpb24pIHtcbiAgY29uc3Qge2RlZmF1bHRzLCBmaWVsZHMsIHJlZnN9ID0gcHJlcGFyZUZpZWxkcyhkYXRhLCBtZXRhLCBtb2RlbCk7XG5cbiAgY29uc3Qgc3RhdGljTW9kZWwgPSBtb2RlbC5jb25zdHJ1Y3RvciBhcyB0eXBlb2YgUHVyZU1vZGVsO1xuICBjb25zdCBtb2RlbElkID0gc3RvcmFnZS5nZXRNb2RlbENsYXNzTWV0YUtleShzdGF0aWNNb2RlbCwgJ2lkJyk7XG4gIGNvbnN0IG1vZGVsVHlwZSA9IHN0b3JhZ2UuZ2V0TW9kZWxDbGFzc01ldGFLZXkoc3RhdGljTW9kZWwsICd0eXBlJyk7XG5cbiAgZmllbGRzLmZvckVhY2goKGtleSkgPT4ge1xuICAgIGxldCB0eXBlID0gRmllbGRUeXBlLkRBVEE7XG4gICAgbGV0IHZhbHVlID0gZGF0YVtrZXldO1xuICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB2YWx1ZSA9IGRlZmF1bHRzW2tleV07XG4gICAgfVxuICAgIGlmIChrZXkgPT09IChtb2RlbElkIHx8ICdpZCcpKSB7XG4gICAgICB0eXBlID0gRmllbGRUeXBlLklEO1xuICAgICAgdmFsdWUgPSBtZXRhLmlkO1xuICAgIH0gZWxzZSBpZiAoa2V5ID09PSBtb2RlbFR5cGUpIHtcbiAgICAgIHR5cGUgPSBGaWVsZFR5cGUuVFlQRTtcbiAgICAgIHZhbHVlID0gbWV0YS50eXBlO1xuICAgIH1cbiAgICBpbml0TW9kZWxGaWVsZChtb2RlbCwga2V5LCB2YWx1ZSwgdHlwZSk7XG4gIH0pO1xuXG4gIGlmIChtb2RlbElkICYmICEobW9kZWxJZCBpbiBmaWVsZHMpKSB7XG4gICAgaW5pdE1vZGVsRmllbGQobW9kZWwsIG1vZGVsSWQsIG1ldGEuaWQsIEZpZWxkVHlwZS5JRCk7XG4gIH1cblxuICBPYmplY3Qua2V5cyhyZWZzKS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICBjb25zdCBvcHRzID0gcmVmc1trZXldO1xuICAgIGNvbnN0IHZhbHVlID0gZGF0YVtrZXldIHx8IGRlZmF1bHRzW2tleV0gfHwgdW5kZWZpbmVkO1xuICAgIGNvbnN0IG1vZGVsczogYW55ID0gY29sbGVjdGlvbiA/IGNvbGxlY3Rpb24uYWRkKHZhbHVlLCBnZXRNb2RlbFR5cGUob3B0cy5tb2RlbCkpIDogdmFsdWU7XG4gICAgaW5pdE1vZGVsUmVmKG1vZGVsLCBrZXksIG9wdHMsIG1vZGVscyk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBpbml0TW9kZWxNZXRhKG1vZGVsOiBQdXJlTW9kZWwsIGRhdGE6IElSYXdNb2RlbCwgY29sbGVjdGlvbj86IFB1cmVDb2xsZWN0aW9uKTogSURpY3Rpb25hcnkgJiBJTWV0YVRvSW5pdCB7XG4gIGNvbnN0IHN0YXRpY01vZGVsID0gbW9kZWwuY29uc3RydWN0b3IgYXMgdHlwZW9mIFB1cmVNb2RlbDtcbiAgY29uc3QgbW9kZWxJZCA9IHN0b3JhZ2UuZ2V0TW9kZWxDbGFzc01ldGFLZXkoc3RhdGljTW9kZWwsICdpZCcpIHx8ICdpZCc7XG4gIGNvbnN0IG1vZGVsVHlwZSA9IHN0b3JhZ2UuZ2V0TW9kZWxDbGFzc01ldGFLZXkoc3RhdGljTW9kZWwsICd0eXBlJyk7XG5cbiAgY29uc3QgdHlwZSA9IChtb2RlbFR5cGUgJiYgZGF0YVttb2RlbFR5cGVdKSB8fCBnZXRNb2RlbFR5cGUobW9kZWwpO1xuICBsZXQgaWQgPSAobW9kZWxJZCAmJiBkYXRhW21vZGVsSWRdKTtcblxuICBpZiAoIWlkKSB7XG4gICAgaWYgKCFzdGF0aWNNb2RlbC5lbmFibGVBdXRvSWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihJRF9SRVFVSVJFRCk7XG4gICAgfVxuICAgIGlkID0gc3RhdGljTW9kZWwuZ2V0QXV0b0lkKCk7XG4gICAgd2hpbGUgKGNvbGxlY3Rpb24gJiYgY29sbGVjdGlvbi5maW5kKHR5cGUsIGlkKSkge1xuICAgICAgaWQgPSBzdGF0aWNNb2RlbC5nZXRBdXRvSWQoKTtcbiAgICB9XG4gIH1cblxuICBjb25zdCBtZXRhID0ge1xuICAgIGZpZWxkczogW10sXG4gICAgaWQsXG4gICAgcmVmczoge30sXG4gICAgdHlwZSxcbiAgfTtcblxuICBsZXQgbmV3TWV0YTtcbiAgY29uc3QgdG9Jbml0OiBJTWV0YVRvSW5pdCA9IHtmaWVsZHM6IFtdLCByZWZzOiB7fX07XG4gIGlmIChNRVRBX0ZJRUxEIGluIGRhdGEgJiYgZGF0YVtNRVRBX0ZJRUxEXSkge1xuICAgIGNvbnN0IG9sZE1ldGEgPSBkYXRhW01FVEFfRklFTERdIHx8IHt9O1xuICAgIHRvSW5pdC5maWVsZHMgPSBvbGRNZXRhLmZpZWxkcztcbiAgICBkZWxldGUgb2xkTWV0YS5maWVsZHM7XG4gICAgdG9Jbml0LnJlZnMgPSBvbGRNZXRhLnJlZnM7XG4gICAgZGVsZXRlIG9sZE1ldGEucmVmcztcblxuICAgIG5ld01ldGEgPSBzdG9yYWdlLnNldE1vZGVsTWV0YShtb2RlbCwgT2JqZWN0LmFzc2lnbihtZXRhLCBvbGRNZXRhKSk7XG4gICAgZGVsZXRlIGRhdGFbTUVUQV9GSUVMRF07XG4gIH0gZWxzZSB7XG4gICAgbmV3TWV0YSA9IHN0b3JhZ2Uuc2V0TW9kZWxNZXRhKG1vZGVsLCBtZXRhKTtcbiAgfVxuXG4gIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCBuZXdNZXRhLCB0b0luaXQpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaW5pdE1vZGVsKG1vZGVsOiBQdXJlTW9kZWwsIHJhd0RhdGE6IElSYXdNb2RlbCwgY29sbGVjdGlvbj86IFB1cmVDb2xsZWN0aW9uKSB7XG4gIGNvbnN0IHN0YXRpY01vZGVsID0gbW9kZWwuY29uc3RydWN0b3IgYXMgdHlwZW9mIFB1cmVNb2RlbDtcbiAgY29uc3QgZGF0YSA9IE9iamVjdC5hc3NpZ24oe30sIHN0YXRpY01vZGVsLnByZXByb2Nlc3MocmF3RGF0YSwgY29sbGVjdGlvbikpO1xuICBzZXRNb2RlbE1ldGFLZXkobW9kZWwsICdjb2xsZWN0aW9uJywgY29sbGVjdGlvbik7XG4gIGNvbnN0IG1ldGEgPSBpbml0TW9kZWxNZXRhKG1vZGVsLCBkYXRhLCBjb2xsZWN0aW9uKTtcbiAgaW5pdE1vZGVsRGF0YShtb2RlbCwgZGF0YSwgbWV0YSwgY29sbGVjdGlvbik7XG59XG4iXX0=","dts":{"name":"/Users/darko/Projects/mobx/datx/packages/datx/helpers/model/init.d.ts","text":"import { IRawModel } from 'datx-utils';\r\nimport { FieldType } from '../../enums/FieldType';\r\nimport { IReferenceOptions } from '../../interfaces/IReferenceOptions';\r\nimport { TRefValue } from '../../interfaces/TRefValue';\r\nimport { PureCollection } from '../../PureCollection';\r\nimport { PureModel } from '../../PureModel';\r\nexport declare function initModelField<T extends PureModel>(obj: T, key: string, defValue: any, type?: FieldType): void;\r\n/**\r\n * Initialize a reference to other models\r\n *\r\n * @export\r\n * @param {PureModel} obj Model to which the reference should be added\r\n * @param {string} key Model property where the reference will be defined\r\n * @param {IReferenceOptions} options Reference options\r\n * @param {TRefValue} initialVal Initial reference value\r\n */\r\nexport declare function initModelRef(obj: PureModel, key: string, options: IReferenceOptions, initialVal: TRefValue): void;\r\nexport declare function initModel(model: PureModel, rawData: IRawModel, collection?: PureCollection): void;\r\n"}}
