{"code":"import { mapItems, warn } from 'datx-utils';\r\nimport { intercept, isObservableArray, observable } from 'mobx';\r\nimport { FieldType } from '../../enums/FieldType';\r\nimport { ReferenceType } from '../../enums/ReferenceType';\r\nimport { BACK_REF_READ_ONLY, ID_READONLY, REF_ARRAY, REF_NEEDS_COLLECTION, REF_SINGLE, TYPE_READONLY, WRONG_REF_TYPE, } from '../../errors';\r\nimport { PureModel } from '../../PureModel';\r\nimport { storage } from '../../services/storage';\r\nimport { error } from '../format';\r\nimport { getModelCollection, getModelId, getModelMetaKey, getModelType, setModelMetaKey } from './utils';\r\nfunction modelAddReference(model, key, newReference) {\r\n    var refOptions = storage.getModelReferenceOptions(model, key);\r\n    var newRefId = getModelId(newReference);\r\n    var data = storage.getModelDataKey(model, key);\r\n    if (refOptions.type === ReferenceType.TO_ONE) {\r\n        storage.setModelDataKey(model, key, newRefId);\r\n    }\r\n    else if (refOptions.type === ReferenceType.TO_MANY || isObservableArray(data)) {\r\n        data.push(newRefId);\r\n    }\r\n    else {\r\n        storage.setModelDataKey(model, key, newReference);\r\n    }\r\n}\r\nfunction modelRemoveReference(model, key, oldReference) {\r\n    var refOptions = storage.getModelReferenceOptions(model, key);\r\n    var oldRefId = getModelId(oldReference);\r\n    var data = storage.getModelDataKey(model, key);\r\n    if (refOptions.type === ReferenceType.TO_ONE) {\r\n        storage.setModelDataKey(model, key, null);\r\n    }\r\n    else if (refOptions.type === ReferenceType.TO_MANY || isObservableArray(data)) {\r\n        data.remove(oldRefId);\r\n    }\r\n    else {\r\n        storage.setModelDataKey(model, key, null);\r\n    }\r\n}\r\nfunction ensureModel(refOptions, collection) {\r\n    return function (data) {\r\n        var model = data;\r\n        if (!(data instanceof PureModel) && typeof data === 'object') {\r\n            if (!collection) {\r\n                throw new Error(REF_NEEDS_COLLECTION);\r\n            }\r\n            model = collection.add(data, refOptions.model);\r\n        }\r\n        return getModelId(model);\r\n    };\r\n}\r\nfunction partialRefUpdate(model, key, change) {\r\n    var refOptions = storage.getModelReferenceOptions(model, key);\r\n    var data = storage.getModelDataKey(model, key);\r\n    var collection = getModelCollection(model);\r\n    if (change.type === 'splice') {\r\n        var added = change.added.map(ensureModel(refOptions, collection));\r\n        data.splice.apply(data, [change.index, change.removedCount].concat(added));\r\n        return null;\r\n    }\r\n    data[change.index] = ensureModel(refOptions, collection)(change.newValue);\r\n    return null;\r\n}\r\nfunction backRefSplice(model, key, change, refOptions) {\r\n    var property = refOptions.property;\r\n    change.added.forEach(function (item) {\r\n        modelAddReference(item, property, model);\r\n    });\r\n    var removed = model[key].slice(change.index, change.index + change.removedCount);\r\n    removed.forEach(function (item) {\r\n        modelRemoveReference(item, property, model);\r\n    });\r\n    return null;\r\n}\r\nfunction backRefChange(model, key, change, refOptions) {\r\n    var property = refOptions.property;\r\n    var oldValue = model[key].length > change.index ? model[key][change.index] : null;\r\n    if (change.newValue) {\r\n        modelAddReference(change.newValue, property, model);\r\n    }\r\n    if (oldValue) {\r\n        modelRemoveReference(oldValue, property, model);\r\n    }\r\n    warn(\"This shouldn't have happened. Please open an issue: https://github.com/infinum/datx/issues/new\");\r\n    return null;\r\n}\r\nfunction partialBackRefUpdate(model, key, change) {\r\n    var refOptions = storage.getModelReferenceOptions(model, key);\r\n    if (change.type === 'splice') {\r\n        return backRefSplice(model, key, change, refOptions);\r\n    }\r\n    return backRefChange(model, key, change, refOptions);\r\n}\r\nexport function getField(model, key) {\r\n    return storage.getModelDataKey(model, key);\r\n}\r\nexport function updateField(model, key, value, type) {\r\n    if (type === FieldType.TYPE) {\r\n        throw error(TYPE_READONLY);\r\n    }\r\n    else if (type === FieldType.ID) {\r\n        throw error(ID_READONLY);\r\n    }\r\n    var refs = getModelMetaKey(model, 'refs');\r\n    if (key in refs) {\r\n        updateRef(model, key, value);\r\n    }\r\n    else {\r\n        storage.setModelDataKey(model, key, value);\r\n    }\r\n}\r\nfunction hasBackRef(item, property, target) {\r\n    if (item[property] === null || item[property] === undefined) {\r\n        return false;\r\n    }\r\n    else if (item[property] instanceof PureModel) {\r\n        return item[property] === target;\r\n    }\r\n    else {\r\n        return item[property].indexOf(target) !== -1;\r\n    }\r\n}\r\nfunction getBackRef(model, key, refOptions) {\r\n    var type = getModelType(refOptions.model);\r\n    var collection = getModelCollection(model);\r\n    if (!collection) {\r\n        return null;\r\n    }\r\n    var backModels = collection\r\n        .findAll(type)\r\n        .filter(function (item) { return hasBackRef(item, refOptions.property, model); });\r\n    var backData = observable.array(backModels, { deep: false });\r\n    intercept(backData, function (change) { return partialBackRefUpdate(model, key, change); });\r\n    return backData;\r\n}\r\nfunction getNormalRef(model, key, refOptions) {\r\n    var value = storage.getModelDataKey(model, key);\r\n    var collection = getModelCollection(model);\r\n    if (!collection) {\r\n        return null;\r\n    }\r\n    var dataModels = mapItems(value, function (id) { return id ? collection.find(refOptions.model, id) : id; });\r\n    if (refOptions.type === ReferenceType.TO_MANY && !(dataModels instanceof Array)) {\r\n        dataModels = [dataModels];\r\n    }\r\n    if (dataModels instanceof Array) {\r\n        var data = observable.array(dataModels, { deep: false });\r\n        intercept(data, function (change) { return partialRefUpdate(model, key, change); });\r\n        return data;\r\n    }\r\n    return dataModels;\r\n}\r\nexport function getRef(model, key) {\r\n    var refOptions = storage.getModelReferenceOptions(model, key);\r\n    return (typeof refOptions.property === 'string')\r\n        ? getBackRef(model, key, refOptions)\r\n        : getNormalRef(model, key, refOptions);\r\n}\r\nfunction validateRef(refOptions, isArray, key) {\r\n    if (refOptions.type === ReferenceType.TO_ONE && isArray) {\r\n        throw error(REF_SINGLE, { key: key });\r\n    }\r\n    else if (refOptions.type === ReferenceType.TO_MANY && !isArray) {\r\n        throw error(REF_ARRAY, { key: key });\r\n    }\r\n    else if (refOptions.property) {\r\n        throw error(BACK_REF_READ_ONLY);\r\n    }\r\n}\r\nexport function updateRef(model, key, value) {\r\n    var refOptions = storage.getModelReferenceOptions(model, key);\r\n    var check = refOptions.type === ReferenceType.TO_MANY ? value || [] : value;\r\n    var isArray = check instanceof Array || isObservableArray(check);\r\n    validateRef(refOptions, isArray, key);\r\n    var collection = getModelCollection(model);\r\n    var ids = mapItems(value, function (ref) {\r\n        if (ref && collection) {\r\n            if (ref instanceof PureModel) {\r\n                var refType = getModelType(ref);\r\n                if (refType !== getModelType(refOptions.model)) {\r\n                    throw new Error(WRONG_REF_TYPE);\r\n                }\r\n            }\r\n            var instance = collection.find(refOptions.model, ref);\r\n            if (!instance && typeof ref === 'object') {\r\n                instance = collection.add(ref, refOptions.model);\r\n            }\r\n            return getModelId(instance || ref);\r\n        }\r\n        else if (ref instanceof PureModel) {\r\n            throw error(REF_NEEDS_COLLECTION);\r\n        }\r\n        return ref;\r\n    });\r\n    if (refOptions.type === ReferenceType.TO_MANY) {\r\n        ids = ids || [];\r\n    }\r\n    storage.setModelDataKey(model, key, ids);\r\n}\r\nfunction getModelRefsByType(model, type) {\r\n    var refs = getModelMetaKey(model, 'refs');\r\n    return Object.keys(refs)\r\n        .filter(function (key) { return !refs[key].property; })\r\n        .filter(function (key) { return getModelType(refs[key].model) === type; });\r\n}\r\nfunction updateModelReferences(model, newId, oldId, type) {\r\n    var collection = getModelCollection(model);\r\n    if (collection) {\r\n        var allModels = collection.getAllModels().map(function (item) {\r\n            getModelRefsByType(item, type).forEach(function (ref) {\r\n                var data = storage.getModelDataKey(item, ref);\r\n                if (data instanceof Array || isObservableArray(data)) {\r\n                    var targetIndex = data.indexOf(oldId);\r\n                    if (targetIndex !== -1) {\r\n                        data[targetIndex] = newId;\r\n                    }\r\n                }\r\n                else if (data === oldId) {\r\n                    storage.setModelDataKey(item, ref, newId);\r\n                }\r\n            });\r\n        });\r\n    }\r\n}\r\n/**\r\n * Updates the model identifier and all the existing references to the model\r\n *\r\n * @export\r\n * @param {PureModel} model Model to be updated\r\n * @param {IIdentifier} newId New model identifier\r\n */\r\nexport function updateModelId(model, newId) {\r\n    var collection = getModelCollection(model);\r\n    var oldId = getModelId(model);\r\n    var type = getModelType(model);\r\n    setModelMetaKey(model, 'id', newId);\r\n    var staticModel = model.constructor;\r\n    var modelId = storage.getModelClassMetaKey(staticModel, 'id');\r\n    if (modelId) {\r\n        setRefId(model, modelId, newId);\r\n    }\r\n    if (collection) {\r\n        // @ts-ignore - I'm bad and I should feel bad...\r\n        collection.__changeModelId(oldId, newId, type);\r\n    }\r\n    updateModelReferences(model, newId, oldId, type);\r\n}\r\n/**\r\n * Get the id of the referenced model\r\n *\r\n * @export\r\n * @param {PureModel} model Source model\r\n * @param {string} key Referenced model property name\r\n * @returns {IIdentifier} Referenced model id\r\n */\r\nexport function getRefId(model, key) {\r\n    return storage.getModelDataKey(model, key);\r\n}\r\n/**\r\n * Set the id of the referenced model\r\n *\r\n * @export\r\n * @param {PureModel} model Source model\r\n * @param {string} key Referenced model property name\r\n * @param {IIdentifier} value The new value\r\n * @returns {void} Referenced model id\r\n */\r\nexport function setRefId(model, key, value) {\r\n    storage.setModelDataKey(model, key, value);\r\n}\r\n//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmllbGRzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2hlbHBlcnMvbW9kZWwvZmllbGRzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxRQUFRLEVBQUUsSUFBSSxFQUFDLE1BQU0sWUFBWSxDQUFDO0FBQzFDLE9BQU8sRUFBNkIsU0FBUyxFQUFvQixpQkFBaUIsRUFBRSxVQUFVLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFFNUcsT0FBTyxFQUFDLFNBQVMsRUFBQyxNQUFNLHVCQUF1QixDQUFDO0FBQ2hELE9BQU8sRUFBQyxhQUFhLEVBQUMsTUFBTSwyQkFBMkIsQ0FBQztBQUN4RCxPQUFPLEVBQ0wsa0JBQWtCLEVBQ2xCLFdBQVcsRUFDWCxTQUFTLEVBQ1Qsb0JBQW9CLEVBQ3BCLFVBQVUsRUFDVixhQUFhLEVBQ2IsY0FBYyxHQUNmLE1BQU0sY0FBYyxDQUFDO0FBT3RCLE9BQU8sRUFBQyxTQUFTLEVBQUMsTUFBTSxpQkFBaUIsQ0FBQztBQUMxQyxPQUFPLEVBQUMsT0FBTyxFQUFDLE1BQU0sd0JBQXdCLENBQUM7QUFDL0MsT0FBTyxFQUFDLEtBQUssRUFBQyxNQUFNLFdBQVcsQ0FBQztBQUNoQyxPQUFPLEVBQUMsa0JBQWtCLEVBQUUsVUFBVSxFQUFFLGVBQWUsRUFBRSxZQUFZLEVBQUUsZUFBZSxFQUFDLE1BQU0sU0FBUyxDQUFDO0FBRXZHLDJCQUEyQixLQUFnQixFQUFFLEdBQVcsRUFBRSxZQUF1QjtJQUMvRSxJQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsd0JBQXdCLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ2hFLElBQU0sUUFBUSxHQUFHLFVBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUMxQyxJQUFNLElBQUksR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztJQUNqRCxJQUFJLFVBQVUsQ0FBQyxJQUFJLEtBQUssYUFBYSxDQUFDLE1B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LENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge21hcEl0ZW1zLCB3YXJufSBmcm9tICdkYXR4LXV0aWxzJztcbmltcG9ydCB7SUFycmF5Q2hhbmdlLCBJQXJyYXlTcGxpY2UsIGludGVyY2VwdCwgSU9ic2VydmFibGVBcnJheSwgaXNPYnNlcnZhYmxlQXJyYXksIG9ic2VydmFibGV9IGZyb20gJ21vYngnO1xuXG5pbXBvcnQge0ZpZWxkVHlwZX0gZnJvbSAnLi4vLi4vZW51bXMvRmllbGRUeXBlJztcbmltcG9ydCB7UmVmZXJlbmNlVHlwZX0gZnJvbSAnLi4vLi4vZW51bXMvUmVmZXJlbmNlVHlwZSc7XG5pbXBvcnQge1xuICBCQUNLX1JFRl9SRUFEX09OTFksXG4gIElEX1JFQURPTkxZLFxuICBSRUZfQVJSQVksXG4gIFJFRl9ORUVEU19DT0xMRUNUSU9OLFxuICBSRUZfU0lOR0xFLFxuICBUWVBFX1JFQURPTkxZLFxuICBXUk9OR19SRUZfVFlQRSxcbn0gZnJvbSAnLi4vLi4vZXJyb3JzJztcbmltcG9ydCB7SUlkZW50aWZpZXJ9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvSUlkZW50aWZpZXInO1xuaW1wb3J0IHtJUmVmZXJlbmNlT3B0aW9uc30gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9JUmVmZXJlbmNlT3B0aW9ucyc7XG5pbXBvcnQge0lUeXBlfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL0lUeXBlJztcbmltcG9ydCB7VENoYW5nZX0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9UQ2hhbmdlJztcbmltcG9ydCB7VFJlZlZhbHVlfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL1RSZWZWYWx1ZSc7XG5pbXBvcnQge1B1cmVDb2xsZWN0aW9ufSBmcm9tICcuLi8uLi9QdXJlQ29sbGVjdGlvbic7XG5pbXBvcnQge1B1cmVNb2RlbH0gZnJvbSAnLi4vLi4vUHVyZU1vZGVsJztcbmltcG9ydCB7c3RvcmFnZX0gZnJvbSAnLi4vLi4vc2VydmljZXMvc3RvcmFnZSc7XG5pbXBvcnQge2Vycm9yfSBmcm9tICcuLi9mb3JtYXQnO1xuaW1wb3J0IHtnZXRNb2RlbENvbGxlY3Rpb24sIGdldE1vZGVsSWQsIGdldE1vZGVsTWV0YUtleSwgZ2V0TW9kZWxUeXBlLCBzZXRNb2RlbE1ldGFLZXl9IGZyb20gJy4vdXRpbHMnO1xuXG5mdW5jdGlvbiBtb2RlbEFkZFJlZmVyZW5jZShtb2RlbDogUHVyZU1vZGVsLCBrZXk6IHN0cmluZywgbmV3UmVmZXJlbmNlOiBQdXJlTW9kZWwpIHtcbiAgY29uc3QgcmVmT3B0aW9ucyA9IHN0b3JhZ2UuZ2V0TW9kZWxSZWZlcmVuY2VPcHRpb25zKG1vZGVsLCBrZXkpO1xuICBjb25zdCBuZXdSZWZJZCA9IGdldE1vZGVsSWQobmV3UmVmZXJlbmNlKTtcbiAgY29uc3QgZGF0YSA9IHN0b3JhZ2UuZ2V0TW9kZWxEYXRhS2V5KG1vZGVsLCBrZXkpO1xuICBpZiAocmVmT3B0aW9ucy50eXBlID09PSBSZWZlcmVuY2VUeXBlLlRPX09ORSkge1xuICAgIHN0b3JhZ2Uuc2V0TW9kZWxEYXRhS2V5KG1vZGVsLCBrZXksIG5ld1JlZklkKTtcbiAgfSBlbHNlIGlmIChyZWZPcHRpb25zLnR5cGUgPT09IFJlZmVyZW5jZVR5cGUuVE9fTUFOWSB8fCBpc09ic2VydmFibGVBcnJheShkYXRhKSkge1xuICAgIGRhdGEucHVzaChuZXdSZWZJZCk7XG4gIH0gZWxzZSB7XG4gICAgc3RvcmFnZS5zZXRNb2RlbERhdGFLZXkobW9kZWwsIGtleSwgbmV3UmVmZXJlbmNlKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBtb2RlbFJlbW92ZVJlZmVyZW5jZShtb2RlbDogUHVyZU1vZGVsLCBrZXk6IHN0cmluZywgb2xkUmVmZXJlbmNlOiBQdXJlTW9kZWwpIHtcbiAgY29uc3QgcmVmT3B0aW9ucyA9IHN0b3JhZ2UuZ2V0TW9kZWxSZWZlcmVuY2VPcHRpb25zKG1vZGVsLCBrZXkpO1xuICBjb25zdCBvbGRSZWZJZCA9IGdldE1vZGVsSWQob2xkUmVmZXJlbmNlKTtcbiAgY29uc3QgZGF0YSA9IHN0b3JhZ2UuZ2V0TW9kZWxEYXRhS2V5KG1vZGVsLCBrZXkpO1xuICBpZiAocmVmT3B0aW9ucy50eXBlID09PSBSZWZlcmVuY2VUeXBlLlRPX09ORSkge1xuICAgIHN0b3JhZ2Uuc2V0TW9kZWxEYXRhS2V5KG1vZGVsLCBrZXksIG51bGwpO1xuICB9IGVsc2UgaWYgKHJlZk9wdGlvbnMudHlwZSA9PT0gUmVmZXJlbmNlVHlwZS5UT19NQU5ZIHx8IGlzT2JzZXJ2YWJsZUFycmF5KGRhdGEpKSB7XG4gICAgZGF0YS5yZW1vdmUob2xkUmVmSWQpO1xuICB9IGVsc2Uge1xuICAgIHN0b3JhZ2Uuc2V0TW9kZWxEYXRhS2V5KG1vZGVsLCBrZXksIG51bGwpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGVuc3VyZU1vZGVsKHJlZk9wdGlvbnM6IElSZWZlcmVuY2VPcHRpb25zLCBjb2xsZWN0aW9uPzogUHVyZUNvbGxlY3Rpb24pIHtcbiAgcmV0dXJuIChkYXRhKSA9PiB7XG4gICAgbGV0IG1vZGVsID0gZGF0YTtcbiAgICBpZiAoIShkYXRhIGluc3RhbmNlb2YgUHVyZU1vZGVsKSAmJiB0eXBlb2YgZGF0YSA9PT0gJ29iamVjdCcpIHtcbiAgICAgIGlmICghY29sbGVjdGlvbikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoUkVGX05FRURTX0NPTExFQ1RJT04pO1xuICAgICAgfVxuICAgICAgbW9kZWwgPSBjb2xsZWN0aW9uLmFkZChkYXRhLCByZWZPcHRpb25zLm1vZGVsKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZ2V0TW9kZWxJZChtb2RlbCk7XG4gIH07XG59XG5cbmZ1bmN0aW9uIHBhcnRpYWxSZWZVcGRhdGUobW9kZWw6IFB1cmVNb2RlbCwga2V5OiBzdHJpbmcsIGNoYW5nZTogVENoYW5nZSkge1xuICBjb25zdCByZWZPcHRpb25zID0gc3RvcmFnZS5nZXRNb2RlbFJlZmVyZW5jZU9wdGlvbnMobW9kZWwsIGtleSk7XG4gIGNvbnN0IGRhdGEgPSBzdG9yYWdlLmdldE1vZGVsRGF0YUtleShtb2RlbCwga2V5KTtcbiAgY29uc3QgY29sbGVjdGlvbiA9IGdldE1vZGVsQ29sbGVjdGlvbihtb2RlbCk7XG5cbiAgaWYgKGNoYW5nZS50eXBlID09PSAnc3BsaWNlJykge1xuICAgIGNvbnN0IGFkZGVkID0gY2hhbmdlLmFkZGVkLm1hcChlbnN1cmVNb2RlbChyZWZPcHRpb25zLCBjb2xsZWN0aW9uKSk7XG4gICAgZGF0YS5zcGxpY2UoY2hhbmdlLmluZGV4LCBjaGFuZ2UucmVtb3ZlZENvdW50LCAuLi5hZGRlZCk7XG5cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGRhdGFbY2hhbmdlLmluZGV4XSA9IGVuc3VyZU1vZGVsKHJlZk9wdGlvbnMsIGNvbGxlY3Rpb24pKGNoYW5nZS5uZXdWYWx1ZSk7XG5cbiAgcmV0dXJuIG51bGw7XG59XG5cbmZ1bmN0aW9uIGJhY2tSZWZTcGxpY2UobW9kZWw6IFB1cmVNb2RlbCwga2V5OiBzdHJpbmcsIGNoYW5nZTogSUFycmF5U3BsaWNlPFB1cmVNb2RlbD4sIHJlZk9wdGlvbnM6IElSZWZlcmVuY2VPcHRpb25zKSB7XG4gIGNvbnN0IHByb3BlcnR5ID0gcmVmT3B0aW9ucy5wcm9wZXJ0eSBhcyBzdHJpbmc7XG4gIGNoYW5nZS5hZGRlZC5mb3JFYWNoKChpdGVtKSA9PiB7XG4gICAgbW9kZWxBZGRSZWZlcmVuY2UoaXRlbSwgcHJvcGVydHksIG1vZGVsKTtcbiAgfSk7XG4gIGNvbnN0IHJlbW92ZWQgPSBtb2RlbFtrZXldLnNsaWNlKGNoYW5nZS5pbmRleCwgY2hhbmdlLmluZGV4ICsgY2hhbmdlLnJlbW92ZWRDb3VudCk7XG4gIHJlbW92ZWQuZm9yRWFjaCgoaXRlbSkgPT4ge1xuICAgIG1vZGVsUmVtb3ZlUmVmZXJlbmNlKGl0ZW0sIHByb3BlcnR5LCBtb2RlbCk7XG4gIH0pO1xuXG4gIHJldHVybiBudWxsO1xufVxuXG5mdW5jdGlvbiBiYWNrUmVmQ2hhbmdlKG1vZGVsOiBQdXJlTW9kZWwsIGtleTogc3RyaW5nLCBjaGFuZ2U6IElBcnJheUNoYW5nZTxQdXJlTW9kZWw+LCByZWZPcHRpb25zOiBJUmVmZXJlbmNlT3B0aW9ucykge1xuICBjb25zdCBwcm9wZXJ0eSA9IHJlZk9wdGlvbnMucHJvcGVydHkgYXMgc3RyaW5nO1xuICBjb25zdCBvbGRWYWx1ZSA9IG1vZGVsW2tleV0ubGVuZ3RoID4gY2hhbmdlLmluZGV4ID8gbW9kZWxba2V5XVtjaGFuZ2UuaW5kZXhdIDogbnVsbDtcbiAgaWYgKGNoYW5nZS5uZXdWYWx1ZSkge1xuICAgIG1vZGVsQWRkUmVmZXJlbmNlKGNoYW5nZS5uZXdWYWx1ZSwgcHJvcGVydHksIG1vZGVsKTtcbiAgfVxuICBpZiAob2xkVmFsdWUpIHtcbiAgICBtb2RlbFJlbW92ZVJlZmVyZW5jZShvbGRWYWx1ZSwgcHJvcGVydHksIG1vZGVsKTtcbiAgfVxuXG4gIHdhcm4oYFRoaXMgc2hvdWxkbid0IGhhdmUgaGFwcGVuZWQuIFBsZWFzZSBvcGVuIGFuIGlzc3VlOiBodHRwczovL2dpdGh1Yi5jb20vaW5maW51bS9kYXR4L2lzc3Vlcy9uZXdgKTtcblxuICByZXR1cm4gbnVsbDtcbn1cblxuZnVuY3Rpb24gcGFydGlhbEJhY2tSZWZVcGRhdGUobW9kZWw6IFB1cmVNb2RlbCwga2V5OiBzdHJpbmcsIGNoYW5nZTogVENoYW5nZSkge1xuICBjb25zdCByZWZPcHRpb25zID0gc3RvcmFnZS5nZXRNb2RlbFJlZmVyZW5jZU9wdGlvbnMobW9kZWwsIGtleSk7XG5cbiAgaWYgKGNoYW5nZS50eXBlID09PSAnc3BsaWNlJykge1xuICAgIHJldHVybiBiYWNrUmVmU3BsaWNlKG1vZGVsLCBrZXksIGNoYW5nZSwgcmVmT3B0aW9ucyk7XG4gIH1cblxuICByZXR1cm4gYmFja1JlZkNoYW5nZShtb2RlbCwga2V5LCBjaGFuZ2UsIHJlZk9wdGlvbnMpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0RmllbGQobW9kZWw6IFB1cmVNb2RlbCwga2V5OiBzdHJpbmcpIHtcbiAgcmV0dXJuIHN0b3JhZ2UuZ2V0TW9kZWxEYXRhS2V5KG1vZGVsLCBrZXkpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdXBkYXRlRmllbGQobW9kZWw6IFB1cmVNb2RlbCwga2V5OiBzdHJpbmcsIHZhbHVlOiBhbnksIHR5cGU6IEZpZWxkVHlwZSkge1xuICBpZiAodHlwZSA9PT0gRmllbGRUeXBlLlRZUEUpIHtcbiAgICB0aHJvdyBlcnJvcihUWVBFX1JFQURPTkxZKTtcbiAgfSBlbHNlIGlmICh0eXBlID09PSBGaWVsZFR5cGUuSUQpIHtcbiAgICB0aHJvdyBlcnJvcihJRF9SRUFET05MWSk7XG4gIH1cblxuICBjb25zdCByZWZzID0gZ2V0TW9kZWxNZXRhS2V5KG1vZGVsLCAncmVmcycpO1xuICBpZiAoa2V5IGluIHJlZnMpIHtcbiAgICB1cGRhdGVSZWYobW9kZWwsIGtleSwgdmFsdWUpO1xuICB9IGVsc2Uge1xuICAgIHN0b3JhZ2Uuc2V0TW9kZWxEYXRhS2V5KG1vZGVsLCBrZXksIHZhbHVlKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBoYXNCYWNrUmVmKGl0ZW06IFB1cmVNb2RlbCwgcHJvcGVydHk6IHN0cmluZywgdGFyZ2V0OiBQdXJlTW9kZWwpOiBib29sZWFuIHtcbiAgaWYgKGl0ZW1bcHJvcGVydHldID09PSBudWxsIHx8IGl0ZW1bcHJvcGVydHldID09PSB1bmRlZmluZWQpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH0gZWxzZSBpZiAoaXRlbVtwcm9wZXJ0eV0gaW5zdGFuY2VvZiBQdXJlTW9kZWwpIHtcbiAgICByZXR1cm4gaXRlbVtwcm9wZXJ0eV0gPT09IHRhcmdldDtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gaXRlbVtwcm9wZXJ0eV0uaW5kZXhPZih0YXJnZXQpICE9PSAtMTtcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRCYWNrUmVmKG1vZGVsOiBQdXJlTW9kZWwsIGtleTogc3RyaW5nLCByZWZPcHRpb25zOiBJUmVmZXJlbmNlT3B0aW9ucyk6IFB1cmVNb2RlbHxBcnJheTxQdXJlTW9kZWw+fG51bGwge1xuICBjb25zdCB0eXBlID0gZ2V0TW9kZWxUeXBlKHJlZk9wdGlvbnMubW9kZWwpO1xuXG4gIGNvbnN0IGNvbGxlY3Rpb24gPSBnZXRNb2RlbENvbGxlY3Rpb24obW9kZWwpO1xuICBpZiAoIWNvbGxlY3Rpb24pIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGNvbnN0IGJhY2tNb2RlbHMgPSBjb2xsZWN0aW9uXG4gICAgLmZpbmRBbGwodHlwZSlcbiAgICAuZmlsdGVyKChpdGVtKSA9PiBoYXNCYWNrUmVmKGl0ZW0sIHJlZk9wdGlvbnMucHJvcGVydHkgYXMgc3RyaW5nLCBtb2RlbCkpO1xuXG4gIGNvbnN0IGJhY2tEYXRhOiBJT2JzZXJ2YWJsZUFycmF5PFB1cmVNb2RlbD4gPSBvYnNlcnZhYmxlLmFycmF5KGJhY2tNb2RlbHMsIHtkZWVwOiBmYWxzZX0pO1xuICBpbnRlcmNlcHQoYmFja0RhdGEsIChjaGFuZ2U6IFRDaGFuZ2UpID0+IHBhcnRpYWxCYWNrUmVmVXBkYXRlKG1vZGVsLCBrZXksIGNoYW5nZSkpO1xuXG4gIHJldHVybiBiYWNrRGF0YTtcbn1cblxuZnVuY3Rpb24gZ2V0Tm9ybWFsUmVmKG1vZGVsOiBQdXJlTW9kZWwsIGtleTogc3RyaW5nLCByZWZPcHRpb25zOiBJUmVmZXJlbmNlT3B0aW9ucyk6IFB1cmVNb2RlbHxBcnJheTxQdXJlTW9kZWw+fG51bGwge1xuICBjb25zdCB2YWx1ZSA9IHN0b3JhZ2UuZ2V0TW9kZWxEYXRhS2V5KG1vZGVsLCBrZXkpO1xuICBjb25zdCBjb2xsZWN0aW9uID0gZ2V0TW9kZWxDb2xsZWN0aW9uKG1vZGVsKTtcbiAgaWYgKCFjb2xsZWN0aW9uKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBsZXQgZGF0YU1vZGVscyA9IG1hcEl0ZW1zKHZhbHVlLCAoaWQpID0+IGlkID8gY29sbGVjdGlvbi5maW5kKHJlZk9wdGlvbnMubW9kZWwsIGlkKSA6IGlkKTtcbiAgaWYgKHJlZk9wdGlvbnMudHlwZSA9PT0gUmVmZXJlbmNlVHlwZS5UT19NQU5ZICYmICEoZGF0YU1vZGVscyBpbnN0YW5jZW9mIEFycmF5KSkge1xuICAgIGRhdGFNb2RlbHMgPSBbZGF0YU1vZGVsc107XG4gIH1cbiAgaWYgKGRhdGFNb2RlbHMgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgIGNvbnN0IGRhdGE6IElPYnNlcnZhYmxlQXJyYXk8UHVyZU1vZGVsPiA9IG9ic2VydmFibGUuYXJyYXkoZGF0YU1vZGVscywge2RlZXA6IGZhbHNlfSk7XG4gICAgaW50ZXJjZXB0KGRhdGEsIChjaGFuZ2U6IFRDaGFuZ2UpID0+IHBhcnRpYWxSZWZVcGRhdGUobW9kZWwsIGtleSwgY2hhbmdlKSk7XG5cbiAgICByZXR1cm4gZGF0YTtcbiAgfVxuXG4gIHJldHVybiBkYXRhTW9kZWxzO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0UmVmKG1vZGVsOiBQdXJlTW9kZWwsIGtleTogc3RyaW5nKTogUHVyZU1vZGVsfEFycmF5PFB1cmVNb2RlbD58bnVsbCB7XG4gIGNvbnN0IHJlZk9wdGlvbnMgPSBzdG9yYWdlLmdldE1vZGVsUmVmZXJlbmNlT3B0aW9ucyhtb2RlbCwga2V5KTtcblxuICByZXR1cm4gKHR5cGVvZiByZWZPcHRpb25zLnByb3BlcnR5ID09PSAnc3RyaW5nJylcbiAgICA/IGdldEJhY2tSZWYobW9kZWwsIGtleSwgcmVmT3B0aW9ucylcbiAgICA6IGdldE5vcm1hbFJlZihtb2RlbCwga2V5LCByZWZPcHRpb25zKTtcbn1cblxuZnVuY3Rpb24gdmFsaWRhdGVSZWYocmVmT3B0aW9uczogSVJlZmVyZW5jZU9wdGlvbnMsIGlzQXJyYXk6IGJvb2xlYW4sIGtleTogc3RyaW5nKSB7XG4gIGlmIChyZWZPcHRpb25zLnR5cGUgPT09IFJlZmVyZW5jZVR5cGUuVE9fT05FICYmIGlzQXJyYXkpIHtcbiAgICB0aHJvdyBlcnJvcihSRUZfU0lOR0xFLCB7a2V5fSk7XG4gIH0gZWxzZSBpZiAocmVmT3B0aW9ucy50eXBlID09PSBSZWZlcmVuY2VUeXBlLlRPX01BTlkgJiYgIWlzQXJyYXkpIHtcbiAgICB0aHJvdyBlcnJvcihSRUZfQVJSQVksIHtrZXl9KTtcbiAgfSBlbHNlIGlmIChyZWZPcHRpb25zLnByb3BlcnR5KSB7XG4gICAgdGhyb3cgZXJyb3IoQkFDS19SRUZfUkVBRF9PTkxZKTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gdXBkYXRlUmVmKG1vZGVsOiBQdXJlTW9kZWwsIGtleTogc3RyaW5nLCB2YWx1ZTogVFJlZlZhbHVlKSB7XG4gIGNvbnN0IHJlZk9wdGlvbnMgPSBzdG9yYWdlLmdldE1vZGVsUmVmZXJlbmNlT3B0aW9ucyhtb2RlbCwga2V5KTtcblxuICBjb25zdCBjaGVjayA9IHJlZk9wdGlvbnMudHlwZSA9PT0gUmVmZXJlbmNlVHlwZS5UT19NQU5ZID8gdmFsdWUgfHwgW10gOiB2YWx1ZTtcbiAgY29uc3QgaXNBcnJheSA9IGNoZWNrIGluc3RhbmNlb2YgQXJyYXkgfHwgaXNPYnNlcnZhYmxlQXJyYXkoY2hlY2spO1xuICB2YWxpZGF0ZVJlZihyZWZPcHRpb25zLCBpc0FycmF5LCBrZXkpO1xuXG4gIGNvbnN0IGNvbGxlY3Rpb24gPSBnZXRNb2RlbENvbGxlY3Rpb24obW9kZWwpO1xuXG4gIGxldCBpZHM6IElJZGVudGlmaWVyfEFycmF5PElJZGVudGlmaWVyPnxudWxsID0gbWFwSXRlbXModmFsdWUsIChyZWY6IElJZGVudGlmaWVyfFB1cmVNb2RlbCkgPT4ge1xuICAgIGlmIChyZWYgJiYgY29sbGVjdGlvbikge1xuICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIFB1cmVNb2RlbCkge1xuICAgICAgICBjb25zdCByZWZUeXBlID0gZ2V0TW9kZWxUeXBlKHJlZik7XG4gICAgICAgIGlmIChyZWZUeXBlICE9PSBnZXRNb2RlbFR5cGUocmVmT3B0aW9ucy5tb2RlbCkpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoV1JPTkdfUkVGX1RZUEUpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGxldCBpbnN0YW5jZSA9IGNvbGxlY3Rpb24uZmluZChyZWZPcHRpb25zLm1vZGVsLCByZWYpO1xuICAgICAgaWYgKCFpbnN0YW5jZSAmJiB0eXBlb2YgcmVmID09PSAnb2JqZWN0Jykge1xuICAgICAgICBpbnN0YW5jZSA9IGNvbGxlY3Rpb24uYWRkKHJlZiwgcmVmT3B0aW9ucy5tb2RlbCk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBnZXRNb2RlbElkKGluc3RhbmNlIHx8IHJlZik7XG4gICAgfSBlbHNlIGlmIChyZWYgaW5zdGFuY2VvZiBQdXJlTW9kZWwpIHtcbiAgICAgIHRocm93IGVycm9yKFJFRl9ORUVEU19DT0xMRUNUSU9OKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVmO1xuICB9KTtcblxuICBpZiAocmVmT3B0aW9ucy50eXBlID09PSBSZWZlcmVuY2VUeXBlLlRPX01BTlkpIHtcbiAgICBpZHMgPSBpZHMgfHwgW107XG4gIH1cblxuICBzdG9yYWdlLnNldE1vZGVsRGF0YUtleShtb2RlbCwga2V5LCBpZHMpO1xufVxuXG5mdW5jdGlvbiBnZXRNb2RlbFJlZnNCeVR5cGUobW9kZWw6IFB1cmVNb2RlbCwgdHlwZTogSVR5cGUpIHtcbiAgY29uc3QgcmVmcyA9IGdldE1vZGVsTWV0YUtleShtb2RlbCwgJ3JlZnMnKTtcblxuICByZXR1cm4gT2JqZWN0LmtleXMocmVmcylcbiAgICAuZmlsdGVyKChrZXkpID0+ICFyZWZzW2tleV0ucHJvcGVydHkpXG4gICAgLmZpbHRlcigoa2V5KSA9PiBnZXRNb2RlbFR5cGUocmVmc1trZXldLm1vZGVsKSA9PT0gdHlwZSk7XG59XG5cbmZ1bmN0aW9uIHVwZGF0ZU1vZGVsUmVmZXJlbmNlcyhtb2RlbDogUHVyZU1vZGVsLCBuZXdJZDogSUlkZW50aWZpZXIsIG9sZElkOiBJSWRlbnRpZmllciwgdHlwZTogSVR5cGUpIHtcbiAgY29uc3QgY29sbGVjdGlvbiA9IGdldE1vZGVsQ29sbGVjdGlvbihtb2RlbCk7XG4gIGlmIChjb2xsZWN0aW9uKSB7XG4gICAgY29uc3QgYWxsTW9kZWxzID0gY29sbGVjdGlvbi5nZXRBbGxNb2RlbHMoKS5tYXAoKGl0ZW0pID0+IHtcbiAgICAgIGdldE1vZGVsUmVmc0J5VHlwZShpdGVtLCB0eXBlKS5mb3JFYWNoKChyZWYpID0+IHtcbiAgICAgICAgY29uc3QgZGF0YSA9IHN0b3JhZ2UuZ2V0TW9kZWxEYXRhS2V5KGl0ZW0sIHJlZik7XG4gICAgICAgIGlmIChkYXRhIGluc3RhbmNlb2YgQXJyYXkgfHwgaXNPYnNlcnZhYmxlQXJyYXkoZGF0YSkpIHtcbiAgICAgICAgICBjb25zdCB0YXJnZXRJbmRleCA9IGRhdGEuaW5kZXhPZihvbGRJZCk7XG4gICAgICAgICAgaWYgKHRhcmdldEluZGV4ICE9PSAtMSkge1xuICAgICAgICAgICAgZGF0YVt0YXJnZXRJbmRleF0gPSBuZXdJZDtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAoZGF0YSA9PT0gb2xkSWQpIHtcbiAgICAgICAgICBzdG9yYWdlLnNldE1vZGVsRGF0YUtleShpdGVtLCByZWYsIG5ld0lkKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cbn1cblxuLyoqXG4gKiBVcGRhdGVzIHRoZSBtb2RlbCBpZGVudGlmaWVyIGFuZCBhbGwgdGhlIGV4aXN0aW5nIHJlZmVyZW5jZXMgdG8gdGhlIG1vZGVsXG4gKlxuICogQGV4cG9ydFxuICogQHBhcmFtIHtQdXJlTW9kZWx9IG1vZGVsIE1vZGVsIHRvIGJlIHVwZGF0ZWRcbiAqIEBwYXJhbSB7SUlkZW50aWZpZXJ9IG5ld0lkIE5ldyBtb2RlbCBpZGVudGlmaWVyXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB1cGRhdGVNb2RlbElkKG1vZGVsOiBQdXJlTW9kZWwsIG5ld0lkOiBJSWRlbnRpZmllcik6IHZvaWQge1xuICBjb25zdCBjb2xsZWN0aW9uID0gZ2V0TW9kZWxDb2xsZWN0aW9uKG1vZGVsKTtcblxuICBjb25zdCBvbGRJZCA9IGdldE1vZGVsSWQobW9kZWwpO1xuICBjb25zdCB0eXBlID0gZ2V0TW9kZWxUeXBlKG1vZGVsKTtcbiAgc2V0TW9kZWxNZXRhS2V5KG1vZGVsLCAnaWQnLCBuZXdJZCk7XG5cbiAgY29uc3Qgc3RhdGljTW9kZWwgPSBtb2RlbC5jb25zdHJ1Y3RvciBhcyB0eXBlb2YgUHVyZU1vZGVsO1xuICBjb25zdCBtb2RlbElkID0gc3RvcmFnZS5nZXRNb2RlbENsYXNzTWV0YUtleShzdGF0aWNNb2RlbCwgJ2lkJyk7XG4gIGlmIChtb2RlbElkKSB7XG4gICAgc2V0UmVmSWQobW9kZWwsIG1vZGVsSWQsIG5ld0lkKTtcbiAgfVxuXG4gIGlmIChjb2xsZWN0aW9uKSB7XG4gICAgLy8gQHRzLWlnbm9yZSAtIEknbSBiYWQgYW5kIEkgc2hvdWxkIGZlZWwgYmFkLi4uXG4gICAgY29sbGVjdGlvbi5fX2NoYW5nZU1vZGVsSWQob2xkSWQsIG5ld0lkLCB0eXBlKTtcbiAgfVxuXG4gIHVwZGF0ZU1vZGVsUmVmZXJlbmNlcyhtb2RlbCwgbmV3SWQsIG9sZElkLCB0eXBlKTtcbn1cblxuLyoqXG4gKiBHZXQgdGhlIGlkIG9mIHRoZSByZWZlcmVuY2VkIG1vZGVsXG4gKlxuICogQGV4cG9ydFxuICogQHBhcmFtIHtQdXJlTW9kZWx9IG1vZGVsIFNvdXJjZSBtb2RlbFxuICogQHBhcmFtIHtzdHJpbmd9IGtleSBSZWZlcmVuY2VkIG1vZGVsIHByb3BlcnR5IG5hbWVcbiAqIEByZXR1cm5zIHtJSWRlbnRpZmllcn0gUmVmZXJlbmNlZCBtb2RlbCBpZFxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0UmVmSWQobW9kZWw6IFB1cmVNb2RlbCwga2V5OiBzdHJpbmcpOiBJSWRlbnRpZmllcnxBcnJheTxJSWRlbnRpZmllcj4ge1xuICByZXR1cm4gc3RvcmFnZS5nZXRNb2RlbERhdGFLZXkobW9kZWwsIGtleSk7XG59XG5cbi8qKlxuICogU2V0IHRoZSBpZCBvZiB0aGUgcmVmZXJlbmNlZCBtb2RlbFxuICpcbiAqIEBleHBvcnRcbiAqIEBwYXJhbSB7UHVyZU1vZGVsfSBtb2RlbCBTb3VyY2UgbW9kZWxcbiAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgUmVmZXJlbmNlZCBtb2RlbCBwcm9wZXJ0eSBuYW1lXG4gKiBAcGFyYW0ge0lJZGVudGlmaWVyfSB2YWx1ZSBUaGUgbmV3IHZhbHVlXG4gKiBAcmV0dXJucyB7dm9pZH0gUmVmZXJlbmNlZCBtb2RlbCBpZFxuICovXG5leHBvcnQgZnVuY3Rpb24gc2V0UmVmSWQobW9kZWw6IFB1cmVNb2RlbCwga2V5OiBzdHJpbmcsIHZhbHVlOiBJSWRlbnRpZmllcnxBcnJheTxJSWRlbnRpZmllcj4pOiB2b2lkIHtcbiAgc3RvcmFnZS5zZXRNb2RlbERhdGFLZXkobW9kZWwsIGtleSwgdmFsdWUpO1xufVxuIl19","dts":{"name":"/Users/darko/Projects/mobx/datx/packages/datx/helpers/model/fields.d.ts","text":"import { FieldType } from '../../enums/FieldType';\r\nimport { IIdentifier } from '../../interfaces/IIdentifier';\r\nimport { TRefValue } from '../../interfaces/TRefValue';\r\nimport { PureModel } from '../../PureModel';\r\nexport declare function getField(model: PureModel, key: string): any;\r\nexport declare function updateField(model: PureModel, key: string, value: any, type: FieldType): void;\r\nexport declare function getRef(model: PureModel, key: string): PureModel | Array<PureModel> | null;\r\nexport declare function updateRef(model: PureModel, key: string, value: TRefValue): void;\r\n/**\r\n * Updates the model identifier and all the existing references to the model\r\n *\r\n * @export\r\n * @param {PureModel} model Model to be updated\r\n * @param {IIdentifier} newId New model identifier\r\n */\r\nexport declare function updateModelId(model: PureModel, newId: IIdentifier): void;\r\n/**\r\n * Get the id of the referenced model\r\n *\r\n * @export\r\n * @param {PureModel} model Source model\r\n * @param {string} key Referenced model property name\r\n * @returns {IIdentifier} Referenced model id\r\n */\r\nexport declare function getRefId(model: PureModel, key: string): IIdentifier | Array<IIdentifier>;\r\n/**\r\n * Set the id of the referenced model\r\n *\r\n * @export\r\n * @param {PureModel} model Source model\r\n * @param {string} key Referenced model property name\r\n * @param {IIdentifier} value The new value\r\n * @returns {void} Referenced model id\r\n */\r\nexport declare function setRefId(model: PureModel, key: string, value: IIdentifier | Array<IIdentifier>): void;\r\n"}}
