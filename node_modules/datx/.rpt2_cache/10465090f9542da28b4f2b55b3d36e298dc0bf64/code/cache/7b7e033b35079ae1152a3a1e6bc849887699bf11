{"code":"import * as tslib_1 from \"tslib\";\r\nimport { action, computed, extendObservable, observable, set } from 'mobx';\r\nimport { MODEL_SINGLE_COLLECTION, UNDEFINED_TYPE, VIEW_NAME_TAKEN } from './errors';\r\nimport { initModels, isSelectorFunction, upsertModel } from './helpers/collection';\r\nimport { error } from './helpers/format';\r\nimport { getModelCollection, getModelId, getModelType, modelToJSON, setModelMetaKey, updateModel, } from './helpers/model/utils';\r\nimport { PureModel } from './PureModel';\r\nimport { View } from './View';\r\nvar PureCollection = /** @class */ (function () {\r\n    function PureCollection(data) {\r\n        if (data === void 0) { data = []; }\r\n        var _this = this;\r\n        this.__data = observable.array([], { deep: false });\r\n        this.__views = [];\r\n        this.__dataMap = {};\r\n        this.__dataList = {};\r\n        extendObservable(this, {});\r\n        if (data instanceof Array) {\r\n            this.insert(data);\r\n        }\r\n        else if (data && 'models' in data) {\r\n            this.insert(data.models);\r\n        }\r\n        var staticCollection = this.constructor;\r\n        var initViews = (data && 'views' in data) ? data.views : {};\r\n        Object.keys(staticCollection.views).forEach(function (key) {\r\n            var view = staticCollection.views[key];\r\n            var init = initViews[key] || view;\r\n            _this.addView(key, init.modelType, {\r\n                mixins: view.mixins,\r\n                models: init.models || [],\r\n                sortMethod: view.sortMethod,\r\n                unique: init.unique,\r\n            });\r\n        });\r\n    }\r\n    /**\r\n     * Function for inserting raw models into the collection. Used when hydrating the collection\r\n     *\r\n     * @param {Array<IRawModel>} data Raw model data\r\n     * @returns {Array<PureModel>} A list of initialized models\r\n     * @memberof Collection\r\n     */\r\n    PureCollection.prototype.insert = function (data) {\r\n        var models = initModels(this, data);\r\n        this.__insertModel(models);\r\n        return models;\r\n    };\r\n    PureCollection.prototype.add = function (data, model) {\r\n        return (data instanceof Array) ? this.__addArray(data, model) : this.__addSingle(data, model);\r\n    };\r\n    PureCollection.prototype.find = function (model, id) {\r\n        if (id instanceof PureModel) {\r\n            return id;\r\n        }\r\n        return isSelectorFunction(model)\r\n            ? (this.__data.find(model) || null)\r\n            : (this.__findByType(model, id) || null);\r\n    };\r\n    /**\r\n     * Filter models based on a matching function\r\n     *\r\n     * @param {TFilterFn} test Function used to match the models\r\n     * @returns {(PureModel|null)} The matching models\r\n     * @memberof Collection\r\n     */\r\n    PureCollection.prototype.filter = function (test) {\r\n        return this.__data.filter(test);\r\n    };\r\n    /**\r\n     * Find all matching models or all models if no type is given\r\n     *\r\n     * @param {(IType|typeof PureModel)} [model] Model type to select\r\n     * @returns {Array<PureModel>} List of matching models\r\n     * @memberof Collection\r\n     */\r\n    PureCollection.prototype.findAll = function (model) {\r\n        if (model) {\r\n            var type = getModelType(model);\r\n            if (!(type in this.__dataList)) {\r\n                set(this.__dataList, (_a = {}, _a[type] = observable.array([]), _a));\r\n            }\r\n            return this.__dataList[type];\r\n        }\r\n        return this.__data;\r\n        var _a;\r\n    };\r\n    /**\r\n     * Check if a model is in the collection\r\n     *\r\n     * @param {PureModel} model Model to check\r\n     * @returns {boolean} The given model is in the collection\r\n     * @memberof Collection\r\n     */\r\n    PureCollection.prototype.hasItem = function (model) {\r\n        var id = getModelId(model);\r\n        return Boolean(this.find(model, id));\r\n    };\r\n    PureCollection.prototype.remove = function (obj, id) {\r\n        var model = typeof obj === 'object' ? obj : this.find(obj, id);\r\n        if (model) {\r\n            this.__removeModel(model);\r\n        }\r\n    };\r\n    /**\r\n     * Remove all models of the given model type from the collection\r\n     *\r\n     * @param {(IType|typeof PureModel)} type Model type\r\n     * @memberof Collection\r\n     */\r\n    PureCollection.prototype.removeAll = function (type) {\r\n        this.__removeModel(this.findAll(type).slice());\r\n    };\r\n    Object.defineProperty(PureCollection.prototype, \"length\", {\r\n        /**\r\n         * A total count of models in the collection\r\n         *\r\n         * @readonly\r\n         * @type {number}\r\n         * @memberof Collection\r\n         */\r\n        get: function () {\r\n            return this.__data.length;\r\n        },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    /**\r\n     * Get the serializable value of the collection\r\n     *\r\n     * @returns {IRawCollection} Pure JS value of the collection\r\n     * @memberof Collection\r\n     */\r\n    PureCollection.prototype.toJSON = function () {\r\n        var _this = this;\r\n        var views = {};\r\n        this.__views.forEach(function (key) {\r\n            views[key] = _this[key].toJSON();\r\n        });\r\n        return {\r\n            models: this.__data.map(modelToJSON),\r\n            views: views,\r\n        };\r\n    };\r\n    Object.defineProperty(PureCollection.prototype, \"snapshot\", {\r\n        get: function () {\r\n            return this.toJSON();\r\n        },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    /**\r\n     * Reset the collection (remove all models)\r\n     *\r\n     * @memberof Collection\r\n     */\r\n    PureCollection.prototype.reset = function () {\r\n        this.__data.map(function (model) { return setModelMetaKey(model, 'collection', undefined); });\r\n        this.__data.replace([]);\r\n        this.__dataList = observable({});\r\n        this.__dataMap = observable({});\r\n    };\r\n    PureCollection.prototype.getAllModels = function () {\r\n        return this.__data.slice();\r\n    };\r\n    /**\r\n     * Add a view to the collection\r\n     *\r\n     * @template T Model type of the view\r\n     * @param {string} name View name\r\n     * @param {(IModelConstructor<T>|IType)} type Model type the view will represent\r\n     * @param {({\r\n     *       sortMethod?: string|((item: T) => any),\r\n     *       models?: Array<IIdentifier|PureModel>,\r\n     *       unique?: boolean,\r\n     *       mixins?: Array<(view: any) => any>,\r\n     *     })} [{sortMethod, models, unique, mixins}={}] View options\r\n     * @returns {View} The created view\r\n     * @memberof PureCollection\r\n     */\r\n    PureCollection.prototype.addView = function (name, type, _a) {\r\n        var _b = _a === void 0 ? {} : _a, sortMethod = _b.sortMethod, _c = _b.models, models = _c === void 0 ? [] : _c, unique = _b.unique, mixins = _b.mixins;\r\n        if (name in this) {\r\n            throw error(VIEW_NAME_TAKEN);\r\n        }\r\n        var ViewConstructor = mixins\r\n            ? mixins.reduce(function (view, mixin) {\r\n                return mixin(view);\r\n            }, View)\r\n            : View;\r\n        this.__views.push(name);\r\n        this[name] = new ViewConstructor(type, this, sortMethod, models, unique);\r\n        return this[name];\r\n    };\r\n    PureCollection.prototype.__addArray = function (data, model) {\r\n        var _this = this;\r\n        return data.filter(Boolean).map(function (item) { return _this.__addSingle(item, model); });\r\n    };\r\n    PureCollection.prototype.__addSingle = function (data, model) {\r\n        if (!data || typeof data === 'number' || typeof data === 'string') {\r\n            return data;\r\n        }\r\n        if (data instanceof PureModel) {\r\n            if (!this.hasItem(data)) {\r\n                this.__insertModel(data);\r\n            }\r\n            return data;\r\n        }\r\n        if (!model && model !== 0) {\r\n            throw error(UNDEFINED_TYPE);\r\n        }\r\n        var type = getModelType(model);\r\n        var modelInstance = upsertModel(data, type, this);\r\n        this.__insertModel(modelInstance, type);\r\n        return modelInstance;\r\n    };\r\n    PureCollection.prototype.__insertModel = function (model, type, id) {\r\n        var _this = this;\r\n        if (model instanceof Array) {\r\n            return model.forEach(function (item) { return _this.__insertModel(item, type, id); });\r\n        }\r\n        var collection = getModelCollection(model);\r\n        if (collection && collection !== this) {\r\n            throw error(MODEL_SINGLE_COLLECTION);\r\n        }\r\n        var modelType = type || getModelType(model);\r\n        var modelId = id || getModelId(model);\r\n        var stringType = modelType.toString();\r\n        var existingModel = this.find(modelType, modelId);\r\n        if (existingModel) {\r\n            updateModel(existingModel, model);\r\n            return;\r\n        }\r\n        this.__data.push(model);\r\n        if (modelType in this.__dataList) {\r\n            this.__dataList[modelType].push(model);\r\n        }\r\n        else {\r\n            set(this.__dataList, stringType, observable.array([model], { deep: false }));\r\n        }\r\n        if (modelType in this.__dataMap) {\r\n            set(this.__dataMap[modelType], modelId.toString(), model);\r\n        }\r\n        else {\r\n            set(this.__dataMap, stringType, observable.shallowObject((_a = {}, _a[modelId] = model, _a)));\r\n        }\r\n        setModelMetaKey(model, 'collection', this);\r\n        var _a;\r\n    };\r\n    PureCollection.prototype.__removeModel = function (model, type, id) {\r\n        var _this = this;\r\n        if (model instanceof Array) {\r\n            return model.forEach(function (item) { return _this.__removeModel(item, type, id); });\r\n        }\r\n        var modelType = type || getModelType(model);\r\n        var modelId = id || getModelId(model);\r\n        this.__data.remove(model);\r\n        this.__dataList[modelType].remove(model);\r\n        set(this.__dataMap[modelType], modelId.toString(), undefined);\r\n        setModelMetaKey(model, 'collection', undefined);\r\n    };\r\n    PureCollection.prototype.__findByType = function (model, id) {\r\n        var type = getModelType(model);\r\n        var stringType = type.toString();\r\n        if (id) {\r\n            if (!(type in this.__dataMap)) {\r\n                set(this.__dataMap, stringType, (_a = {}, _a[id] = undefined, _a));\r\n            }\r\n            else if (!(id in this.__dataMap[type])) {\r\n                set(this.__dataMap[type], id.toString(), undefined);\r\n            }\r\n            return this.__dataMap[type][id];\r\n        }\r\n        else {\r\n            if (!(type in this.__dataList)) {\r\n                set(this.__dataList, stringType, observable.array([], { deep: false }));\r\n            }\r\n            return this.__dataList[type].length ? this.__dataList[type][0] : null;\r\n        }\r\n        var _a;\r\n    };\r\n    PureCollection.prototype.__changeModelId = function (oldId, newId, type) {\r\n        this.__dataMap[type][newId] = this.__dataMap[type][oldId];\r\n        delete this.__dataMap[type][oldId];\r\n    };\r\n    /**\r\n     * List of models available in the collection\r\n     *\r\n     * @static\r\n     * @type {Array<typeof PureModel>}\r\n     * @memberof Collection\r\n     */\r\n    PureCollection.types = [];\r\n    PureCollection.views = {};\r\n    tslib_1.__decorate([\r\n        observable\r\n    ], PureCollection.prototype, \"__dataMap\", void 0);\r\n    tslib_1.__decorate([\r\n        observable\r\n    ], PureCollection.prototype, \"__dataList\", void 0);\r\n    tslib_1.__decorate([\r\n        action\r\n    ], PureCollection.prototype, \"insert\", null);\r\n    tslib_1.__decorate([\r\n        action\r\n    ], PureCollection.prototype, \"add\", null);\r\n    tslib_1.__decorate([\r\n        action\r\n    ], PureCollection.prototype, \"remove\", null);\r\n    tslib_1.__decorate([\r\n        action\r\n    ], PureCollection.prototype, \"removeAll\", null);\r\n    tslib_1.__decorate([\r\n        computed\r\n    ], PureCollection.prototype, \"length\", null);\r\n    tslib_1.__decorate([\r\n        action\r\n    ], PureCollection.prototype, \"reset\", null);\r\n    return PureCollection;\r\n}());\r\nexport { PureCollection };\r\n//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUHVyZUNvbGxlY3Rpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzcmMvUHVyZUNvbGxlY3Rpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLE9BQU8sRUFBQyxNQUFNLEVBQUUsUUFBUSxFQUFZLGdCQUFnQixFQUF1QyxVQUFVLEVBQUUsR0FBRyxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBRXhILE9BQU8sRUFBQyx1QkFBdUIsRUFBbUIsY0FBYyxFQUFFLGVBQWUsRUFBQyxNQUFNLFVBQVUsQ0FBQztBQUNuRyxPQUFPLEVBQUMsVUFBVSxFQUFFLGtCQUFrQixFQUFFLFdBQVcsRUFBQyxNQUFNLHNCQUFzQixDQUFDO0FBQ2pGLE9BQU8sRUFBQyxLQUFLLEVBQUMsTUFBTSxrQkFBa0IsQ0FBQztBQUN2QyxPQUFPLEVBQ0wsa0JBQWtCLEVBQ2xCLFVBQVUsRUFDVixZQUFZLEVBQ1osV0FBVyxFQUNYLGVBQWUsRUFDZixXQUFXLEdBQ1osTUFBTSx1QkFBdUIsQ0FBQztBQU8vQixPQUFPLEVBQUMsU0FBUyxFQUFDLE1BQU0sYUFBYSxDQUFDO0FBQ3RDLE9BQU8sRUFBQyxJQUFJLEVBQUMsTUFBTSxRQUFRLENBQUM7QUFFNUI7SUEyQkUsd0JBQVksSUFBMEM7UUFBMUMscUJBQUEsRUFBQSxTQUEwQztRQUF0RCxpQkFvQkM7UUEzQk8sV0FBTSxHQUFnQyxVQUFVLENBQUMsS0FBSyxDQUFDLEVBQUUsRUFBRSxFQUFDLElBQUksRUFBRSxLQUFLLEVBQUMsQ0FBQyxDQUFDO1FBRTFFLFlBQU8sR0FBa0IsRUFBRSxDQUFDO1FBRWhCLGNBQVMsR0FBd0MsRUFBRSxDQUFDO1FBQ3BELGVBQVUsR0FBNkMsRUFBRSxDQUFDO1FBRzVFLGdCQUFnQixDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztRQUMzQixJQUFJLElBQUksWUFBWSxLQUFLLEVBQUU7WUFDekIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNuQjthQUFNLElB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LENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztTQUN2RTs7SUFDSCxDQUFDO0lBRU8sd0NBQWUsR0FBdkIsVUFBd0IsS0FBa0IsRUFBRSxLQUFrQixFQUFFLElBQVc7UUFDekUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzFELE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNyQyxDQUFDO0lBdFpEOzs7Ozs7T0FNRztJQUNXLG9CQUFLLEdBQXlELEVBQUUsQ0FBQztJQUVqRSxvQkFBSyxHQUtkLEVBQUUsQ0FBQztJQVFJO1FBQVgsVUFBVTtxREFBNkQ7SUFDNUQ7UUFBWCxVQUFVO3NEQUFtRTtJQStCdEU7UUFBUCxNQUFNO2dEQUlOO0lBNENPO1FBQVAsTUFBTTs2Q0FLTjtJQXlGTztRQUFQLE1BQU07Z0RBS047SUFRTztRQUFQLE1BQU07bURBRU47SUFTUztRQUFULFFBQVE7Z0RBRVI7SUE4Qk87UUFBUCxNQUFNOytDQUtOO0lBc0pILHFCQUFDO0NBQUEsQUF6WkQsSUF5WkM7U0F6WlksY0FBYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SURpY3Rpb25hcnksIElSYXdNb2RlbH0gZnJvbSAnZGF0eC11dGlscyc7XG5pbXBvcnQge2FjdGlvbiwgY29tcHV0ZWQsIGRlY29yYXRlLCBleHRlbmRPYnNlcnZhYmxlLCBJT2JzZXJ2YWJsZUFycmF5LCBJT2JzZXJ2YWJsZU9iamVjdCwgb2JzZXJ2YWJsZSwgc2V0fSBmcm9tICdtb2J4JztcblxuaW1wb3J0IHtNT0RFTF9TSU5HTEVfQ09MTEVDVElPTiwgVU5ERUZJTkVEX01PREVMLCBVTkRFRklORURfVFlQRSwgVklFV19OQU1FX1RBS0VOfSBmcm9tICcuL2Vycm9ycyc7XG5pbXBvcnQge2luaXRNb2RlbHMsIGlzU2VsZWN0b3JGdW5jdGlvbiwgdXBzZXJ0TW9kZWx9IGZyb20gJy4vaGVscGVycy9jb2xsZWN0aW9uJztcbmltcG9ydCB7ZXJyb3J9IGZyb20gJy4vaGVscGVycy9mb3JtYXQnO1xuaW1wb3J0IHtcbiAgZ2V0TW9kZWxDb2xsZWN0aW9uLFxuICBnZXRNb2RlbElkLFxuICBnZXRNb2RlbFR5cGUsXG4gIG1vZGVsVG9KU09OLFxuICBzZXRNb2RlbE1ldGFLZXksXG4gIHVwZGF0ZU1vZGVsLFxufSBmcm9tICcuL2hlbHBlcnMvbW9kZWwvdXRpbHMnO1xuaW1wb3J0IHtJSWRlbnRpZmllcn0gZnJvbSAnLi9pbnRlcmZhY2VzL0lJZGVudGlmaWVyJztcbmltcG9ydCB7SU1vZGVsQ29uc3RydWN0b3J9IGZyb20gJy4vaW50ZXJmYWNlcy9JTW9kZWxDb25zdHJ1Y3Rvcic7XG5pbXBvcnQge0lSYXdDb2xsZWN0aW9ufSBmcm9tICcuL2ludGVyZmFjZXMvSVJhd0NvbGxlY3Rpb24nO1xuaW1wb3J0IHtJUmF3Vmlld30gZnJvbSAnLi9pbnRlcmZhY2VzL0lSYXdWaWV3JztcbmltcG9ydCB7SVR5cGV9IGZyb20gJy4vaW50ZXJmYWNlcy9JVHlwZSc7XG5pbXBvcnQge1RGaWx0ZXJGbn0gZnJvbSAnLi9pbnRlcmZhY2VzL1RGaWx0ZXJGbic7XG5pbXBvcnQge1B1cmVNb2RlbH0gZnJvbSAnLi9QdXJlTW9kZWwnO1xuaW1wb3J0IHtWaWV3fSBmcm9tICcuL1ZpZXcnO1xuXG5leHBvcnQgY2xhc3MgUHVyZUNvbGxlY3Rpb24ge1xuXG4gIC8qKlxuICAgKiBMaXN0IG9mIG1vZGVscyBhdmFpbGFibGUgaW4gdGhlIGNvbGxlY3Rpb25cbiAgICpcbiAgICogQHN0YXRpY1xuICAgKiBAdHlwZSB7QXJyYXk8dHlwZW9mIFB1cmVNb2RlbD59XG4gICAqIEBtZW1iZXJvZiBDb2xsZWN0aW9uXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIHR5cGVzOiBBcnJheTx0eXBlb2YgUHVyZU1vZGVsfElNb2RlbENvbnN0cnVjdG9yPFB1cmVNb2RlbD4+ID0gW107XG5cbiAgcHVibGljIHN0YXRpYyB2aWV3czogSURpY3Rpb25hcnk8e1xuICAgIG1vZGVsVHlwZTogSVR5cGV8UHVyZU1vZGVsLFxuICAgIHNvcnRNZXRob2Q/OiBzdHJpbmd8KChQdXJlTW9kZWwpID0+IGFueSk7XG4gICAgdW5pcXVlPzogYm9vbGVhbjtcbiAgICBtaXhpbnM/OiBBcnJheTwodmlldzogYW55KSA9PiBhbnk+O1xuICB9PiA9IHt9O1xuXG4gIHB1YmxpYyBzdGF0aWMgZGVmYXVsdE1vZGVsPzogdHlwZW9mIFB1cmVNb2RlbDtcblxuICBwcml2YXRlIF9fZGF0YTogSU9ic2VydmFibGVBcnJheTxQdXJlTW9kZWw+ID0gb2JzZXJ2YWJsZS5hcnJheShbXSwge2RlZXA6IGZhbHNlfSk7XG5cbiAgcHJpdmF0ZSBfX3ZpZXdzOiBBcnJheTxzdHJpbmc+ID0gW107XG5cbiAgQG9ic2VydmFibGUgcHJpdmF0ZSBfX2RhdGFNYXA6IElEaWN0aW9uYXJ5PElEaWN0aW9uYXJ5PFB1cmVNb2RlbD4+ID0ge307XG4gIEBvYnNlcnZhYmxlIHByaXZhdGUgX19kYXRhTGlzdDogSURpY3Rpb25hcnk8SU9ic2VydmFibGVBcnJheTxQdXJlTW9kZWw+PiA9IHt9O1xuXG4gIGNvbnN0cnVjdG9yKGRhdGE6IEFycmF5PElSYXdNb2RlbD58SVJhd0NvbGxlY3Rpb24gPSBbXSkge1xuICAgIGV4dGVuZE9ic2VydmFibGUodGhpcywge30pO1xuICAgIGlmIChkYXRhIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgIHRoaXMuaW5zZXJ0KGRhdGEpO1xuICAgIH0gZWxzZSBpZiAoZGF0YSAmJiAnbW9kZWxzJyBpbiBkYXRhKSB7XG4gICAgICB0aGlzLmluc2VydChkYXRhLm1vZGVscyk7XG4gICAgfVxuXG4gICAgY29uc3Qgc3RhdGljQ29sbGVjdGlvbiA9IHRoaXMuY29uc3RydWN0b3IgYXMgdHlwZW9mIFB1cmVDb2xsZWN0aW9uO1xuICAgIGNvbnN0IGluaXRWaWV3cyA9IChkYXRhICYmICd2aWV3cycgaW4gZGF0YSkgPyBkYXRhLnZpZXdzIDoge307XG4gICAgT2JqZWN0LmtleXMoc3RhdGljQ29sbGVjdGlvbi52aWV3cykuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICBjb25zdCB2aWV3ID0gc3RhdGljQ29sbGVjdGlvbi52aWV3c1trZXldO1xuICAgICAgY29uc3QgaW5pdCA9IGluaXRWaWV3c1trZXldIHx8IHZpZXc7XG4gICAgICB0aGlzLmFkZFZpZXcoa2V5LCBpbml0Lm1vZGVsVHlwZSwge1xuICAgICAgICBtaXhpbnM6IHZpZXcubWl4aW5zLFxuICAgICAgICBtb2RlbHM6IGluaXQubW9kZWxzIHx8IFtdLFxuICAgICAgICBzb3J0TWV0aG9kOiB2aWV3LnNvcnRNZXRob2QsXG4gICAgICAgIHVuaXF1ZTogaW5pdC51bmlxdWUsXG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBGdW5jdGlvbiBmb3IgaW5zZXJ0aW5nIHJhdyBtb2RlbHMgaW50byB0aGUgY29sbGVjdGlvbi4gVXNlZCB3aGVuIGh5ZHJhdGluZyB0aGUgY29sbGVjdGlvblxuICAgKlxuICAgKiBAcGFyYW0ge0FycmF5PElSYXdNb2RlbD59IGRhdGEgUmF3IG1vZGVsIGRhdGFcbiAgICogQHJldHVybnMge0FycmF5PFB1cmVNb2RlbD59IEEgbGlzdCBvZiBpbml0aWFsaXplZCBtb2RlbHNcbiAgICogQG1lbWJlcm9mIENvbGxlY3Rpb25cbiAgICovXG4gIEBhY3Rpb24gcHVibGljIGluc2VydChkYXRhOiBBcnJheTxQYXJ0aWFsPElSYXdNb2RlbD4+KTogQXJyYXk8UHVyZU1vZGVsPiB7XG4gICAgY29uc3QgbW9kZWxzID0gaW5pdE1vZGVscyh0aGlzLCBkYXRhKTtcbiAgICB0aGlzLl9faW5zZXJ0TW9kZWwobW9kZWxzKTtcbiAgICByZXR1cm4gbW9kZWxzO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZCBhbiBleGlzdGluZyBtb2RlbCB0byB0aGUgY29sbGVjdGlvblxuICAgKlxuICAgKiBAdGVtcGxhdGUgVFxuICAgKiBAcGFyYW0ge1R9IGRhdGEgTW9kZWwgdG8gYmUgYWRkZWRcbiAgICogQHJldHVybnMge1R9IEFkZGVkIG1vZGVsXG4gICAqIEBtZW1iZXJvZiBDb2xsZWN0aW9uXG4gICAqL1xuICBwdWJsaWMgYWRkPFQgZXh0ZW5kcyBQdXJlTW9kZWw+KGRhdGE6IFQpOiBUO1xuXG4gIC8qKlxuICAgKiBBZGQgYW4gYXJyYXkgb2YgZXhpc3RpbmcgbW9kZWxzIHRvIHRoZSBjb2xsZWN0aW9uXG4gICAqXG4gICAqIEB0ZW1wbGF0ZSBUXG4gICAqIEBwYXJhbSB7QXJyYXk8VD59IGRhdGEgQXJyYXkgb2YgbW9kZWxzIHRvIGJlIGFkZGVkXG4gICAqIEByZXR1cm5zIHtBcnJheTxUPn0gQWRkZWQgbW9kZWxzXG4gICAqIEBtZW1iZXJvZiBDb2xsZWN0aW9uXG4gICAqL1xuICBwdWJsaWMgYWRkPFQgZXh0ZW5kcyBQdXJlTW9kZWw+KGRhdGE6IEFycmF5PFQ+KTogQXJyYXk8VD47XG5cbiAgLyoqXG4gICAqIEFkZCBhbiBhcnJheSBvZiBuZXcgbW9kZWxzIHRvIHRoZSBjb2xsZWN0aW9uXG4gICAqXG4gICAqIEB0ZW1wbGF0ZSBUXG4gICAqIEBwYXJhbSB7QXJyYXk8SVJhd01vZGVsfElEaWN0aW9uYXJ5PGFueT4+fSBkYXRhIEFycmF5IG9mIG5ldyBkYXRhIHRvIGJlIGFkZGVkXG4gICAqIEBwYXJhbSB7KElUeXBlfElNb2RlbENvbnN0cnVjdG9yPFQ+KX0gbW9kZWwgTW9kZWwgdHlwZSB0byBiZSBhZGRlZFxuICAgKiBAcmV0dXJucyB7QXJyYXk8VD59IEFkZGVkIG1vZGVsc1xuICAgKiBAbWVtYmVyb2YgQ29sbGVjdGlvblxuICAgKi9cbiAgcHVibGljIGFkZDxUIGV4dGVuZHMgUHVyZU1vZGVsPihkYXRhOiBBcnJheTxJUmF3TW9kZWx8SURpY3Rpb25hcnk8YW55Pj4sIG1vZGVsOiBJVHlwZXxJTW9kZWxDb25zdHJ1Y3RvcjxUPik6IEFycmF5PFQ+O1xuXG4gIC8qKlxuICAgKiBBZGQgYSBuZXcgbW9kZWwgdG8gdGhlIGNvbGxlY3Rpb25cbiAgICpcbiAgICogQHRlbXBsYXRlIFRcbiAgICogQHBhcmFtIHsoSVJhd01vZGVsfElEaWN0aW9uYXJ5PGFueT4pfSBkYXRhIE5ldyBkYXRhIHRvIGJlIGFkZGVkXG4gICAqIEBwYXJhbSB7KElUeXBlfElNb2RlbENvbnN0cnVjdG9yPFQ+KX0gbW9kZWwgTW9kZWwgdHlwZSB0byBiZSBhZGRlZFxuICAgKiBAcmV0dXJucyB7VH0gQWRkZWQgbW9kZWxcbiAgICogQG1lbWJlcm9mIENvbGxlY3Rpb25cbiAgICovXG4gIHB1YmxpYyBhZGQ8VCBleHRlbmRzIFB1cmVNb2RlbD4oZGF0YTogSVJhd01vZGVsfElEaWN0aW9uYXJ5PGFueT4sIG1vZGVsOiBJVHlwZXxJTW9kZWxDb25zdHJ1Y3RvcjxUPik6IFQ7XG5cbiAgQGFjdGlvbiBwdWJsaWMgYWRkKFxuICAgIGRhdGE6IFB1cmVNb2RlbHxJUmF3TW9kZWx8SURpY3Rpb25hcnk8YW55PnxBcnJheTxQdXJlTW9kZWw+fEFycmF5PElSYXdNb2RlbHxJRGljdGlvbmFyeTxhbnk+PixcbiAgICBtb2RlbD86IElUeXBlfElNb2RlbENvbnN0cnVjdG9yLFxuICApOiBQdXJlTW9kZWx8QXJyYXk8UHVyZU1vZGVsPiB7XG4gICAgcmV0dXJuIChkYXRhIGluc3RhbmNlb2YgQXJyYXkpID8gdGhpcy5fX2FkZEFycmF5KGRhdGEsIG1vZGVsKSA6IHRoaXMuX19hZGRTaW5nbGUoZGF0YSwgbW9kZWwpO1xuICB9XG5cbiAgLyoqXG4gICAqIEZpbmQgYSBtb2RlbCBiYXNlZCBvbiB0aGUgZGVmaW5lZCB0eXBlIGFuZCAob3B0aW9uYWwpIGlkZW50aWZpZXJcbiAgICpcbiAgICogQHBhcmFtIHsoSVR5cGV8dHlwZW9mIFB1cmVNb2RlbHxQdXJlTW9kZWwpfSB0eXBlIE1vZGVsIHR5cGVcbiAgICogQHBhcmFtIHtJSWRlbnRpZmllcn0gW2lkXSBNb2RlbCBpZGVudGlmaWVyXG4gICAqIEByZXR1cm5zIHsoUHVyZU1vZGVsfG51bGwpfSBUaGUgZmlyc3QgbWF0Y2hpbmcgbW9kZWxcbiAgICogQG1lbWJlcm9mIENvbGxlY3Rpb25cbiAgICovXG4gIHB1YmxpYyBmaW5kPFQgZXh0ZW5kcyBQdXJlTW9kZWw+KHR5cGU6IElUeXBlfFR8SU1vZGVsQ29uc3RydWN0b3I8VD4sIGlkPzogSUlkZW50aWZpZXJ8UHVyZU1vZGVsKTogVHxudWxsO1xuXG4gIC8qKlxuICAgKiBGaW5kIGEgbW9kZWwgYmFzZWQgb24gYSBtYXRjaGluZyBmdW5jdGlvblxuICAgKlxuICAgKiBAcGFyYW0ge1RGaWx0ZXJGbn0gdGVzdCBGdW5jdGlvbiB1c2VkIHRvIG1hdGNoIHRoZSBtb2RlbFxuICAgKiBAcmV0dXJucyB7KFB1cmVNb2RlbHxudWxsKX0gVGhlIGZpcnN0IG1hdGNoaW5nIG1vZGVsXG4gICAqIEBtZW1iZXJvZiBDb2xsZWN0aW9uXG4gICAqL1xuICBwdWJsaWMgZmluZDxUIGV4dGVuZHMgUHVyZU1vZGVsPih0ZXN0OiBURmlsdGVyRm4pOiBUfG51bGw7XG5cbiAgcHVibGljIGZpbmQobW9kZWw6IElUeXBlfHR5cGVvZiBQdXJlTW9kZWx8KFRGaWx0ZXJGbiksIGlkPzogSUlkZW50aWZpZXJ8UHVyZU1vZGVsKSB7XG4gICAgaWYgKGlkIGluc3RhbmNlb2YgUHVyZU1vZGVsKSB7XG4gICAgICByZXR1cm4gaWQ7XG4gICAgfVxuXG4gICAgcmV0dXJuIGlzU2VsZWN0b3JGdW5jdGlvbihtb2RlbClcbiAgICAgID8gKHRoaXMuX19kYXRhLmZpbmQobW9kZWwgYXMgVEZpbHRlckZuKSB8fCBudWxsKVxuICAgICAgOiAodGhpcy5fX2ZpbmRCeVR5cGUobW9kZWwgYXMgdHlwZW9mIFB1cmVNb2RlbCwgaWQpIHx8IG51bGwpO1xuICB9XG5cbiAgLyoqXG4gICAqIEZpbHRlciBtb2RlbHMgYmFzZWQgb24gYSBtYXRjaGluZyBmdW5jdGlvblxuICAgKlxuICAgKiBAcGFyYW0ge1RGaWx0ZXJGbn0gdGVzdCBGdW5jdGlvbiB1c2VkIHRvIG1hdGNoIHRoZSBtb2RlbHNcbiAgICogQHJldHVybnMgeyhQdXJlTW9kZWx8bnVsbCl9IFRoZSBtYXRjaGluZyBtb2RlbHNcbiAgICogQG1lbWJlcm9mIENvbGxlY3Rpb25cbiAgICovXG4gIHB1YmxpYyBmaWx0ZXIodGVzdDogVEZpbHRlckZuKTogQXJyYXk8UHVyZU1vZGVsPiB7XG4gICAgcmV0dXJuIHRoaXMuX19kYXRhLmZpbHRlcih0ZXN0KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBGaW5kIGFsbCBtYXRjaGluZyBtb2RlbHMgb3IgYWxsIG1vZGVscyBpZiBubyB0eXBlIGlzIGdpdmVuXG4gICAqXG4gICAqIEBwYXJhbSB7KElUeXBlfHR5cGVvZiBQdXJlTW9kZWwpfSBbbW9kZWxdIE1vZGVsIHR5cGUgdG8gc2VsZWN0XG4gICAqIEByZXR1cm5zIHtBcnJheTxQdXJlTW9kZWw+fSBMaXN0IG9mIG1hdGNoaW5nIG1vZGVsc1xuICAgKiBAbWVtYmVyb2YgQ29sbGVjdGlvblxuICAgKi9cbiAgcHVibGljIGZpbmRBbGw8VCBleHRlbmRzIFB1cmVNb2RlbD4obW9kZWw/OiBJVHlwZXxJTW9kZWxDb25zdHJ1Y3RvcjxUPik6IEFycmF5PFQ+IHtcbiAgICBpZiAobW9kZWwpIHtcbiAgICAgIGNvbnN0IHR5cGUgPSBnZXRNb2RlbFR5cGUobW9kZWwpO1xuICAgICAgaWYgKCEodHlwZSBpbiB0aGlzLl9fZGF0YUxpc3QpKSB7XG4gICAgICAgIHNldCh0aGlzLl9fZGF0YUxpc3QsIHtbdHlwZV06IG9ic2VydmFibGUuYXJyYXkoW10pfSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gdGhpcy5fX2RhdGFMaXN0W3R5cGVdIGFzIElPYnNlcnZhYmxlQXJyYXk8VD47XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9fZGF0YSBhcyBJT2JzZXJ2YWJsZUFycmF5PFQ+O1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrIGlmIGEgbW9kZWwgaXMgaW4gdGhlIGNvbGxlY3Rpb25cbiAgICpcbiAgICogQHBhcmFtIHtQdXJlTW9kZWx9IG1vZGVsIE1vZGVsIHRvIGNoZWNrXG4gICAqIEByZXR1cm5zIHtib29sZWFufSBUaGUgZ2l2ZW4gbW9kZWwgaXMgaW4gdGhlIGNvbGxlY3Rpb25cbiAgICogQG1lbWJlcm9mIENvbGxlY3Rpb25cbiAgICovXG4gIHB1YmxpYyBoYXNJdGVtKG1vZGVsOiBQdXJlTW9kZWwpOiBib29sZWFuIHtcbiAgICBjb25zdCBpZCA9IGdldE1vZGVsSWQobW9kZWwpO1xuICAgIHJldHVybiBCb29sZWFuKHRoaXMuZmluZChtb2RlbCwgaWQpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgdGhlIGZpcnN0IG1vZGVsIGJhc2VkIG9uIHRoZSB0eXBlIGFuZCAob3B0aW9uYWwpIGlkZW50aWZpZXJcbiAgICpcbiAgICogQHBhcmFtIHsoSVR5cGV8dHlwZW9mIFB1cmVNb2RlbCl9IHR5cGUgTW9kZWwgdHlwZVxuICAgKiBAcGFyYW0ge0lJZGVudGlmaWVyfSBbaWRdIE1vZGVsIGlkZW50aWZpZXJcbiAgICogQG1lbWJlcm9mIENvbGxlY3Rpb25cbiAgICovXG4gIHB1YmxpYyByZW1vdmUodHlwZTogSVR5cGV8dHlwZW9mIFB1cmVNb2RlbCwgaWQ/OiBJSWRlbnRpZmllcik7XG5cbiAgLyoqXG4gICAqIFJlbW92ZSB0aGUgZ2l2ZW4gbW9kZWwgZnJvbSB0aGUgY29sbGVjdGlvblxuICAgKlxuICAgKiBAcGFyYW0ge1B1cmVNb2RlbH0gbW9kZWwgTW9kZWwgdG8gYmUgcmVtb3ZlZCBmcm9tIHRoZSBjb2xsZWN0aW9uXG4gICAqIEBtZW1iZXJvZiBDb2xsZWN0aW9uXG4gICAqL1xuICBwdWJsaWMgcmVtb3ZlKG1vZGVsOiBQdXJlTW9kZWwpO1xuXG4gIEBhY3Rpb24gcHVibGljIHJlbW92ZShvYmo6IElUeXBlfHR5cGVvZiBQdXJlTW9kZWx8UHVyZU1vZGVsLCBpZD86IElJZGVudGlmaWVyKSB7XG4gICAgY29uc3QgbW9kZWwgPSB0eXBlb2Ygb2JqID09PSAnb2JqZWN0JyA/IG9iaiA6IHRoaXMuZmluZChvYmosIGlkKTtcbiAgICBpZiAobW9kZWwpIHtcbiAgICAgIHRoaXMuX19yZW1vdmVNb2RlbChtb2RlbCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZSBhbGwgbW9kZWxzIG9mIHRoZSBnaXZlbiBtb2RlbCB0eXBlIGZyb20gdGhlIGNvbGxlY3Rpb25cbiAgICpcbiAgICogQHBhcmFtIHsoSVR5cGV8dHlwZW9mIFB1cmVNb2RlbCl9IHR5cGUgTW9kZWwgdHlwZVxuICAgKiBAbWVtYmVyb2YgQ29sbGVjdGlvblxuICAgKi9cbiAgQGFjdGlvbiBwdWJsaWMgcmVtb3ZlQWxsKHR5cGU6IElUeXBlfHR5cGVvZiBQdXJlTW9kZWwpIHtcbiAgICB0aGlzLl9fcmVtb3ZlTW9kZWwodGhpcy5maW5kQWxsKHR5cGUpLnNsaWNlKCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIEEgdG90YWwgY291bnQgb2YgbW9kZWxzIGluIHRoZSBjb2xsZWN0aW9uXG4gICAqXG4gICAqIEByZWFkb25seVxuICAgKiBAdHlwZSB7bnVtYmVyfVxuICAgKiBAbWVtYmVyb2YgQ29sbGVjdGlvblxuICAgKi9cbiAgQGNvbXB1dGVkIHB1YmxpYyBnZXQgbGVuZ3RoKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuX19kYXRhLmxlbmd0aDtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdGhlIHNlcmlhbGl6YWJsZSB2YWx1ZSBvZiB0aGUgY29sbGVjdGlvblxuICAgKlxuICAgKiBAcmV0dXJucyB7SVJhd0NvbGxlY3Rpb259IFB1cmUgSlMgdmFsdWUgb2YgdGhlIGNvbGxlY3Rpb25cbiAgICogQG1lbWJlcm9mIENvbGxlY3Rpb25cbiAgICovXG4gIHB1YmxpYyB0b0pTT04oKTogSVJhd0NvbGxlY3Rpb24ge1xuICAgIGNvbnN0IHZpZXdzOiBJRGljdGlvbmFyeTxJUmF3Vmlldz4gPSB7fTtcblxuICAgIHRoaXMuX192aWV3cy5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgIHZpZXdzW2tleV0gPSB0aGlzW2tleV0udG9KU09OKCk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgbW9kZWxzOiB0aGlzLl9fZGF0YS5tYXAobW9kZWxUb0pTT04pLFxuICAgICAgdmlld3MsXG4gICAgfTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgc25hcHNob3QoKSB7XG4gICAgcmV0dXJuIHRoaXMudG9KU09OKCk7XG4gIH1cblxuICAvKipcbiAgICogUmVzZXQgdGhlIGNvbGxlY3Rpb24gKHJlbW92ZSBhbGwgbW9kZWxzKVxuICAgKlxuICAgKiBAbWVtYmVyb2YgQ29sbGVjdGlvblxuICAgKi9cbiAgQGFjdGlvbiBwdWJsaWMgcmVzZXQoKSB7XG4gICAgdGhpcy5fX2RhdGEubWFwKChtb2RlbCkgPT4gc2V0TW9kZWxNZXRhS2V5KG1vZGVsLCAnY29sbGVjdGlvbicsIHVuZGVmaW5lZCkpO1xuICAgIHRoaXMuX19kYXRhLnJlcGxhY2UoW10pO1xuICAgIHRoaXMuX19kYXRhTGlzdCA9IG9ic2VydmFibGUoe30pIGFzIElPYnNlcnZhYmxlT2JqZWN0ICYgSURpY3Rpb25hcnk8SU9ic2VydmFibGVBcnJheTxQdXJlTW9kZWw+PjtcbiAgICB0aGlzLl9fZGF0YU1hcCA9IG9ic2VydmFibGUoe30pIGFzIElPYnNlcnZhYmxlT2JqZWN0ICZJRGljdGlvbmFyeTxJRGljdGlvbmFyeTxQdXJlTW9kZWw+PjtcbiAgfVxuXG4gIHB1YmxpYyBnZXRBbGxNb2RlbHMoKSB7XG4gICAgcmV0dXJuIHRoaXMuX19kYXRhLnNsaWNlKCk7XG4gIH1cblxuICAvKipcbiAgICogQWRkIGEgdmlldyB0byB0aGUgY29sbGVjdGlvblxuICAgKlxuICAgKiBAdGVtcGxhdGUgVCBNb2RlbCB0eXBlIG9mIHRoZSB2aWV3XG4gICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFZpZXcgbmFtZVxuICAgKiBAcGFyYW0geyhJTW9kZWxDb25zdHJ1Y3RvcjxUPnxJVHlwZSl9IHR5cGUgTW9kZWwgdHlwZSB0aGUgdmlldyB3aWxsIHJlcHJlc2VudFxuICAgKiBAcGFyYW0geyh7XG4gICAqICAgICAgIHNvcnRNZXRob2Q/OiBzdHJpbmd8KChpdGVtOiBUKSA9PiBhbnkpLFxuICAgKiAgICAgICBtb2RlbHM/OiBBcnJheTxJSWRlbnRpZmllcnxQdXJlTW9kZWw+LFxuICAgKiAgICAgICB1bmlxdWU/OiBib29sZWFuLFxuICAgKiAgICAgICBtaXhpbnM/OiBBcnJheTwodmlldzogYW55KSA9PiBhbnk+LFxuICAgKiAgICAgfSl9IFt7c29ydE1ldGhvZCwgbW9kZWxzLCB1bmlxdWUsIG1peGluc309e31dIFZpZXcgb3B0aW9uc1xuICAgKiBAcmV0dXJucyB7Vmlld30gVGhlIGNyZWF0ZWQgdmlld1xuICAgKiBAbWVtYmVyb2YgUHVyZUNvbGxlY3Rpb25cbiAgICovXG4gIHB1YmxpYyBhZGRWaWV3PFQgZXh0ZW5kcyBQdXJlTW9kZWwgPSBQdXJlTW9kZWw+KFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICB0eXBlOiBJTW9kZWxDb25zdHJ1Y3RvcjxUPnxJVHlwZSxcbiAgICB7c29ydE1ldGhvZCwgbW9kZWxzID0gW10sIHVuaXF1ZSwgbWl4aW5zfToge1xuICAgICAgc29ydE1ldGhvZD86IHN0cmluZ3woKGl0ZW06IFQpID0+IGFueSksXG4gICAgICBtb2RlbHM/OiBBcnJheTxJSWRlbnRpZmllcnxUPixcbiAgICAgIHVuaXF1ZT86IGJvb2xlYW4sXG4gICAgICBtaXhpbnM/OiBBcnJheTwodmlldzogYW55KSA9PiBhbnk+LFxuICAgIH0gPSB7fSxcbiAgKSB7XG4gICAgaWYgKG5hbWUgaW4gdGhpcykge1xuICAgICAgdGhyb3cgZXJyb3IoVklFV19OQU1FX1RBS0VOKTtcbiAgICB9XG5cbiAgICBjb25zdCBWaWV3Q29uc3RydWN0b3IgPSBtaXhpbnNcbiAgICAgID8gbWl4aW5zLnJlZHVjZSgodmlldzogYW55LCBtaXhpbjogKHZpZXc6IGFueSkgPT4gYW55KSA9PiB7XG4gICAgICAgICAgcmV0dXJuIG1peGluKHZpZXcpO1xuICAgICAgICB9LCBWaWV3KSBhcyB0eXBlb2YgVmlld1xuICAgICAgOiBWaWV3O1xuXG4gICAgdGhpcy5fX3ZpZXdzLnB1c2gobmFtZSk7XG4gICAgdGhpc1tuYW1lXSA9IG5ldyBWaWV3Q29uc3RydWN0b3I8VD4odHlwZSwgdGhpcywgc29ydE1ldGhvZCwgbW9kZWxzLCB1bmlxdWUpO1xuXG4gICAgcmV0dXJuIHRoaXNbbmFtZV07XG4gIH1cblxuICBwcml2YXRlIF9fYWRkQXJyYXk8VCBleHRlbmRzIFB1cmVNb2RlbD4oZGF0YTogQXJyYXk8VD4pOiBBcnJheTxUPjtcbiAgcHJpdmF0ZSBfX2FkZEFycmF5PFQgZXh0ZW5kcyBQdXJlTW9kZWw+KGRhdGE6IEFycmF5PElEaWN0aW9uYXJ5PGFueT4+LCBtb2RlbD86IElUeXBlfElNb2RlbENvbnN0cnVjdG9yPFQ+KTogQXJyYXk8VD47XG4gIHByaXZhdGUgX19hZGRBcnJheShkYXRhOiBBcnJheTxQdXJlTW9kZWx8SURpY3Rpb25hcnk8YW55Pj4sIG1vZGVsPzogSVR5cGV8SU1vZGVsQ29uc3RydWN0b3IpOiBBcnJheTxQdXJlTW9kZWw+IHtcbiAgICByZXR1cm4gZGF0YS5maWx0ZXIoQm9vbGVhbikubWFwKChpdGVtKSA9PiB0aGlzLl9fYWRkU2luZ2xlKGl0ZW0sIG1vZGVsKSk7XG4gIH1cblxuICBwcml2YXRlIF9fYWRkU2luZ2xlPFQgZXh0ZW5kcyBQdXJlTW9kZWw+KGRhdGE6IFQpOiBUO1xuICBwcml2YXRlIF9fYWRkU2luZ2xlPFQgZXh0ZW5kcyBQdXJlTW9kZWw+KGRhdGE6IElEaWN0aW9uYXJ5PGFueT4sIG1vZGVsPzogSVR5cGV8SU1vZGVsQ29uc3RydWN0b3I8VD4pOiBUO1xuICBwcml2YXRlIF9fYWRkU2luZ2xlKGRhdGE6IFB1cmVNb2RlbHxJRGljdGlvbmFyeTxhbnk+fElJZGVudGlmaWVyLCBtb2RlbD86IElUeXBlfElNb2RlbENvbnN0cnVjdG9yKSB7XG4gICAgaWYgKCFkYXRhIHx8IHR5cGVvZiBkYXRhID09PSAnbnVtYmVyJyB8fCB0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHJldHVybiBkYXRhO1xuICAgIH1cblxuICAgIGlmIChkYXRhIGluc3RhbmNlb2YgUHVyZU1vZGVsKSB7XG4gICAgICBpZiAoIXRoaXMuaGFzSXRlbShkYXRhKSkge1xuICAgICAgICB0aGlzLl9faW5zZXJ0TW9kZWwoZGF0YSk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBkYXRhO1xuICAgIH1cblxuICAgIGlmICghbW9kZWwgJiYgbW9kZWwgIT09IDApIHtcbiAgICAgIHRocm93IGVycm9yKFVOREVGSU5FRF9UWVBFKTtcbiAgICB9XG5cbiAgICBjb25zdCB0eXBlID0gZ2V0TW9kZWxUeXBlKG1vZGVsIGFzIElUeXBlfHR5cGVvZiBQdXJlTW9kZWwpO1xuICAgIGNvbnN0IG1vZGVsSW5zdGFuY2UgPSB1cHNlcnRNb2RlbChkYXRhLCB0eXBlLCB0aGlzKTtcbiAgICB0aGlzLl9faW5zZXJ0TW9kZWwobW9kZWxJbnN0YW5jZSwgdHlwZSk7XG5cbiAgICByZXR1cm4gbW9kZWxJbnN0YW5jZTtcbiAgfVxuXG4gIHByaXZhdGUgX19pbnNlcnRNb2RlbChtb2RlbDogUHVyZU1vZGVsfEFycmF5PFB1cmVNb2RlbD4sIHR5cGU/OiBJVHlwZSwgaWQ/OiBJSWRlbnRpZmllcikge1xuICAgIGlmIChtb2RlbCBpbnN0YW5jZW9mIEFycmF5KSB7XG4gICAgICByZXR1cm4gbW9kZWwuZm9yRWFjaCgoaXRlbSkgPT4gdGhpcy5fX2luc2VydE1vZGVsKGl0ZW0sIHR5cGUsIGlkKSk7XG4gICAgfVxuXG4gICAgY29uc3QgY29sbGVjdGlvbiA9IGdldE1vZGVsQ29sbGVjdGlvbihtb2RlbCk7XG4gICAgaWYgKGNvbGxlY3Rpb24gJiYgY29sbGVjdGlvbiAhPT0gdGhpcykge1xuICAgICAgdGhyb3cgZXJyb3IoTU9ERUxfU0lOR0xFX0NPTExFQ1RJT04pO1xuICAgIH1cblxuICAgIGNvbnN0IG1vZGVsVHlwZSA9IHR5cGUgfHwgZ2V0TW9kZWxUeXBlKG1vZGVsKTtcbiAgICBjb25zdCBtb2RlbElkID0gaWQgfHwgZ2V0TW9kZWxJZChtb2RlbCk7XG4gICAgY29uc3Qgc3RyaW5nVHlwZSA9IG1vZGVsVHlwZS50b1N0cmluZygpO1xuXG4gICAgY29uc3QgZXhpc3RpbmdNb2RlbCA9IHRoaXMuZmluZChtb2RlbFR5cGUsIG1vZGVsSWQpO1xuICAgIGlmIChleGlzdGluZ01vZGVsKSB7XG4gICAgICB1cGRhdGVNb2RlbChleGlzdGluZ01vZGVsLCBtb2RlbCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5fX2RhdGEucHVzaChtb2RlbCk7XG4gICAgaWYgKG1vZGVsVHlwZSBpbiB0aGlzLl9fZGF0YUxpc3QpIHtcbiAgICAgIHRoaXMuX19kYXRhTGlzdFttb2RlbFR5cGVdLnB1c2gobW9kZWwpO1xuICAgIH0gZWxzZSB7XG4gICAgICBzZXQodGhpcy5fX2RhdGFMaXN0LCBzdHJpbmdUeXBlLCBvYnNlcnZhYmxlLmFycmF5KFttb2RlbF0sIHtkZWVwOiBmYWxzZX0pKTtcbiAgICB9XG5cbiAgICBpZiAobW9kZWxUeXBlIGluIHRoaXMuX19kYXRhTWFwKSB7XG4gICAgICBzZXQodGhpcy5fX2RhdGFNYXBbbW9kZWxUeXBlXSwgbW9kZWxJZC50b1N0cmluZygpLCBtb2RlbCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHNldCh0aGlzLl9fZGF0YU1hcCwgc3RyaW5nVHlwZSwgb2JzZXJ2YWJsZS5zaGFsbG93T2JqZWN0KHtbbW9kZWxJZF06IG1vZGVsfSkpO1xuICAgIH1cbiAgICBzZXRNb2RlbE1ldGFLZXkobW9kZWwsICdjb2xsZWN0aW9uJywgdGhpcyk7XG4gIH1cblxuICBwcml2YXRlIF9fcmVtb3ZlTW9kZWwobW9kZWw6IFB1cmVNb2RlbHxBcnJheTxQdXJlTW9kZWw+LCB0eXBlPzogSVR5cGUsIGlkPzogSUlkZW50aWZpZXIpIHtcbiAgICBpZiAobW9kZWwgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgcmV0dXJuIG1vZGVsLmZvckVhY2goKGl0ZW0pID0+IHRoaXMuX19yZW1vdmVNb2RlbChpdGVtLCB0eXBlLCBpZCkpO1xuICAgIH1cblxuICAgIGNvbnN0IG1vZGVsVHlwZSA9IHR5cGUgfHwgZ2V0TW9kZWxUeXBlKG1vZGVsKTtcbiAgICBjb25zdCBtb2RlbElkID0gaWQgfHwgZ2V0TW9kZWxJZChtb2RlbCk7XG4gICAgdGhpcy5fX2RhdGEucmVtb3ZlKG1vZGVsKTtcbiAgICB0aGlzLl9fZGF0YUxpc3RbbW9kZWxUeXBlXS5yZW1vdmUobW9kZWwpO1xuICAgIHNldCh0aGlzLl9fZGF0YU1hcFttb2RlbFR5cGVdLCBtb2RlbElkLnRvU3RyaW5nKCksIHVuZGVmaW5lZCk7XG4gICAgc2V0TW9kZWxNZXRhS2V5KG1vZGVsLCAnY29sbGVjdGlvbicsIHVuZGVmaW5lZCk7XG4gIH1cblxuICBwcml2YXRlIF9fZmluZEJ5VHlwZShtb2RlbDogSVR5cGV8dHlwZW9mIFB1cmVNb2RlbHxQdXJlTW9kZWwsIGlkPzogSUlkZW50aWZpZXIpIHtcbiAgICBjb25zdCB0eXBlID0gZ2V0TW9kZWxUeXBlKG1vZGVsKTtcbiAgICBjb25zdCBzdHJpbmdUeXBlID0gdHlwZS50b1N0cmluZygpO1xuXG4gICAgaWYgKGlkKSB7XG4gICAgICBpZiAoISh0eXBlIGluIHRoaXMuX19kYXRhTWFwKSkge1xuICAgICAgICBzZXQodGhpcy5fX2RhdGFNYXAsIHN0cmluZ1R5cGUsIHtbaWRdOiB1bmRlZmluZWR9KTtcbiAgICAgIH0gZWxzZSBpZiAoIShpZCBpbiB0aGlzLl9fZGF0YU1hcFt0eXBlXSkpIHtcbiAgICAgICAgc2V0KHRoaXMuX19kYXRhTWFwW3R5cGVdLCBpZC50b1N0cmluZygpLCB1bmRlZmluZWQpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHRoaXMuX19kYXRhTWFwW3R5cGVdW2lkXTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCEodHlwZSBpbiB0aGlzLl9fZGF0YUxpc3QpKSB7XG4gICAgICAgIHNldCh0aGlzLl9fZGF0YUxpc3QsIHN0cmluZ1R5cGUsIG9ic2VydmFibGUuYXJyYXkoW10sIHtkZWVwOiBmYWxzZX0pKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0aGlzLl9fZGF0YUxpc3RbdHlwZV0ubGVuZ3RoID8gdGhpcy5fX2RhdGFMaXN0W3R5cGVdWzBdIDogbnVsbDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9fY2hhbmdlTW9kZWxJZChvbGRJZDogSUlkZW50aWZpZXIsIG5ld0lkOiBJSWRlbnRpZmllciwgdHlwZTogSVR5cGUpIHtcbiAgICB0aGlzLl9fZGF0YU1hcFt0eXBlXVtuZXdJZF0gPSB0aGlzLl9fZGF0YU1hcFt0eXBlXVtvbGRJZF07XG4gICAgZGVsZXRlIHRoaXMuX19kYXRhTWFwW3R5cGVdW29sZElkXTtcbiAgfVxufVxuIl19","map":{"mappings":""},"dts":{"name":"/Users/darko/Projects/mobx/datx/packages/datx/PureCollection.d.ts","text":"import { IDictionary, IRawModel } from 'datx-utils';\r\nimport { IIdentifier } from './interfaces/IIdentifier';\r\nimport { IModelConstructor } from './interfaces/IModelConstructor';\r\nimport { IRawCollection } from './interfaces/IRawCollection';\r\nimport { IType } from './interfaces/IType';\r\nimport { TFilterFn } from './interfaces/TFilterFn';\r\nimport { PureModel } from './PureModel';\r\nexport declare class PureCollection {\r\n    /**\r\n     * List of models available in the collection\r\n     *\r\n     * @static\r\n     * @type {Array<typeof PureModel>}\r\n     * @memberof Collection\r\n     */\r\n    static types: Array<typeof PureModel | IModelConstructor<PureModel>>;\r\n    static views: IDictionary<{\r\n        modelType: IType | PureModel;\r\n        sortMethod?: string | ((PureModel) => any);\r\n        unique?: boolean;\r\n        mixins?: Array<(view: any) => any>;\r\n    }>;\r\n    static defaultModel?: typeof PureModel;\r\n    private __data;\r\n    private __views;\r\n    private __dataMap;\r\n    private __dataList;\r\n    constructor(data?: Array<IRawModel> | IRawCollection);\r\n    /**\r\n     * Function for inserting raw models into the collection. Used when hydrating the collection\r\n     *\r\n     * @param {Array<IRawModel>} data Raw model data\r\n     * @returns {Array<PureModel>} A list of initialized models\r\n     * @memberof Collection\r\n     */\r\n    insert(data: Array<Partial<IRawModel>>): Array<PureModel>;\r\n    /**\r\n     * Add an existing model to the collection\r\n     *\r\n     * @template T\r\n     * @param {T} data Model to be added\r\n     * @returns {T} Added model\r\n     * @memberof Collection\r\n     */\r\n    add<T extends PureModel>(data: T): T;\r\n    /**\r\n     * Add an array of existing models to the collection\r\n     *\r\n     * @template T\r\n     * @param {Array<T>} data Array of models to be added\r\n     * @returns {Array<T>} Added models\r\n     * @memberof Collection\r\n     */\r\n    add<T extends PureModel>(data: Array<T>): Array<T>;\r\n    /**\r\n     * Add an array of new models to the collection\r\n     *\r\n     * @template T\r\n     * @param {Array<IRawModel|IDictionary<any>>} data Array of new data to be added\r\n     * @param {(IType|IModelConstructor<T>)} model Model type to be added\r\n     * @returns {Array<T>} Added models\r\n     * @memberof Collection\r\n     */\r\n    add<T extends PureModel>(data: Array<IRawModel | IDictionary<any>>, model: IType | IModelConstructor<T>): Array<T>;\r\n    /**\r\n     * Add a new model to the collection\r\n     *\r\n     * @template T\r\n     * @param {(IRawModel|IDictionary<any>)} data New data to be added\r\n     * @param {(IType|IModelConstructor<T>)} model Model type to be added\r\n     * @returns {T} Added model\r\n     * @memberof Collection\r\n     */\r\n    add<T extends PureModel>(data: IRawModel | IDictionary<any>, model: IType | IModelConstructor<T>): T;\r\n    /**\r\n     * Find a model based on the defined type and (optional) identifier\r\n     *\r\n     * @param {(IType|typeof PureModel|PureModel)} type Model type\r\n     * @param {IIdentifier} [id] Model identifier\r\n     * @returns {(PureModel|null)} The first matching model\r\n     * @memberof Collection\r\n     */\r\n    find<T extends PureModel>(type: IType | T | IModelConstructor<T>, id?: IIdentifier | PureModel): T | null;\r\n    /**\r\n     * Find a model based on a matching function\r\n     *\r\n     * @param {TFilterFn} test Function used to match the model\r\n     * @returns {(PureModel|null)} The first matching model\r\n     * @memberof Collection\r\n     */\r\n    find<T extends PureModel>(test: TFilterFn): T | null;\r\n    /**\r\n     * Filter models based on a matching function\r\n     *\r\n     * @param {TFilterFn} test Function used to match the models\r\n     * @returns {(PureModel|null)} The matching models\r\n     * @memberof Collection\r\n     */\r\n    filter(test: TFilterFn): Array<PureModel>;\r\n    /**\r\n     * Find all matching models or all models if no type is given\r\n     *\r\n     * @param {(IType|typeof PureModel)} [model] Model type to select\r\n     * @returns {Array<PureModel>} List of matching models\r\n     * @memberof Collection\r\n     */\r\n    findAll<T extends PureModel>(model?: IType | IModelConstructor<T>): Array<T>;\r\n    /**\r\n     * Check if a model is in the collection\r\n     *\r\n     * @param {PureModel} model Model to check\r\n     * @returns {boolean} The given model is in the collection\r\n     * @memberof Collection\r\n     */\r\n    hasItem(model: PureModel): boolean;\r\n    /**\r\n     * Remove the first model based on the type and (optional) identifier\r\n     *\r\n     * @param {(IType|typeof PureModel)} type Model type\r\n     * @param {IIdentifier} [id] Model identifier\r\n     * @memberof Collection\r\n     */\r\n    remove(type: IType | typeof PureModel, id?: IIdentifier): any;\r\n    /**\r\n     * Remove the given model from the collection\r\n     *\r\n     * @param {PureModel} model Model to be removed from the collection\r\n     * @memberof Collection\r\n     */\r\n    remove(model: PureModel): any;\r\n    /**\r\n     * Remove all models of the given model type from the collection\r\n     *\r\n     * @param {(IType|typeof PureModel)} type Model type\r\n     * @memberof Collection\r\n     */\r\n    removeAll(type: IType | typeof PureModel): void;\r\n    /**\r\n     * A total count of models in the collection\r\n     *\r\n     * @readonly\r\n     * @type {number}\r\n     * @memberof Collection\r\n     */\r\n    readonly length: number;\r\n    /**\r\n     * Get the serializable value of the collection\r\n     *\r\n     * @returns {IRawCollection} Pure JS value of the collection\r\n     * @memberof Collection\r\n     */\r\n    toJSON(): IRawCollection;\r\n    readonly snapshot: IRawCollection;\r\n    /**\r\n     * Reset the collection (remove all models)\r\n     *\r\n     * @memberof Collection\r\n     */\r\n    reset(): void;\r\n    getAllModels(): PureModel[];\r\n    /**\r\n     * Add a view to the collection\r\n     *\r\n     * @template T Model type of the view\r\n     * @param {string} name View name\r\n     * @param {(IModelConstructor<T>|IType)} type Model type the view will represent\r\n     * @param {({\r\n     *       sortMethod?: string|((item: T) => any),\r\n     *       models?: Array<IIdentifier|PureModel>,\r\n     *       unique?: boolean,\r\n     *       mixins?: Array<(view: any) => any>,\r\n     *     })} [{sortMethod, models, unique, mixins}={}] View options\r\n     * @returns {View} The created view\r\n     * @memberof PureCollection\r\n     */\r\n    addView<T extends PureModel = PureModel>(name: string, type: IModelConstructor<T> | IType, {sortMethod, models, unique, mixins}?: {\r\n        sortMethod?: string | ((item: T) => any);\r\n        models?: Array<IIdentifier | T>;\r\n        unique?: boolean;\r\n        mixins?: Array<(view: any) => any>;\r\n    }): any;\r\n    private __addArray<T>(data);\r\n    private __addArray<T>(data, model?);\r\n    private __addSingle<T>(data);\r\n    private __addSingle<T>(data, model?);\r\n    private __insertModel(model, type?, id?);\r\n    private __removeModel(model, type?, id?);\r\n    private __findByType(model, id?);\r\n    private __changeModelId(oldId, newId, type);\r\n}\r\n"}}
