{"code":"import { assignComputed, META_FIELD } from 'datx-utils';\r\nimport { FieldType } from '../../enums/FieldType';\r\nimport { ReferenceType } from '../../enums/ReferenceType';\r\nimport { ID_REQUIRED } from '../../errors';\r\nimport { storage } from '../../services/storage';\r\nimport { getField, getRef, updateField, updateRef } from './fields';\r\nimport { getModelMetaKey, getModelType, setModelMetaKey } from './utils';\r\nexport function initModelField(obj, key, defValue, type) {\r\n    if (type === void 0) { type = FieldType.DATA; }\r\n    var fields = getModelMetaKey(obj, 'fields');\r\n    // Initialize the observable field to the default value\r\n    storage.setModelDataKey(obj, key, defValue);\r\n    if (fields.indexOf(key) === -1) {\r\n        fields.push(key);\r\n    }\r\n    assignComputed(obj, key, function () { return getField(obj, key); }, function (value) { return updateField(obj, key, value, type); });\r\n}\r\n/**\r\n * Initialize a reference to other models\r\n *\r\n * @export\r\n * @param {PureModel} obj Model to which the reference should be added\r\n * @param {string} key Model property where the reference will be defined\r\n * @param {IReferenceOptions} options Reference options\r\n * @param {TRefValue} initialVal Initial reference value\r\n */\r\nexport function initModelRef(obj, key, options, initialVal) {\r\n    var refs = getModelMetaKey(obj, 'refs');\r\n    // Initialize the observable field to the given value\r\n    refs[key] = options;\r\n    var isArray = options.type === ReferenceType.TO_MANY;\r\n    storage.setModelDataKey(obj, key, isArray ? [] : undefined);\r\n    assignComputed(obj, key, function () { return getRef(obj, key); }, function (value) { return updateRef(obj, key, value); });\r\n    if (!options.property) {\r\n        obj[key] = initialVal;\r\n    }\r\n}\r\nfunction prepareFields(data, meta, model) {\r\n    var staticModel = model.constructor;\r\n    var fields = meta.fields.slice();\r\n    var classRefs = storage.getModelClassReferences(staticModel);\r\n    var refs = Object.assign({}, classRefs, meta.refs);\r\n    var defaults = storage.getModelDefaults(staticModel);\r\n    Object.keys(data).concat(Object.keys(defaults))\r\n        .forEach(function (key) {\r\n        if (!(key in refs) && fields.indexOf(key) === -1) {\r\n            fields.push(key);\r\n        }\r\n    });\r\n    return { defaults: defaults, fields: fields, refs: refs };\r\n}\r\nfunction initModelData(model, data, meta, collection) {\r\n    var _a = prepareFields(data, meta, model), defaults = _a.defaults, fields = _a.fields, refs = _a.refs;\r\n    var staticModel = model.constructor;\r\n    var modelId = storage.getModelClassMetaKey(staticModel, 'id');\r\n    var modelType = storage.getModelClassMetaKey(staticModel, 'type');\r\n    fields.forEach(function (key) {\r\n        var type = FieldType.DATA;\r\n        var value = data[key];\r\n        if (value === undefined) {\r\n            value = defaults[key];\r\n        }\r\n        if (key === (modelId || 'id')) {\r\n            type = FieldType.ID;\r\n            value = meta.id;\r\n        }\r\n        else if (key === modelType) {\r\n            type = FieldType.TYPE;\r\n            value = meta.type;\r\n        }\r\n        initModelField(model, key, value, type);\r\n    });\r\n    if (modelId && !(modelId in fields)) {\r\n        initModelField(model, modelId, meta.id, FieldType.ID);\r\n    }\r\n    Object.keys(refs).forEach(function (key) {\r\n        var opts = refs[key];\r\n        var value = data[key] || defaults[key] || undefined;\r\n        var models = collection ? collection.add(value, getModelType(opts.model)) : value;\r\n        initModelRef(model, key, opts, models);\r\n    });\r\n}\r\nfunction initModelMeta(model, data, collection) {\r\n    var staticModel = model.constructor;\r\n    var modelId = storage.getModelClassMetaKey(staticModel, 'id') || 'id';\r\n    var modelType = storage.getModelClassMetaKey(staticModel, 'type');\r\n    var type = (modelType && data[modelType]) || getModelType(model);\r\n    var id = (modelId && data[modelId]);\r\n    if (!id) {\r\n        if (!staticModel.enableAutoId) {\r\n            throw new Error(ID_REQUIRED);\r\n        }\r\n        id = staticModel.getAutoId();\r\n        while (collection && collection.find(type, id)) {\r\n            id = staticModel.getAutoId();\r\n        }\r\n    }\r\n    var meta = {\r\n        fields: [],\r\n        id: id,\r\n        refs: {},\r\n        type: type,\r\n    };\r\n    var newMeta;\r\n    var toInit = { fields: [], refs: {} };\r\n    if (META_FIELD in data && data[META_FIELD]) {\r\n        var oldMeta = data[META_FIELD];\r\n        toInit.fields = oldMeta.fields;\r\n        delete oldMeta.fields;\r\n        toInit.refs = oldMeta.refs;\r\n        delete oldMeta.refs;\r\n        newMeta = storage.setModelMeta(model, Object.assign(meta, oldMeta));\r\n        delete data[META_FIELD];\r\n    }\r\n    else {\r\n        newMeta = storage.setModelMeta(model, meta);\r\n    }\r\n    return Object.assign({}, newMeta, toInit);\r\n}\r\nexport function initModel(model, rawData, collection) {\r\n    var staticModel = model.constructor;\r\n    var data = Object.assign({}, staticModel.preprocess(rawData, collection));\r\n    setModelMetaKey(model, 'collection', collection);\r\n    var meta = initModelMeta(model, data, collection);\r\n    initModelData(model, data, meta, collection);\r\n}\r\n//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5pdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9oZWxwZXJzL21vZGVsL2luaXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLGNBQWMsRUFBMEIsVUFBVSxFQUFDLE1BQU0sWUFBWSxDQUFDO0FBRzlFLE9BQU8sRUFBQyxTQUFTLEVBQUMsTUFBTSx1QkFBdUIsQ0FBQztBQUNoRCxPQUFPLEVBQUMsYUFBYSxFQUFDLE1BQU0sMkJBQTJCLENBQUM7QUFDeEQsT0FBTyxFQUFDLFdBQVcsRUFBZSxNQUFNLGNBQWMsQ0FBQztBQU92RCxPQUFPLEVBQUMsT0FBTyxFQUFDLE1BQU0sd0JBQXdCLENBQUM7QUFFL0MsT0FBTyxFQUFDLFFBQVEsRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBQyxNQUFNLFVBQVUsQ0FBQztBQUNsRSxPQUFPLEVBQUMsZUFBZSxFQUFFLFlBQVksRUFBRSxlQUFlLEVBQUMsTUFBTSxTQUFTLENBQUM7QUFPdkUsTUFBTSx5QkFDSixHQUFNLEVBQ04sR0FBVyxFQUNYLFFBQWEsRUFDYixJQUFnQztJQUFoQyxxQkFBQSxFQUFBLE9BQWtCLFNBQVMsQ0FBQyxJQUFJO0lBRWhDLElBQU0sTUFBTSxHQUFHLGVBQWUsQ0FBQyxHQUFHLEVBQUUsUUFBUSxDQUFrQixDQUFDO0lBRS9ELHVEQUF1RDtJQUN2RCxPQUFPLENBQUMsZUFBZSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDNUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFO1FBQzlCLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7S0FDbEI7SUFFRCxjQUFjLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxjQUFNLE9BQUEsUUFBUSxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsRUFBbEIsQ0FBa0IsRUFBRSxVQUFDLEtBQUss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L0MsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7YXNzaWduQ29tcHV0ZWQsIElEaWN0aW9uYXJ5LCBJUmF3TW9kZWwsIE1FVEFfRklFTER9IGZyb20gJ2RhdHgtdXRpbHMnO1xuaW1wb3J0IHtjb21wdXRlZCwgZGVjb3JhdGUsIGV4dGVuZE9ic2VydmFibGUsIElPYnNlcnZhYmxlT2JqZWN0LCBpc09ic2VydmFibGUsIHNldH0gZnJvbSAnbW9ieCc7XG5cbmltcG9ydCB7RmllbGRUeXBlfSBmcm9tICcuLi8uLi9lbnVtcy9GaWVsZFR5cGUnO1xuaW1wb3J0IHtSZWZlcmVuY2VUeXBlfSBmcm9tICcuLi8uLi9lbnVtcy9SZWZlcmVuY2VUeXBlJztcbmltcG9ydCB7SURfUkVRVUlSRUQsIE1PREVMX0VYSVNUU30gZnJvbSAnLi4vLi4vZXJyb3JzJztcbmltcG9ydCB7SUlkZW50aWZpZXJ9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvSUlkZW50aWZpZXInO1xuaW1wb3J0IHtJUmVmZXJlbmNlT3B0aW9uc30gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9JUmVmZXJlbmNlT3B0aW9ucyc7XG5pbXBvcnQge0lUeXBlfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL0lUeXBlJztcbmltcG9ydCB7VFJlZlZhbHVlfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL1RSZWZWYWx1ZSc7XG5pbXBvcnQge1B1cmVDb2xsZWN0aW9ufSBmcm9tICcuLi8uLi9QdXJlQ29sbGVjdGlvbic7XG5pbXBvcnQge1B1cmVNb2RlbH0gZnJvbSAnLi4vLi4vUHVyZU1vZGVsJztcbmltcG9ydCB7c3RvcmFnZX0gZnJvbSAnLi4vLi4vc2VydmljZXMvc3RvcmFnZSc7XG5pbXBvcnQge2Vycm9yfSBmcm9tICcuLi9mb3JtYXQnO1xuaW1wb3J0IHtnZXRGaWVsZCwgZ2V0UmVmLCB1cGRhdGVGaWVsZCwgdXBkYXRlUmVmfSBmcm9tICcuL2ZpZWxkcyc7XG5pbXBvcnQge2dldE1vZGVsTWV0YUtleSwgZ2V0TW9kZWxUeXBlLCBzZXRNb2RlbE1ldGFLZXl9IGZyb20gJy4vdXRpbHMnO1xuXG5pbnRlcmZhY2UgSU1ldGFUb0luaXQgZXh0ZW5kcyBJRGljdGlvbmFyeTxhbnk+IHtcbiAgZmllbGRzOiBBcnJheTxzdHJpbmc+O1xuICByZWZzOiBJRGljdGlvbmFyeTxJUmVmZXJlbmNlT3B0aW9ucz47XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpbml0TW9kZWxGaWVsZDxUIGV4dGVuZHMgUHVyZU1vZGVsPihcbiAgb2JqOiBULFxuICBrZXk6IHN0cmluZyxcbiAgZGVmVmFsdWU6IGFueSxcbiAgdHlwZTogRmllbGRUeXBlID0gRmllbGRUeXBlLkRBVEEsXG4pIHtcbiAgY29uc3QgZmllbGRzID0gZ2V0TW9kZWxNZXRhS2V5KG9iaiwgJ2ZpZWxkcycpIGFzIEFycmF5PHN0cmluZz47XG5cbiAgLy8gSW5pdGlhbGl6ZSB0aGUgb2JzZXJ2YWJsZSBmaWVsZCB0byB0aGUgZGVmYXVsdCB2YWx1ZVxuICBzdG9yYWdlLnNldE1vZGVsRGF0YUtleShvYmosIGtleSwgZGVmVmFsdWUpO1xuICBpZiAoZmllbGRzLmluZGV4T2Yoa2V5KSA9PT0gLTEpIHtcbiAgICBmaWVsZHMucHVzaChrZXkpO1xuICB9XG5cbiAgYXNzaWduQ29tcHV0ZWQob2JqLCBrZXksICgpID0+IGdldEZpZWxkKG9iaiwga2V5KSwgKHZhbHVlKSA9PiB1cGRhdGVGaWVsZChvYmosIGtleSwgdmFsdWUsIHR5cGUpKTtcbn1cblxuLyoqXG4gKiBJbml0aWFsaXplIGEgcmVmZXJlbmNlIHRvIG90aGVyIG1vZGVsc1xuICpcbiAqIEBleHBvcnRcbiAqIEBwYXJhbSB7UHVyZU1vZGVsfSBvYmogTW9kZWwgdG8gd2hpY2ggdGhlIHJlZmVyZW5jZSBzaG91bGQgYmUgYWRkZWRcbiAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgTW9kZWwgcHJvcGVydHkgd2hlcmUgdGhlIHJlZmVyZW5jZSB3aWxsIGJlIGRlZmluZWRcbiAqIEBwYXJhbSB7SVJlZmVyZW5jZU9wdGlvbnN9IG9wdGlvbnMgUmVmZXJlbmNlIG9wdGlvbnNcbiAqIEBwYXJhbSB7VFJlZlZhbHVlfSBpbml0aWFsVmFsIEluaXRpYWwgcmVmZXJlbmNlIHZhbHVlXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpbml0TW9kZWxSZWYob2JqOiBQdXJlTW9kZWwsIGtleTogc3RyaW5nLCBvcHRpb25zOiBJUmVmZXJlbmNlT3B0aW9ucywgaW5pdGlhbFZhbDogVFJlZlZhbHVlKSB7XG4gIGNvbnN0IHJlZnMgPSBnZXRNb2RlbE1ldGFLZXkob2JqLCAncmVmcycpO1xuXG4gIC8vIEluaXRpYWxpemUgdGhlIG9ic2VydmFibGUgZmllbGQgdG8gdGhlIGdpdmVuIHZhbHVlXG4gIHJlZnNba2V5XSA9IG9wdGlvbnM7XG5cbiAgY29uc3QgaXNBcnJheSA9IG9wdGlvbnMudHlwZSA9PT0gUmVmZXJlbmNlVHlwZS5UT19NQU5ZO1xuICBzdG9yYWdlLnNldE1vZGVsRGF0YUtleShvYmosIGtleSwgaXNBcnJheSA/IFtdIDogdW5kZWZpbmVkKTtcblxuICBhc3NpZ25Db21wdXRlZChvYmosIGtleSwgKCkgPT4gZ2V0UmVmKG9iaiwga2V5KSwgKHZhbHVlKSA9PiB1cGRhdGVSZWYob2JqLCBrZXksIHZhbHVlKSk7XG5cbiAgaWYgKCFvcHRpb25zLnByb3BlcnR5KSB7XG4gICAgb2JqW2tleV0gPSBpbml0aWFsVmFsO1xuICB9XG59XG5cbmZ1bmN0aW9uIHByZXBhcmVGaWVsZHMoZGF0YTogSVJhd01vZGVsLCBtZXRhOiBJTWV0YVRvSW5pdCwgbW9kZWw6IFB1cmVNb2RlbCkge1xuICBjb25zdCBzdGF0aWNNb2RlbCA9IG1vZGVsLmNvbnN0cnVjdG9yIGFzIHR5cGVvZiBQdXJlTW9kZWw7XG4gIGNvbnN0IGZpZWxkcyA9IG1ldGEuZmllbGRzLnNsaWNlKCk7XG4gIGNvbnN0IGNsYXNzUmVmcyA9IHN0b3JhZ2UuZ2V0TW9kZWxDbGFzc1JlZmVyZW5jZXMoc3RhdGljTW9kZWwpO1xuICBjb25zdCByZWZzID0gT2JqZWN0LmFzc2lnbih7fSwgY2xhc3NSZWZzLCBtZXRhLnJlZnMpO1xuXG4gIGNvbnN0IGRlZmF1bHRzID0gc3RvcmFnZS5nZXRNb2RlbERlZmF1bHRzKHN0YXRpY01vZGVsKTtcblxuICBPYmplY3Qua2V5cyhkYXRhKS5jb25jYXQoT2JqZWN0LmtleXMoZGVmYXVsdHMpKVxuICAgIC5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgIGlmICghKGtleSBpbiByZWZzKSAmJiBmaWVsZHMuaW5kZXhPZihrZXkpID09PSAtMSkge1xuICAgICAgICBmaWVsZHMucHVzaChrZXkpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gIHJldHVybiB7ZGVmYXVsdHMsIGZpZWxkcywgcmVmc307XG59XG5cbmZ1bmN0aW9uIGluaXRNb2RlbERhdGEobW9kZWw6IFB1cmVNb2RlbCwgZGF0YTogSVJhd01vZGVsLCBtZXRhOiBJTWV0YVRvSW5pdCwgY29sbGVjdGlvbj86IFB1cmVDb2xsZWN0aW9uKSB7XG4gIGNvbnN0IHtkZWZhdWx0cywgZmllbGRzLCByZWZzfSA9IHByZXBhcmVGaWVsZHMoZGF0YSwgbWV0YSwgbW9kZWwpO1xuXG4gIGNvbnN0IHN0YXRpY01vZGVsID0gbW9kZWwuY29uc3RydWN0b3IgYXMgdHlwZW9mIFB1cmVNb2RlbDtcbiAgY29uc3QgbW9kZWxJZCA9IHN0b3JhZ2UuZ2V0TW9kZWxDbGFzc01ldGFLZXkoc3RhdGljTW9kZWwsICdpZCcpO1xuICBjb25zdCBtb2RlbFR5cGUgPSBzdG9yYWdlLmdldE1vZGVsQ2xhc3NNZXRhS2V5KHN0YXRpY01vZGVsLCAndHlwZScpO1xuXG4gIGZpZWxkcy5mb3JFYWNoKChrZXkpID0+IHtcbiAgICBsZXQgdHlwZSA9IEZpZWxkVHlwZS5EQVRBO1xuICAgIGxldCB2YWx1ZSA9IGRhdGFba2V5XTtcbiAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdmFsdWUgPSBkZWZhdWx0c1trZXldO1xuICAgIH1cbiAgICBpZiAoa2V5ID09PSAobW9kZWxJZCB8fCAnaWQnKSkge1xuICAgICAgdHlwZSA9IEZpZWxkVHlwZS5JRDtcbiAgICAgIHZhbHVlID0gbWV0YS5pZDtcbiAgICB9IGVsc2UgaWYgKGtleSA9PT0gbW9kZWxUeXBlKSB7XG4gICAgICB0eXBlID0gRmllbGRUeXBlLlRZUEU7XG4gICAgICB2YWx1ZSA9IG1ldGEudHlwZTtcbiAgICB9XG4gICAgaW5pdE1vZGVsRmllbGQobW9kZWwsIGtleSwgdmFsdWUsIHR5cGUpO1xuICB9KTtcblxuICBpZiAobW9kZWxJZCAmJiAhKG1vZGVsSWQgaW4gZmllbGRzKSkge1xuICAgIGluaXRNb2RlbEZpZWxkKG1vZGVsLCBtb2RlbElkLCBtZXRhLmlkLCBGaWVsZFR5cGUuSUQpO1xuICB9XG5cbiAgT2JqZWN0LmtleXMocmVmcykuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgY29uc3Qgb3B0cyA9IHJlZnNba2V5XTtcbiAgICBjb25zdCB2YWx1ZSA9IGRhdGFba2V5XSB8fCBkZWZhdWx0c1trZXldIHx8IHVuZGVmaW5lZDtcbiAgICBjb25zdCBtb2RlbHM6IGFueSA9IGNvbGxlY3Rpb24gPyBjb2xsZWN0aW9uLmFkZCh2YWx1ZSwgZ2V0TW9kZWxUeXBlKG9wdHMubW9kZWwpKSA6IHZhbHVlO1xuICAgIGluaXRNb2RlbFJlZihtb2RlbCwga2V5LCBvcHRzLCBtb2RlbHMpO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gaW5pdE1vZGVsTWV0YShtb2RlbDogUHVyZU1vZGVsLCBkYXRhOiBJUmF3TW9kZWwsIGNvbGxlY3Rpb24/OiBQdXJlQ29sbGVjdGlvbik6IElEaWN0aW9uYXJ5PGFueT4gJiBJTWV0YVRvSW5pdCB7XG4gIGNvbnN0IHN0YXRpY01vZGVsID0gbW9kZWwuY29uc3RydWN0b3IgYXMgdHlwZW9mIFB1cmVNb2RlbDtcbiAgY29uc3QgbW9kZWxJZCA9IHN0b3JhZ2UuZ2V0TW9kZWxDbGFzc01ldGFLZXkoc3RhdGljTW9kZWwsICdpZCcpIHx8ICdpZCc7XG4gIGNvbnN0IG1vZGVsVHlwZSA9IHN0b3JhZ2UuZ2V0TW9kZWxDbGFzc01ldGFLZXkoc3RhdGljTW9kZWwsICd0eXBlJyk7XG5cbiAgY29uc3QgdHlwZSA9IChtb2RlbFR5cGUgJiYgZGF0YVttb2RlbFR5cGVdKSB8fCBnZXRNb2RlbFR5cGUobW9kZWwpO1xuICBsZXQgaWQgPSAobW9kZWxJZCAmJiBkYXRhW21vZGVsSWRdKTtcblxuICBpZiAoIWlkKSB7XG4gICAgaWYgKCFzdGF0aWNNb2RlbC5lbmFibGVBdXRvSWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihJRF9SRVFVSVJFRCk7XG4gICAgfVxuICAgIGlkID0gc3RhdGljTW9kZWwuZ2V0QXV0b0lkKCk7XG4gICAgd2hpbGUgKGNvbGxlY3Rpb24gJiYgY29sbGVjdGlvbi5maW5kKHR5cGUsIGlkKSkge1xuICAgICAgaWQgPSBzdGF0aWNNb2RlbC5nZXRBdXRvSWQoKTtcbiAgICB9XG4gIH1cblxuICBjb25zdCBtZXRhID0ge1xuICAgIGZpZWxkczogW10sXG4gICAgaWQsXG4gICAgcmVmczoge30sXG4gICAgdHlwZSxcbiAgfTtcblxuICBsZXQgbmV3TWV0YTtcbiAgY29uc3QgdG9Jbml0OiBJTWV0YVRvSW5pdCA9IHtmaWVsZHM6IFtdLCByZWZzOiB7fX07XG4gIGlmIChNRVRBX0ZJRUxEIGluIGRhdGEgJiYgZGF0YVtNRVRBX0ZJRUxEXSkge1xuXG4gICAgY29uc3Qgb2xkTWV0YSA9IGRhdGFbTUVUQV9GSUVMRF0gYXMgSURpY3Rpb25hcnk8YW55PjtcbiAgICB0b0luaXQuZmllbGRzID0gb2xkTWV0YS5maWVsZHM7XG4gICAgZGVsZXRlIG9sZE1ldGEuZmllbGRzO1xuICAgIHRvSW5pdC5yZWZzID0gb2xkTWV0YS5yZWZzO1xuICAgIGRlbGV0ZSBvbGRNZXRhLnJlZnM7XG5cbiAgICBuZXdNZXRhID0gc3RvcmFnZS5zZXRNb2RlbE1ldGEobW9kZWwsIE9iamVjdC5hc3NpZ24obWV0YSwgb2xkTWV0YSkpO1xuICAgIGRlbGV0ZSBkYXRhW01FVEFfRklFTERdO1xuICB9IGVsc2Uge1xuICAgIG5ld01ldGEgPSBzdG9yYWdlLnNldE1vZGVsTWV0YShtb2RlbCwgbWV0YSk7XG4gIH1cbiAgcmV0dXJuIE9iamVjdC5hc3NpZ24oe30sIG5ld01ldGEsIHRvSW5pdCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpbml0TW9kZWwobW9kZWw6IFB1cmVNb2RlbCwgcmF3RGF0YTogSVJhd01vZGVsLCBjb2xsZWN0aW9uPzogUHVyZUNvbGxlY3Rpb24pIHtcbiAgY29uc3Qgc3RhdGljTW9kZWwgPSBtb2RlbC5jb25zdHJ1Y3RvciBhcyB0eXBlb2YgUHVyZU1vZGVsO1xuICBjb25zdCBkYXRhID0gT2JqZWN0LmFzc2lnbih7fSwgc3RhdGljTW9kZWwucHJlcHJvY2VzcyhyYXdEYXRhLCBjb2xsZWN0aW9uKSk7XG4gIHNldE1vZGVsTWV0YUtleShtb2RlbCwgJ2NvbGxlY3Rpb24nLCBjb2xsZWN0aW9uKTtcbiAgY29uc3QgbWV0YSA9IGluaXRNb2RlbE1ldGEobW9kZWwsIGRhdGEsIGNvbGxlY3Rpb24pO1xuICBpbml0TW9kZWxEYXRhKG1vZGVsLCBkYXRhLCBtZXRhLCBjb2xsZWN0aW9uKTtcbn1cbiJdfQ==","map":{"mappings":""},"dts":{"name":"/Users/darko/Projects/mobx/datx/packages/datx/helpers/model/init.d.ts","text":"import { IRawModel } from 'datx-utils';\r\nimport { FieldType } from '../../enums/FieldType';\r\nimport { IReferenceOptions } from '../../interfaces/IReferenceOptions';\r\nimport { TRefValue } from '../../interfaces/TRefValue';\r\nimport { PureCollection } from '../../PureCollection';\r\nimport { PureModel } from '../../PureModel';\r\nexport declare function initModelField<T extends PureModel>(obj: T, key: string, defValue: any, type?: FieldType): void;\r\n/**\r\n * Initialize a reference to other models\r\n *\r\n * @export\r\n * @param {PureModel} obj Model to which the reference should be added\r\n * @param {string} key Model property where the reference will be defined\r\n * @param {IReferenceOptions} options Reference options\r\n * @param {TRefValue} initialVal Initial reference value\r\n */\r\nexport declare function initModelRef(obj: PureModel, key: string, options: IReferenceOptions, initialVal: TRefValue): void;\r\nexport declare function initModel(model: PureModel, rawData: IRawModel, collection?: PureCollection): void;\r\n"}}
