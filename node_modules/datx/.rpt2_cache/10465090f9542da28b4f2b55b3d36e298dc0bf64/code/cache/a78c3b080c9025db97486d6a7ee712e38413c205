{"code":"import { mapItems, warn } from 'datx-utils';\r\nimport { intercept, isObservableArray, observable } from 'mobx';\r\nimport { FieldType } from '../../enums/FieldType';\r\nimport { ReferenceType } from '../../enums/ReferenceType';\r\nimport { BACK_REF_READ_ONLY, ID_READONLY, REF_ARRAY, REF_NEEDS_COLLECTION, REF_SINGLE, TYPE_READONLY, WRONG_REF_TYPE, } from '../../errors';\r\nimport { PureModel } from '../../PureModel';\r\nimport { storage } from '../../services/storage';\r\nimport { error } from '../format';\r\nimport { getModelCollection, getModelId, getModelMetaKey, getModelType, setModelMetaKey } from './utils';\r\nfunction modelAddReference(model, key, newReference) {\r\n    var refOptions = storage.getModelReferenceOptions(model, key);\r\n    var newRefId = getModelId(newReference);\r\n    var data = storage.getModelDataKey(model, key);\r\n    if (refOptions.type === ReferenceType.TO_ONE) {\r\n        storage.setModelDataKey(model, key, newRefId);\r\n    }\r\n    else if (refOptions.type === ReferenceType.TO_MANY || isObservableArray(data)) {\r\n        data.push(newRefId);\r\n    }\r\n    else {\r\n        storage.setModelDataKey(model, key, newReference);\r\n    }\r\n}\r\nfunction modelRemoveReference(model, key, oldReference) {\r\n    var refOptions = storage.getModelReferenceOptions(model, key);\r\n    var oldRefId = getModelId(oldReference);\r\n    var data = storage.getModelDataKey(model, key);\r\n    if (refOptions.type === ReferenceType.TO_ONE) {\r\n        storage.setModelDataKey(model, key, null);\r\n    }\r\n    else if (refOptions.type === ReferenceType.TO_MANY || isObservableArray(data)) {\r\n        data.remove(oldRefId);\r\n    }\r\n    else {\r\n        storage.setModelDataKey(model, key, null);\r\n    }\r\n}\r\nfunction ensureModel(refOptions, collection) {\r\n    return function (data) {\r\n        var model = data;\r\n        if (!(data instanceof PureModel) && typeof data === 'object') {\r\n            if (!collection) {\r\n                throw new Error(REF_NEEDS_COLLECTION);\r\n            }\r\n            model = collection.add(data, refOptions.model);\r\n        }\r\n        return getModelId(model);\r\n    };\r\n}\r\nfunction partialRefUpdate(model, key, change) {\r\n    var refOptions = storage.getModelReferenceOptions(model, key);\r\n    var data = storage.getModelDataKey(model, key);\r\n    var collection = getModelCollection(model);\r\n    if (change.type === 'splice') {\r\n        var added = change.added.map(ensureModel(refOptions, collection));\r\n        data.splice.apply(data, [change.index, change.removedCount].concat(added));\r\n        return null;\r\n    }\r\n    data[change.index] = ensureModel(refOptions, collection)(change.newValue);\r\n    return null;\r\n}\r\nfunction backRefSplice(model, key, change, refOptions) {\r\n    var property = refOptions.property;\r\n    change.added.map(function (item) { return modelAddReference(item, property, model); });\r\n    var removed = model[key].slice(change.index, change.index + change.removedCount);\r\n    removed.map(function (item) { return modelRemoveReference(item, property, model); });\r\n    return null;\r\n}\r\nfunction backRefChange(model, key, change, refOptions) {\r\n    var property = refOptions.property;\r\n    var oldValue = model[key].length > change.index ? model[key][change.index] : null;\r\n    if (change.newValue) {\r\n        modelAddReference(change.newValue, property, model);\r\n    }\r\n    if (oldValue) {\r\n        modelRemoveReference(oldValue, property, model);\r\n    }\r\n    warn(\"This shouldn't have happened. Please open an issue: https://github.com/infinum/datx/issues/new\");\r\n    return null;\r\n}\r\nfunction partialBackRefUpdate(model, key, change) {\r\n    var refOptions = storage.getModelReferenceOptions(model, key);\r\n    if (change.type === 'splice') {\r\n        return backRefSplice(model, key, change, refOptions);\r\n    }\r\n    return backRefChange(model, key, change, refOptions);\r\n}\r\nexport function getField(model, key) {\r\n    return storage.getModelDataKey(model, key);\r\n}\r\nexport function updateField(model, key, value, type) {\r\n    if (type === FieldType.TYPE) {\r\n        throw error(TYPE_READONLY);\r\n    }\r\n    else if (type === FieldType.ID) {\r\n        throw error(ID_READONLY);\r\n    }\r\n    var refs = getModelMetaKey(model, 'refs');\r\n    if (key in refs) {\r\n        updateRef(model, key, value);\r\n    }\r\n    else {\r\n        storage.setModelDataKey(model, key, value);\r\n    }\r\n}\r\nfunction hasBackRef(item, property, target) {\r\n    if (item[property] === null || item[property] === undefined) {\r\n        return false;\r\n    }\r\n    else if (item[property] instanceof PureModel) {\r\n        return item[property] === target;\r\n    }\r\n    else {\r\n        return item[property].indexOf(target) !== -1;\r\n    }\r\n}\r\nfunction getBackRef(model, key, refOptions) {\r\n    var type = getModelType(refOptions.model);\r\n    var collection = getModelCollection(model);\r\n    if (!collection) {\r\n        return null;\r\n    }\r\n    var backModels = collection\r\n        .findAll(type)\r\n        .filter(function (item) { return hasBackRef(item, refOptions.property, model); });\r\n    var backData = observable.array(backModels, { deep: false });\r\n    intercept(backData, function (change) { return partialBackRefUpdate(model, key, change); });\r\n    return backData;\r\n}\r\nfunction getNormalRef(model, key, refOptions) {\r\n    var value = storage.getModelDataKey(model, key);\r\n    var collection = getModelCollection(model);\r\n    if (!collection) {\r\n        return null;\r\n    }\r\n    var dataModels = mapItems(value, function (id) { return id ? collection.find(refOptions.model, id) : id; });\r\n    if (refOptions.type === ReferenceType.TO_MANY && !(dataModels instanceof Array)) {\r\n        dataModels = [dataModels];\r\n    }\r\n    if (dataModels instanceof Array) {\r\n        var data = observable.array(dataModels, { deep: false });\r\n        intercept(data, function (change) { return partialRefUpdate(model, key, change); });\r\n        return data;\r\n    }\r\n    return dataModels;\r\n}\r\nexport function getRef(model, key) {\r\n    var refOptions = storage.getModelReferenceOptions(model, key);\r\n    return (typeof refOptions.property === 'string')\r\n        ? getBackRef(model, key, refOptions)\r\n        : getNormalRef(model, key, refOptions);\r\n}\r\nfunction validateRef(refOptions, isArray, key) {\r\n    if (refOptions.type === ReferenceType.TO_ONE && isArray) {\r\n        throw error(REF_SINGLE, { key: key });\r\n    }\r\n    else if (refOptions.type === ReferenceType.TO_MANY && !isArray) {\r\n        throw error(REF_ARRAY, { key: key });\r\n    }\r\n    else if (refOptions.property) {\r\n        throw error(BACK_REF_READ_ONLY);\r\n    }\r\n}\r\nexport function updateRef(model, key, value) {\r\n    var refOptions = storage.getModelReferenceOptions(model, key);\r\n    var oldIds = refOptions.type === ReferenceType.TO_MANY\r\n        ? (mapItems(value, getModelId) || [])\r\n        : mapItems(value, getModelId);\r\n    var check = refOptions.type === ReferenceType.TO_MANY ? value || [] : value;\r\n    var isArray = check instanceof Array || isObservableArray(check);\r\n    validateRef(refOptions, isArray, key);\r\n    var collection = getModelCollection(model);\r\n    var ids = mapItems(value, function (ref) {\r\n        if (ref && collection) {\r\n            if (ref instanceof PureModel) {\r\n                var refType = getModelType(ref);\r\n                if (refType !== getModelType(refOptions.model)) {\r\n                    throw new Error(WRONG_REF_TYPE);\r\n                }\r\n            }\r\n            var instance = collection.find(refOptions.model, ref);\r\n            if (!instance && typeof ref === 'object') {\r\n                instance = collection.add(ref, refOptions.model);\r\n            }\r\n            return getModelId(instance || ref);\r\n        }\r\n        else if (ref instanceof PureModel) {\r\n            throw error(REF_NEEDS_COLLECTION);\r\n        }\r\n        return ref;\r\n    });\r\n    if (refOptions.type === ReferenceType.TO_MANY) {\r\n        ids = ids || [];\r\n    }\r\n    if (!ids || (ids instanceof Array && ids.length === 0)) {\r\n        storage.setModelDataKey(model, key, ids);\r\n    }\r\n    else {\r\n        storage.setModelDataKey(model, key, ids);\r\n    }\r\n}\r\nfunction getModelRefsByType(model, type) {\r\n    var refs = getModelMetaKey(model, 'refs');\r\n    return Object.keys(refs)\r\n        .filter(function (key) { return !refs[key].property; })\r\n        .filter(function (key) { return getModelType(refs[key].model) === type; });\r\n}\r\nfunction updateModelReferences(model, newId, oldId, type) {\r\n    var collection = getModelCollection(model);\r\n    if (collection) {\r\n        var allModels = collection.getAllModels().map(function (item) {\r\n            getModelRefsByType(item, type).forEach(function (ref) {\r\n                var data = storage.getModelDataKey(item, ref);\r\n                if (data instanceof Array || isObservableArray(data)) {\r\n                    var targetIndex = data.indexOf(oldId);\r\n                    if (targetIndex !== -1) {\r\n                        data[targetIndex] = newId;\r\n                    }\r\n                }\r\n                else if (data === oldId) {\r\n                    storage.setModelDataKey(item, ref, newId);\r\n                }\r\n            });\r\n        });\r\n    }\r\n}\r\n/**\r\n * Updates the model identifier and all the existing references to the model\r\n *\r\n * @export\r\n * @param {PureModel} model Model to be updated\r\n * @param {IIdentifier} newId New model identifier\r\n */\r\nexport function updateModelId(model, newId) {\r\n    var collection = getModelCollection(model);\r\n    var oldId = getModelId(model);\r\n    var type = getModelType(model);\r\n    setModelMetaKey(model, 'id', newId);\r\n    var staticModel = model.constructor;\r\n    var modelId = storage.getModelClassMetaKey(staticModel, 'id');\r\n    if (modelId) {\r\n        setRefId(model, modelId, newId);\r\n    }\r\n    if (collection) {\r\n        // @ts-ignore - I'm bad and I should feel bad...\r\n        collection.__changeModelId(oldId, newId, type);\r\n    }\r\n    updateModelReferences(model, newId, oldId, type);\r\n}\r\n/**\r\n * Get the id of the referenced model\r\n *\r\n * @export\r\n * @param {PureModel} model Source model\r\n * @param {string} key Referenced model property name\r\n * @returns {IIdentifier} Referenced model id\r\n */\r\nexport function getRefId(model, key) {\r\n    return storage.getModelDataKey(model, key);\r\n}\r\n/**\r\n * Set the id of the referenced model\r\n *\r\n * @export\r\n * @param {PureModel} model Source model\r\n * @param {string} key Referenced model property name\r\n * @param {IIdentifier} value The new value\r\n * @returns {IIdentifier} Referenced model id\r\n */\r\nexport function setRefId(model, key, value) {\r\n    return storage.setModelDataKey(model, key, value);\r\n}\r\n//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmllbGRzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2hlbHBlcnMvbW9kZWwvZmllbGRzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxRQUFRLEVBQUUsSUFBSSxFQUFDLE1BQU0sWUFBWSxDQUFDO0FBQzFDLE9BQU8sRUFBNkIsU0FBUyxFQUFvQixpQkFBaUIsRUFBRSxVQUFVLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFFNUcsT0FBTyxFQUFDLFNBQVMsRUFBQyxNQUFNLHVCQUF1QixDQUFDO0FBQ2hELE9BQU8sRUFBQyxhQUFhLEVBQUMsTUFBTSwyQkFBMkIsQ0FBQztBQUN4RCxPQUFPLEVBQ0wsa0JBQWtCLEVBQ2xCLFdBQVcsRUFDWCxTQUFTLEVBQ1Qsb0JBQW9CLEVBQ3BCLFVBQVUsRUFDVixhQUFhLEVBQ2IsY0FBYyxHQUNmLE1BQU0sY0FBYyxDQUFDO0FBT3RCLE9BQU8sRUFBQyxTQUFTLEVBQUMsTUFBTSxpQkFBaUIsQ0FBQztBQUMxQyxPQUFPLEVBQUMsT0FBTyxFQUFDLE1BQU0sd0JBQXdCLENBQUM7QUFDL0MsT0FBTyxFQUFDLEtBQUssRUFBQyxNQUFNLFdBQVcsQ0FBQztBQUNoQyxPQUFPLEVBQUMsa0JBQWtCLEVBQUUsVUFBVSxFQUFFLGVBQWUsRUFBRSxZQUFZLEVBQUUsZUFBZSxFQUFDLE1BQU0sU0FBUyxDQUFDO0FBRXZHLDJCQUEyQixLQUFnQixFQUFFLEdBQVcsRUFBRSxZQUF1QjtJQUMvRSxJQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsd0JBQXdCLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ2hFLElBQU0sUUFBUSxHQUFHLFVBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUMxQyxJQUFNLElBQUksR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztJQUNqRCxJQUFJLFVBQVUsQ0FBQyxJQUFJLEtBQUssYUFBYSxDQUFDLE1B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SUFBSSxDQUFDLENBQUM7S0FDaEQ7SUFFRCxxQkFBcUIsQ0FBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztBQUNuRCxDQUFDO0FBRUQ7Ozs7Ozs7R0FPRztBQUNILE1BQU0sbUJBQW1CLEtBQWdCLEVBQUUsR0FBVztJQUNwRCxPQUFPLE9BQU8sQ0FBQyxlQUFlLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBQzdDLENBQUM7QUFFRDs7Ozs7Ozs7R0FRRztBQUNILE1BQU0sbUJBQW1CLEtBQWdCLEVBQUUsR0FBVyxFQUFFLEtBQXFDO0lBQzNGLE9BQU8sT0FBTyxDQUFDLGVBQWUsQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO0FBQ3BELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge21hcEl0ZW1zLCB3YXJufSBmcm9tICdkYXR4LXV0aWxzJztcbmltcG9ydCB7SUFycmF5Q2hhbmdlLCBJQXJyYXlTcGxpY2UsIGludGVyY2VwdCwgSU9ic2VydmFibGVBcnJheSwgaXNPYnNlcnZhYmxlQXJyYXksIG9ic2VydmFibGV9IGZyb20gJ21vYngnO1xuXG5pbXBvcnQge0ZpZWxkVHlwZX0gZnJvbSAnLi4vLi4vZW51bXMvRmllbGRUeXBlJztcbmltcG9ydCB7UmVmZXJlbmNlVHlwZX0gZnJvbSAnLi4vLi4vZW51bXMvUmVmZXJlbmNlVHlwZSc7XG5pbXBvcnQge1xuICBCQUNLX1JFRl9SRUFEX09OTFksXG4gIElEX1JFQURPTkxZLFxuICBSRUZfQVJSQVksXG4gIFJFRl9ORUVEU19DT0xMRUNUSU9OLFxuICBSRUZfU0lOR0xFLFxuICBUWVBFX1JFQURPTkxZLFxuICBXUk9OR19SRUZfVFlQRSxcbn0gZnJvbSAnLi4vLi4vZXJyb3JzJztcbmltcG9ydCB7SUlkZW50aWZpZXJ9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvSUlkZW50aWZpZXInO1xuaW1wb3J0IHtJUmVmZXJlbmNlT3B0aW9uc30gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9JUmVmZXJlbmNlT3B0aW9ucyc7XG5pbXBvcnQge0lUeXBlfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL0lUeXBlJztcbmltcG9ydCB7VENoYW5nZX0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9UQ2hhbmdlJztcbmltcG9ydCB7VFJlZlZhbHVlfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL1RSZWZWYWx1ZSc7XG5pbXBvcnQge1B1cmVDb2xsZWN0aW9ufSBmcm9tICcuLi8uLi9QdXJlQ29sbGVjdGlvbic7XG5pbXBvcnQge1B1cmVNb2RlbH0gZnJvbSAnLi4vLi4vUHVyZU1vZGVsJztcbmltcG9ydCB7c3RvcmFnZX0gZnJvbSAnLi4vLi4vc2VydmljZXMvc3RvcmFnZSc7XG5pbXBvcnQge2Vycm9yfSBmcm9tICcuLi9mb3JtYXQnO1xuaW1wb3J0IHtnZXRNb2RlbENvbGxlY3Rpb24sIGdldE1vZGVsSWQsIGdldE1vZGVsTWV0YUtleSwgZ2V0TW9kZWxUeXBlLCBzZXRNb2RlbE1ldGFLZXl9IGZyb20gJy4vdXRpbHMnO1xuXG5mdW5jdGlvbiBtb2RlbEFkZFJlZmVyZW5jZShtb2RlbDogUHVyZU1vZGVsLCBrZXk6IHN0cmluZywgbmV3UmVmZXJlbmNlOiBQdXJlTW9kZWwpIHtcbiAgY29uc3QgcmVmT3B0aW9ucyA9IHN0b3JhZ2UuZ2V0TW9kZWxSZWZlcmVuY2VPcHRpb25zKG1vZGVsLCBrZXkpO1xuICBjb25zdCBuZXdSZWZJZCA9IGdldE1vZGVsSWQobmV3UmVmZXJlbmNlKTtcbiAgY29uc3QgZGF0YSA9IHN0b3JhZ2UuZ2V0TW9kZWxEYXRhS2V5KG1vZGVsLCBrZXkpO1xuICBpZiAocmVmT3B0aW9ucy50eXBlID09PSBSZWZlcmVuY2VUeXBlLlRPX09ORSkge1xuICAgIHN0b3JhZ2Uuc2V0TW9kZWxEYXRhS2V5KG1vZGVsLCBrZXksIG5ld1JlZklkKTtcbiAgfSBlbHNlIGlmIChyZWZPcHRpb25zLnR5cGUgPT09IFJlZmVyZW5jZVR5cGUuVE9fTUFOWSB8fCBpc09ic2VydmFibGVBcnJheShkYXRhKSkge1xuICAgIGRhdGEucHVzaChuZXdSZWZJZCk7XG4gIH0gZWxzZSB7XG4gICAgc3RvcmFnZS5zZXRNb2RlbERhdGFLZXkobW9kZWwsIGtleSwgbmV3UmVmZXJlbmNlKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBtb2RlbFJlbW92ZVJlZmVyZW5jZShtb2RlbDogUHVyZU1vZGVsLCBrZXk6IHN0cmluZywgb2xkUmVmZXJlbmNlOiBQdXJlTW9kZWwpIHtcbiAgY29uc3QgcmVmT3B0aW9ucyA9IHN0b3JhZ2UuZ2V0TW9kZWxSZWZlcmVuY2VPcHRpb25zKG1vZGVsLCBrZXkpO1xuICBjb25zdCBvbGRSZWZJZCA9IGdldE1vZGVsSWQob2xkUmVmZXJlbmNlKTtcbiAgY29uc3QgZGF0YSA9IHN0b3JhZ2UuZ2V0TW9kZWxEYXRhS2V5KG1vZGVsLCBrZXkpO1xuICBpZiAocmVmT3B0aW9ucy50eXBlID09PSBSZWZlcmVuY2VUeXBlLlRPX09ORSkge1xuICAgIHN0b3JhZ2Uuc2V0TW9kZWxEYXRhS2V5KG1vZGVsLCBrZXksIG51bGwpO1xuICB9IGVsc2UgaWYgKHJlZk9wdGlvbnMudHlwZSA9PT0gUmVmZXJlbmNlVHlwZS5UT19NQU5ZIHx8IGlzT2JzZXJ2YWJsZUFycmF5KGRhdGEpKSB7XG4gICAgZGF0YS5yZW1vdmUob2xkUmVmSWQpO1xuICB9IGVsc2Uge1xuICAgIHN0b3JhZ2Uuc2V0TW9kZWxEYXRhS2V5KG1vZGVsLCBrZXksIG51bGwpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGVuc3VyZU1vZGVsKHJlZk9wdGlvbnM6IElSZWZlcmVuY2VPcHRpb25zLCBjb2xsZWN0aW9uPzogUHVyZUNvbGxlY3Rpb24pIHtcbiAgcmV0dXJuIChkYXRhKSA9PiB7XG4gICAgbGV0IG1vZGVsID0gZGF0YTtcbiAgICBpZiAoIShkYXRhIGluc3RhbmNlb2YgUHVyZU1vZGVsKSAmJiB0eXBlb2YgZGF0YSA9PT0gJ29iamVjdCcpIHtcbiAgICAgIGlmICghY29sbGVjdGlvbikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoUkVGX05FRURTX0NPTExFQ1RJT04pO1xuICAgICAgfVxuICAgICAgbW9kZWwgPSBjb2xsZWN0aW9uLmFkZChkYXRhLCByZWZPcHRpb25zLm1vZGVsKTtcbiAgICB9XG4gICAgcmV0dXJuIGdldE1vZGVsSWQobW9kZWwpO1xuICB9O1xufVxuXG5mdW5jdGlvbiBwYXJ0aWFsUmVmVXBkYXRlKG1vZGVsOiBQdXJlTW9kZWwsIGtleTogc3RyaW5nLCBjaGFuZ2U6IFRDaGFuZ2UpIHtcbiAgY29uc3QgcmVmT3B0aW9ucyA9IHN0b3JhZ2UuZ2V0TW9kZWxSZWZlcmVuY2VPcHRpb25zKG1vZGVsLCBrZXkpO1xuICBjb25zdCBkYXRhID0gc3RvcmFnZS5nZXRNb2RlbERhdGFLZXkobW9kZWwsIGtleSk7XG4gIGNvbnN0IGNvbGxlY3Rpb24gPSBnZXRNb2RlbENvbGxlY3Rpb24obW9kZWwpO1xuXG4gIGlmIChjaGFuZ2UudHlwZSA9PT0gJ3NwbGljZScpIHtcbiAgICBjb25zdCBhZGRlZCA9IGNoYW5nZS5hZGRlZC5tYXAoZW5zdXJlTW9kZWwocmVmT3B0aW9ucywgY29sbGVjdGlvbikpO1xuICAgIGRhdGEuc3BsaWNlKGNoYW5nZS5pbmRleCwgY2hhbmdlLnJlbW92ZWRDb3VudCwgLi4uYWRkZWQpO1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgZGF0YVtjaGFuZ2UuaW5kZXhdID0gZW5zdXJlTW9kZWwocmVmT3B0aW9ucywgY29sbGVjdGlvbikoY2hhbmdlLm5ld1ZhbHVlKTtcbiAgcmV0dXJuIG51bGw7XG59XG5cbmZ1bmN0aW9uIGJhY2tSZWZTcGxpY2UobW9kZWw6IFB1cmVNb2RlbCwga2V5OiBzdHJpbmcsIGNoYW5nZTogSUFycmF5U3BsaWNlPFB1cmVNb2RlbD4sIHJlZk9wdGlvbnM6IElSZWZlcmVuY2VPcHRpb25zKSB7XG4gIGNvbnN0IHByb3BlcnR5ID0gcmVmT3B0aW9ucy5wcm9wZXJ0eSBhcyBzdHJpbmc7XG4gIGNoYW5nZS5hZGRlZC5tYXAoKGl0ZW0pID0+IG1vZGVsQWRkUmVmZXJlbmNlKGl0ZW0sIHByb3BlcnR5LCBtb2RlbCkpO1xuICBjb25zdCByZW1vdmVkID0gbW9kZWxba2V5XS5zbGljZShjaGFuZ2UuaW5kZXgsIGNoYW5nZS5pbmRleCArIGNoYW5nZS5yZW1vdmVkQ291bnQpO1xuICByZW1vdmVkLm1hcCgoaXRlbSkgPT4gbW9kZWxSZW1vdmVSZWZlcmVuY2UoaXRlbSwgcHJvcGVydHksIG1vZGVsKSk7XG4gIHJldHVybiBudWxsO1xufVxuXG5mdW5jdGlvbiBiYWNrUmVmQ2hhbmdlKG1vZGVsOiBQdXJlTW9kZWwsIGtleTogc3RyaW5nLCBjaGFuZ2U6IElBcnJheUNoYW5nZTxQdXJlTW9kZWw+LCByZWZPcHRpb25zOiBJUmVmZXJlbmNlT3B0aW9ucykge1xuICBjb25zdCBwcm9wZXJ0eSA9IHJlZk9wdGlvbnMucHJvcGVydHkgYXMgc3RyaW5nO1xuICBjb25zdCBvbGRWYWx1ZSA9IG1vZGVsW2tleV0ubGVuZ3RoID4gY2hhbmdlLmluZGV4ID8gbW9kZWxba2V5XVtjaGFuZ2UuaW5kZXhdIDogbnVsbDtcbiAgaWYgKGNoYW5nZS5uZXdWYWx1ZSkge1xuICAgIG1vZGVsQWRkUmVmZXJlbmNlKGNoYW5nZS5uZXdWYWx1ZSwgcHJvcGVydHksIG1vZGVsKTtcbiAgfVxuICBpZiAob2xkVmFsdWUpIHtcbiAgICBtb2RlbFJlbW92ZVJlZmVyZW5jZShvbGRWYWx1ZSwgcHJvcGVydHksIG1vZGVsKTtcbiAgfVxuXG4gIHdhcm4oYFRoaXMgc2hvdWxkbid0IGhhdmUgaGFwcGVuZWQuIFBsZWFzZSBvcGVuIGFuIGlzc3VlOiBodHRwczovL2dpdGh1Yi5jb20vaW5maW51bS9kYXR4L2lzc3Vlcy9uZXdgKTtcbiAgcmV0dXJuIG51bGw7XG59XG5cbmZ1bmN0aW9uIHBhcnRpYWxCYWNrUmVmVXBkYXRlKG1vZGVsOiBQdXJlTW9kZWwsIGtleTogc3RyaW5nLCBjaGFuZ2U6IFRDaGFuZ2UpIHtcbiAgY29uc3QgcmVmT3B0aW9ucyA9IHN0b3JhZ2UuZ2V0TW9kZWxSZWZlcmVuY2VPcHRpb25zKG1vZGVsLCBrZXkpO1xuXG4gIGlmIChjaGFuZ2UudHlwZSA9PT0gJ3NwbGljZScpIHtcbiAgICByZXR1cm4gYmFja1JlZlNwbGljZShtb2RlbCwga2V5LCBjaGFuZ2UsIHJlZk9wdGlvbnMpO1xuICB9XG4gIHJldHVybiBiYWNrUmVmQ2hhbmdlKG1vZGVsLCBrZXksIGNoYW5nZSwgcmVmT3B0aW9ucyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRGaWVsZChtb2RlbDogUHVyZU1vZGVsLCBrZXk6IHN0cmluZykge1xuICByZXR1cm4gc3RvcmFnZS5nZXRNb2RlbERhdGFLZXkobW9kZWwsIGtleSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB1cGRhdGVGaWVsZChtb2RlbDogUHVyZU1vZGVsLCBrZXk6IHN0cmluZywgdmFsdWU6IGFueSwgdHlwZTogRmllbGRUeXBlKSB7XG4gIGlmICh0eXBlID09PSBGaWVsZFR5cGUuVFlQRSkge1xuICAgIHRocm93IGVycm9yKFRZUEVfUkVBRE9OTFkpO1xuICB9IGVsc2UgaWYgKHR5cGUgPT09IEZpZWxkVHlwZS5JRCkge1xuICAgIHRocm93IGVycm9yKElEX1JFQURPTkxZKTtcbiAgfVxuXG4gIGNvbnN0IHJlZnMgPSBnZXRNb2RlbE1ldGFLZXkobW9kZWwsICdyZWZzJyk7XG4gIGlmIChrZXkgaW4gcmVmcykge1xuICAgIHVwZGF0ZVJlZihtb2RlbCwga2V5LCB2YWx1ZSk7XG4gIH0gZWxzZSB7XG4gICAgc3RvcmFnZS5zZXRNb2RlbERhdGFLZXkobW9kZWwsIGtleSwgdmFsdWUpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGhhc0JhY2tSZWYoaXRlbTogUHVyZU1vZGVsLCBwcm9wZXJ0eTogc3RyaW5nLCB0YXJnZXQ6IFB1cmVNb2RlbCk6IGJvb2xlYW4ge1xuICBpZiAoaXRlbVtwcm9wZXJ0eV0gPT09IG51bGwgfHwgaXRlbVtwcm9wZXJ0eV0gPT09IHVuZGVmaW5lZCkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfSBlbHNlIGlmIChpdGVtW3Byb3BlcnR5XSBpbnN0YW5jZW9mIFB1cmVNb2RlbCkge1xuICAgIHJldHVybiBpdGVtW3Byb3BlcnR5XSA9PT0gdGFyZ2V0O1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBpdGVtW3Byb3BlcnR5XS5pbmRleE9mKHRhcmdldCkgIT09IC0xO1xuICB9XG59XG5cbmZ1bmN0aW9uIGdldEJhY2tSZWYobW9kZWw6IFB1cmVNb2RlbCwga2V5OiBzdHJpbmcsIHJlZk9wdGlvbnM6IElSZWZlcmVuY2VPcHRpb25zKTogUHVyZU1vZGVsfEFycmF5PFB1cmVNb2RlbD58bnVsbCB7XG4gIGNvbnN0IHR5cGUgPSBnZXRNb2RlbFR5cGUocmVmT3B0aW9ucy5tb2RlbCk7XG5cbiAgY29uc3QgY29sbGVjdGlvbiA9IGdldE1vZGVsQ29sbGVjdGlvbihtb2RlbCk7XG4gIGlmICghY29sbGVjdGlvbikge1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgY29uc3QgYmFja01vZGVscyA9IGNvbGxlY3Rpb25cbiAgICAuZmluZEFsbCh0eXBlKVxuICAgIC5maWx0ZXIoKGl0ZW0pID0+IGhhc0JhY2tSZWYoaXRlbSwgcmVmT3B0aW9ucy5wcm9wZXJ0eSBhcyBzdHJpbmcsIG1vZGVsKSk7XG5cbiAgY29uc3QgYmFja0RhdGE6IElPYnNlcnZhYmxlQXJyYXk8UHVyZU1vZGVsPiA9IG9ic2VydmFibGUuYXJyYXkoYmFja01vZGVscywge2RlZXA6IGZhbHNlfSk7XG4gIGludGVyY2VwdChiYWNrRGF0YSwgKGNoYW5nZTogVENoYW5nZSkgPT4gcGFydGlhbEJhY2tSZWZVcGRhdGUobW9kZWwsIGtleSwgY2hhbmdlKSk7XG4gIHJldHVybiBiYWNrRGF0YTtcbn1cblxuZnVuY3Rpb24gZ2V0Tm9ybWFsUmVmKG1vZGVsOiBQdXJlTW9kZWwsIGtleTogc3RyaW5nLCByZWZPcHRpb25zOiBJUmVmZXJlbmNlT3B0aW9ucyk6IFB1cmVNb2RlbHxBcnJheTxQdXJlTW9kZWw+fG51bGwge1xuICBjb25zdCB2YWx1ZSA9IHN0b3JhZ2UuZ2V0TW9kZWxEYXRhS2V5KG1vZGVsLCBrZXkpO1xuICBjb25zdCBjb2xsZWN0aW9uID0gZ2V0TW9kZWxDb2xsZWN0aW9uKG1vZGVsKTtcbiAgaWYgKCFjb2xsZWN0aW9uKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBsZXQgZGF0YU1vZGVscyA9IG1hcEl0ZW1zKHZhbHVlLCAoaWQpID0+IGlkID8gY29sbGVjdGlvbi5maW5kKHJlZk9wdGlvbnMubW9kZWwsIGlkKSA6IGlkKTtcbiAgaWYgKHJlZk9wdGlvbnMudHlwZSA9PT0gUmVmZXJlbmNlVHlwZS5UT19NQU5ZICYmICEoZGF0YU1vZGVscyBpbnN0YW5jZW9mIEFycmF5KSkge1xuICAgIGRhdGFNb2RlbHMgPSBbZGF0YU1vZGVsc107XG4gIH1cbiAgaWYgKGRhdGFNb2RlbHMgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgIGNvbnN0IGRhdGE6IElPYnNlcnZhYmxlQXJyYXk8UHVyZU1vZGVsPiA9IG9ic2VydmFibGUuYXJyYXkoZGF0YU1vZGVscywge2RlZXA6IGZhbHNlfSk7XG4gICAgaW50ZXJjZXB0KGRhdGEsIChjaGFuZ2U6IFRDaGFuZ2UpID0+IHBhcnRpYWxSZWZVcGRhdGUobW9kZWwsIGtleSwgY2hhbmdlKSk7XG4gICAgcmV0dXJuIGRhdGE7XG4gIH1cbiAgcmV0dXJuIGRhdGFNb2RlbHM7XG5cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFJlZihtb2RlbDogUHVyZU1vZGVsLCBrZXk6IHN0cmluZyk6IFB1cmVNb2RlbHxBcnJheTxQdXJlTW9kZWw+fG51bGwge1xuICBjb25zdCByZWZPcHRpb25zID0gc3RvcmFnZS5nZXRNb2RlbFJlZmVyZW5jZU9wdGlvbnMobW9kZWwsIGtleSk7XG5cbiAgcmV0dXJuICh0eXBlb2YgcmVmT3B0aW9ucy5wcm9wZXJ0eSA9PT0gJ3N0cmluZycpXG4gICAgPyBnZXRCYWNrUmVmKG1vZGVsLCBrZXksIHJlZk9wdGlvbnMpXG4gICAgOiBnZXROb3JtYWxSZWYobW9kZWwsIGtleSwgcmVmT3B0aW9ucyk7XG59XG5cbmZ1bmN0aW9uIHZhbGlkYXRlUmVmKHJlZk9wdGlvbnM6IElSZWZlcmVuY2VPcHRpb25zLCBpc0FycmF5OiBib29sZWFuLCBrZXk6IHN0cmluZykge1xuICBpZiAocmVmT3B0aW9ucy50eXBlID09PSBSZWZlcmVuY2VUeXBlLlRPX09ORSAmJiBpc0FycmF5KSB7XG4gICAgdGhyb3cgZXJyb3IoUkVGX1NJTkdMRSwge2tleX0pO1xuICB9IGVsc2UgaWYgKHJlZk9wdGlvbnMudHlwZSA9PT0gUmVmZXJlbmNlVHlwZS5UT19NQU5ZICYmICFpc0FycmF5KSB7XG4gICAgdGhyb3cgZXJyb3IoUkVGX0FSUkFZLCB7a2V5fSk7XG4gIH0gZWxzZSBpZiAocmVmT3B0aW9ucy5wcm9wZXJ0eSkge1xuICAgIHRocm93IGVycm9yKEJBQ0tfUkVGX1JFQURfT05MWSk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHVwZGF0ZVJlZihtb2RlbDogUHVyZU1vZGVsLCBrZXk6IHN0cmluZywgdmFsdWU6IFRSZWZWYWx1ZSkge1xuICBjb25zdCByZWZPcHRpb25zID0gc3RvcmFnZS5nZXRNb2RlbFJlZmVyZW5jZU9wdGlvbnMobW9kZWwsIGtleSk7XG4gIGNvbnN0IG9sZElkcyA9IHJlZk9wdGlvbnMudHlwZSA9PT0gUmVmZXJlbmNlVHlwZS5UT19NQU5ZXG4gICAgPyAobWFwSXRlbXModmFsdWUsIGdldE1vZGVsSWQpIHx8IFtdKVxuICAgIDogbWFwSXRlbXModmFsdWUsIGdldE1vZGVsSWQpO1xuXG4gIGNvbnN0IGNoZWNrID0gcmVmT3B0aW9ucy50eXBlID09PSBSZWZlcmVuY2VUeXBlLlRPX01BTlkgPyB2YWx1ZSB8fCBbXSA6IHZhbHVlO1xuICBjb25zdCBpc0FycmF5ID0gY2hlY2sgaW5zdGFuY2VvZiBBcnJheSB8fCBpc09ic2VydmFibGVBcnJheShjaGVjayk7XG4gIHZhbGlkYXRlUmVmKHJlZk9wdGlvbnMsIGlzQXJyYXksIGtleSk7XG5cbiAgY29uc3QgY29sbGVjdGlvbiA9IGdldE1vZGVsQ29sbGVjdGlvbihtb2RlbCk7XG5cbiAgbGV0IGlkczogSUlkZW50aWZpZXJ8QXJyYXk8SUlkZW50aWZpZXI+fG51bGwgPSBtYXBJdGVtcyh2YWx1ZSwgKHJlZjogSUlkZW50aWZpZXJ8UHVyZU1vZGVsKSA9PiB7XG4gICAgaWYgKHJlZiAmJiBjb2xsZWN0aW9uKSB7XG4gICAgICBpZiAocmVmIGluc3RhbmNlb2YgUHVyZU1vZGVsKSB7XG4gICAgICAgIGNvbnN0IHJlZlR5cGUgPSBnZXRNb2RlbFR5cGUocmVmKTtcbiAgICAgICAgaWYgKHJlZlR5cGUgIT09IGdldE1vZGVsVHlwZShyZWZPcHRpb25zLm1vZGVsKSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihXUk9OR19SRUZfVFlQRSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGxldCBpbnN0YW5jZSA9IGNvbGxlY3Rpb24uZmluZChyZWZPcHRpb25zLm1vZGVsLCByZWYpO1xuICAgICAgaWYgKCFpbnN0YW5jZSAmJiB0eXBlb2YgcmVmID09PSAnb2JqZWN0Jykge1xuICAgICAgICBpbnN0YW5jZSA9IGNvbGxlY3Rpb24uYWRkKHJlZiwgcmVmT3B0aW9ucy5tb2RlbCk7XG4gICAgICB9XG4gICAgICByZXR1cm4gZ2V0TW9kZWxJZChpbnN0YW5jZSB8fCByZWYpO1xuICAgIH0gZWxzZSBpZiAocmVmIGluc3RhbmNlb2YgUHVyZU1vZGVsKSB7XG4gICAgICB0aHJvdyBlcnJvcihSRUZfTkVFRFNfQ09MTEVDVElPTik7XG4gICAgfVxuICAgIHJldHVybiByZWY7XG4gIH0pO1xuXG4gIGlmIChyZWZPcHRpb25zLnR5cGUgPT09IFJlZmVyZW5jZVR5cGUuVE9fTUFOWSkge1xuICAgIGlkcyA9IGlkcyB8fCBbXTtcbiAgfVxuXG4gIGlmICghaWRzIHx8IChpZHMgaW5zdGFuY2VvZiBBcnJheSAmJiBpZHMubGVuZ3RoID09PSAwKSkge1xuICAgIHN0b3JhZ2Uuc2V0TW9kZWxEYXRhS2V5KG1vZGVsLCBrZXksIGlkcyk7XG4gIH0gZWxzZSB7XG5cbiAgICBzdG9yYWdlLnNldE1vZGVsRGF0YUtleShtb2RlbCwga2V5LCBpZHMpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGdldE1vZGVsUmVmc0J5VHlwZShtb2RlbDogUHVyZU1vZGVsLCB0eXBlOiBJVHlwZSkge1xuICBjb25zdCByZWZzID0gZ2V0TW9kZWxNZXRhS2V5KG1vZGVsLCAncmVmcycpO1xuICByZXR1cm4gT2JqZWN0LmtleXMocmVmcylcbiAgICAuZmlsdGVyKChrZXkpID0+ICFyZWZzW2tleV0ucHJvcGVydHkpXG4gICAgLmZpbHRlcigoa2V5KSA9PiBnZXRNb2RlbFR5cGUocmVmc1trZXldLm1vZGVsKSA9PT0gdHlwZSk7XG59XG5cbmZ1bmN0aW9uIHVwZGF0ZU1vZGVsUmVmZXJlbmNlcyhtb2RlbDogUHVyZU1vZGVsLCBuZXdJZDogSUlkZW50aWZpZXIsIG9sZElkOiBJSWRlbnRpZmllciwgdHlwZTogSVR5cGUpIHtcbiAgY29uc3QgY29sbGVjdGlvbiA9IGdldE1vZGVsQ29sbGVjdGlvbihtb2RlbCk7XG4gIGlmIChjb2xsZWN0aW9uKSB7XG4gICAgY29uc3QgYWxsTW9kZWxzID0gY29sbGVjdGlvbi5nZXRBbGxNb2RlbHMoKS5tYXAoKGl0ZW0pID0+IHtcbiAgICAgIGdldE1vZGVsUmVmc0J5VHlwZShpdGVtLCB0eXBlKS5mb3JFYWNoKChyZWYpID0+IHtcbiAgICAgICAgY29uc3QgZGF0YSA9IHN0b3JhZ2UuZ2V0TW9kZWxEYXRhS2V5KGl0ZW0sIHJlZik7XG4gICAgICAgIGlmIChkYXRhIGluc3RhbmNlb2YgQXJyYXkgfHwgaXNPYnNlcnZhYmxlQXJyYXkoZGF0YSkpIHtcbiAgICAgICAgICBjb25zdCB0YXJnZXRJbmRleCA9IGRhdGEuaW5kZXhPZihvbGRJZCk7XG4gICAgICAgICAgaWYgKHRhcmdldEluZGV4ICE9PSAtMSkge1xuICAgICAgICAgICAgZGF0YVt0YXJnZXRJbmRleF0gPSBuZXdJZDtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAoZGF0YSA9PT0gb2xkSWQpIHtcbiAgICAgICAgICBzdG9yYWdlLnNldE1vZGVsRGF0YUtleShpdGVtLCByZWYsIG5ld0lkKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cbn1cblxuLyoqXG4gKiBVcGRhdGVzIHRoZSBtb2RlbCBpZGVudGlmaWVyIGFuZCBhbGwgdGhlIGV4aXN0aW5nIHJlZmVyZW5jZXMgdG8gdGhlIG1vZGVsXG4gKlxuICogQGV4cG9ydFxuICogQHBhcmFtIHtQdXJlTW9kZWx9IG1vZGVsIE1vZGVsIHRvIGJlIHVwZGF0ZWRcbiAqIEBwYXJhbSB7SUlkZW50aWZpZXJ9IG5ld0lkIE5ldyBtb2RlbCBpZGVudGlmaWVyXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB1cGRhdGVNb2RlbElkKG1vZGVsOiBQdXJlTW9kZWwsIG5ld0lkOiBJSWRlbnRpZmllcik6IHZvaWQge1xuICBjb25zdCBjb2xsZWN0aW9uID0gZ2V0TW9kZWxDb2xsZWN0aW9uKG1vZGVsKTtcblxuICBjb25zdCBvbGRJZCA9IGdldE1vZGVsSWQobW9kZWwpO1xuICBjb25zdCB0eXBlID0gZ2V0TW9kZWxUeXBlKG1vZGVsKTtcbiAgc2V0TW9kZWxNZXRhS2V5KG1vZGVsLCAnaWQnLCBuZXdJZCk7XG5cbiAgY29uc3Qgc3RhdGljTW9kZWwgPSBtb2RlbC5jb25zdHJ1Y3RvciBhcyB0eXBlb2YgUHVyZU1vZGVsO1xuICBjb25zdCBtb2RlbElkID0gc3RvcmFnZS5nZXRNb2RlbENsYXNzTWV0YUtleShzdGF0aWNNb2RlbCwgJ2lkJyk7XG4gIGlmIChtb2RlbElkKSB7XG4gICAgc2V0UmVmSWQobW9kZWwsIG1vZGVsSWQsIG5ld0lkKTtcbiAgfVxuXG4gIGlmIChjb2xsZWN0aW9uKSB7XG4gICAgLy8gQHRzLWlnbm9yZSAtIEknbSBiYWQgYW5kIEkgc2hvdWxkIGZlZWwgYmFkLi4uXG4gICAgY29sbGVjdGlvbi5fX2NoYW5nZU1vZGVsSWQob2xkSWQsIG5ld0lkLCB0eXBlKTtcbiAgfVxuXG4gIHVwZGF0ZU1vZGVsUmVmZXJlbmNlcyhtb2RlbCwgbmV3SWQsIG9sZElkLCB0eXBlKTtcbn1cblxuLyoqXG4gKiBHZXQgdGhlIGlkIG9mIHRoZSByZWZlcmVuY2VkIG1vZGVsXG4gKlxuICogQGV4cG9ydFxuICogQHBhcmFtIHtQdXJlTW9kZWx9IG1vZGVsIFNvdXJjZSBtb2RlbFxuICogQHBhcmFtIHtzdHJpbmd9IGtleSBSZWZlcmVuY2VkIG1vZGVsIHByb3BlcnR5IG5hbWVcbiAqIEByZXR1cm5zIHtJSWRlbnRpZmllcn0gUmVmZXJlbmNlZCBtb2RlbCBpZFxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0UmVmSWQobW9kZWw6IFB1cmVNb2RlbCwga2V5OiBzdHJpbmcpOiBJSWRlbnRpZmllcnxBcnJheTxJSWRlbnRpZmllcj4ge1xuICByZXR1cm4gc3RvcmFnZS5nZXRNb2RlbERhdGFLZXkobW9kZWwsIGtleSk7XG59XG5cbi8qKlxuICogU2V0IHRoZSBpZCBvZiB0aGUgcmVmZXJlbmNlZCBtb2RlbFxuICpcbiAqIEBleHBvcnRcbiAqIEBwYXJhbSB7UHVyZU1vZGVsfSBtb2RlbCBTb3VyY2UgbW9kZWxcbiAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgUmVmZXJlbmNlZCBtb2RlbCBwcm9wZXJ0eSBuYW1lXG4gKiBAcGFyYW0ge0lJZGVudGlmaWVyfSB2YWx1ZSBUaGUgbmV3IHZhbHVlXG4gKiBAcmV0dXJucyB7SUlkZW50aWZpZXJ9IFJlZmVyZW5jZWQgbW9kZWwgaWRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHNldFJlZklkKG1vZGVsOiBQdXJlTW9kZWwsIGtleTogc3RyaW5nLCB2YWx1ZTogSUlkZW50aWZpZXJ8QXJyYXk8SUlkZW50aWZpZXI+KSB7XG4gIHJldHVybiBzdG9yYWdlLnNldE1vZGVsRGF0YUtleShtb2RlbCwga2V5LCB2YWx1ZSk7XG59XG4iXX0=","map":{"mappings":""},"dts":{"name":"/Users/darko/Projects/mobx/datx/packages/datx/helpers/model/fields.d.ts","text":"import { FieldType } from '../../enums/FieldType';\r\nimport { IIdentifier } from '../../interfaces/IIdentifier';\r\nimport { TRefValue } from '../../interfaces/TRefValue';\r\nimport { PureModel } from '../../PureModel';\r\nexport declare function getField(model: PureModel, key: string): any;\r\nexport declare function updateField(model: PureModel, key: string, value: any, type: FieldType): void;\r\nexport declare function getRef(model: PureModel, key: string): PureModel | Array<PureModel> | null;\r\nexport declare function updateRef(model: PureModel, key: string, value: TRefValue): void;\r\n/**\r\n * Updates the model identifier and all the existing references to the model\r\n *\r\n * @export\r\n * @param {PureModel} model Model to be updated\r\n * @param {IIdentifier} newId New model identifier\r\n */\r\nexport declare function updateModelId(model: PureModel, newId: IIdentifier): void;\r\n/**\r\n * Get the id of the referenced model\r\n *\r\n * @export\r\n * @param {PureModel} model Source model\r\n * @param {string} key Referenced model property name\r\n * @returns {IIdentifier} Referenced model id\r\n */\r\nexport declare function getRefId(model: PureModel, key: string): IIdentifier | Array<IIdentifier>;\r\n/**\r\n * Set the id of the referenced model\r\n *\r\n * @export\r\n * @param {PureModel} model Source model\r\n * @param {string} key Referenced model property name\r\n * @param {IIdentifier} value The new value\r\n * @returns {IIdentifier} Referenced model id\r\n */\r\nexport declare function setRefId(model: PureModel, key: string, value: IIdentifier | Array<IIdentifier>): void;\r\n"}}
